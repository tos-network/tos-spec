# TOS Conformance Testing - Docker Compose Configuration
# Version: 1.0

version: '3.8'

services:
  # Test orchestrator - runs the harness and compares results
  orchestrator:
    build:
      context: ./harness
      dockerfile: Dockerfile
    volumes:
      - ${VECTOR_DIR:-../vectors}:/vectors:ro
      - ${RESULT_DIR:-./results}:/results
    depends_on:
      tos-rust:
        condition: service_healthy
      avatar-c:
        condition: service_healthy
    environment:
      - RUST_ENDPOINT=http://tos-rust:8080
      - C_ENDPOINT=http://avatar-c:8080
      - VECTOR_DIR=/vectors
      - RESULT_DIR=/results
      - LOG_LEVEL=INFO
    command: ["python", "runner.py", "--vectors=/vectors"]

  # TOS Rust reference implementation
  tos-rust:
    build:
      context: ../tos
      dockerfile: Dockerfile
      args:
        - app=tos_daemon
    ports:
      - "8081:8080"
    volumes:
      - tos-rust-state:/state
    environment:
      - CONFORMANCE_MODE=true
      - STATE_DIR=/state
      - LOG_LEVEL=INFO
    command: ["--conformance-mode", "--state-dir=/state", "--port=8080"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s

  # Avatar C implementation
  avatar-c:
    build:
      context: ../avatar
      dockerfile: Dockerfile
    ports:
      - "8082:8080"
    volumes:
      - avatar-c-state:/state
    environment:
      - STATE_DIR=/state
      - AVATAR_PORT=8080
      - AVATAR_NETWORK=devnet
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s

volumes:
  tos-rust-state:
  avatar-c-state:

networks:
  default:
    name: tos-conformance
