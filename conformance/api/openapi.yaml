# TOS Conformance API Specification
# OpenAPI 3.0

openapi: 3.0.3
info:
  title: TOS Conformance API
  description: |
    API specification for TOS client conformance testing.
    Each client implementation must expose these endpoints for differential testing.
  version: 1.0.0
  contact:
    name: TOS Development Team

servers:
  - url: http://localhost:8080
    description: Local development server

paths:
  /health:
    get:
      summary: Health check
      description: Check if the conformance server is running
      operationId: healthCheck
      responses:
        '200':
          description: Server is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [healthy]
                  version:
                    type: string

  /state/reset:
    post:
      summary: Reset to genesis state
      description: Reset the client state to initial genesis state
      operationId: resetState
      responses:
        '200':
          description: State reset successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'

  /state/load:
    post:
      summary: Load state from JSON
      description: Load a specific state configuration
      operationId: loadState
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StateLoadRequest'
      responses:
        '200':
          description: State loaded successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StateLoadResponse'

  /state/digest:
    get:
      summary: Get current state digest
      description: Get the SHA3-256 digest of the current state
      operationId: getStateDigest
      responses:
        '200':
          description: State digest
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StateDigestResponse'

  /state/account/{address}:
    get:
      summary: Get account state
      description: Get the state of a specific account
      operationId: getAccountState
      parameters:
        - name: address
          in: path
          required: true
          schema:
            type: string
            pattern: '^(tos1|tst1)[a-z0-9]{58}$'
          description: Account address in Bech32 format (tos1.../tst1...)
      responses:
        '200':
          description: Account state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccountState'
        '404':
          description: Account not found

  /tx/execute:
    post:
      summary: Execute single transaction
      description: Execute a single transaction and return the result
      operationId: executeTransaction
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TxExecuteRequest'
      responses:
        '200':
          description: Transaction execution result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TxExecuteResponse'

  /block/execute:
    post:
      summary: Execute block of transactions
      description: Execute a block containing multiple transactions
      operationId: executeBlock
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BlockExecuteRequest'
      responses:
        '200':
          description: Block execution result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BlockExecuteResponse'

components:
  schemas:
    SuccessResponse:
      type: object
      properties:
        success:
          type: boolean

    StateLoadRequest:
      type: object
      properties:
        accounts:
          type: array
          items:
            $ref: '#/components/schemas/AccountState'
        global:
          $ref: '#/components/schemas/GlobalState'

    StateLoadResponse:
      type: object
      properties:
        success:
          type: boolean
        state_digest:
          type: string
          description: BLAKE3 digest of loaded state (hex)

    StateDigestResponse:
      type: object
      properties:
        state_digest:
          type: string
          description: BLAKE3 digest of current state (hex)

    AccountState:
      type: object
      properties:
        address:
          type: string
          description: Account address in Bech32 format (tos1.../tst1...)
        balance:
          type: integer
          format: int64
          description: Liquid balance
        nonce:
          type: integer
          format: int64
          description: Transaction counter
        frozen:
          type: integer
          format: int64
          description: Frozen (staked) balance
        energy:
          type: integer
          format: int64
          description: Available energy
        flags:
          type: integer
          format: int32
          description: Account flags

    GlobalState:
      type: object
      properties:
        total_supply:
          type: string
          description: Total token supply (u128 as string)
        total_burned:
          type: string
          description: Total tokens burned (u128 as string)
        total_energy:
          type: string
          description: Total network energy (u128 as string)
        block_height:
          type: integer
          format: int64

    TxExecuteRequest:
      type: object
      required:
        - wire_hex
      properties:
        wire_hex:
          type: string
          description: Transaction wire format (hex encoded)

    TxExecuteResponse:
      type: object
      properties:
        success:
          type: boolean
          description: Whether transaction succeeded
        error_code:
          type: integer
          description: Error code (0 = success)
        state_digest:
          type: string
          description: State digest after execution (hex)
        compute_units:
          type: integer
          format: int64
          description: Compute units consumed

    BlockExecuteRequest:
      type: object
      properties:
        height:
          type: integer
          format: int64
        parent_hashes:
          type: array
          items:
            type: string
        timestamp:
          type: integer
          format: int64
        transactions:
          type: array
          items:
            type: object
            properties:
              wire_hex:
                type: string

    BlockExecuteResponse:
      type: object
      properties:
        success:
          type: boolean
        transaction_results:
          type: array
          items:
            $ref: '#/components/schemas/TxExecuteResponse'
        execution_order:
          type: array
          items:
            type: string
          description: Transaction IDs in execution order
        state_digest:
          type: string
          description: Final state digest (hex)
