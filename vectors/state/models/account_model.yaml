# TOS Account Model Conformance Specifications
# Based on: common/src/account/*.rs
#
# Defines account structure and state validation rules

---
spec:
  name: account_model_basic_structure
  version: "1.0"
  category: models
  subcategory: account
  description: "Basic account structure with balance and nonce"
  priority: P0

definition:
  account:
    public_key:
      type: CompressedPublicKey
      size: 32
      description: "Ristretto255 compressed point"
    versioned_balance:
      version:
        type: u64
        description: "TopoHeight of last modification"
      balance:
        type: "Map<Hash, u64>"
        description: "Asset hash to atomic units"
    versioned_nonce:
      version:
        type: u64
        description: "TopoHeight of last modification"
      nonce:
        type: u64
        description: "Transaction counter"

---
spec:
  name: account_model_new_account
  version: "1.0"
  category: models
  subcategory: account
  description: "New account creation on first incoming transfer"
  priority: P0

preconditions:
  - account:
      address: "tos1newaccount..."
      exists: false

action:
  type: receive_transfer
  amount: 100000000  # 1 TOS

expected:
  status: success

postconditions:
  - account:
      address: "tos1newaccount..."
      exists: true
      balance: 100000000
      nonce: 0

---
spec:
  name: account_model_balance_invariant
  version: "1.0"
  category: models
  subcategory: account
  description: "Balance must never be negative"
  priority: P0

invariants:
  - "balance[asset] >= 0 for all assets"
  - "balance[asset] <= u64::MAX for all assets"
  - "nonce <= u64::MAX"

---
spec:
  name: account_model_native_asset
  version: "1.0"
  category: models
  subcategory: account
  description: "Native TOS asset identification"
  priority: P0

definition:
  TOS_ASSET:
    type: Hash
    value: "0x0000000000000000000000000000000000000000000000000000000000000000"
    description: "32 zero bytes identifies native TOS"

---
spec:
  name: account_model_uno_asset
  version: "1.0"
  category: models
  subcategory: account
  description: "UNO privacy asset identification"
  priority: P0

definition:
  UNO_ASSET:
    type: Hash
    value: "0x0000000000000000000000000000000000000000000000000000000000000001"
    description: "31 zero bytes + 0x01 identifies UNO"

---
spec:
  name: account_model_multisig_structure
  version: "1.0"
  category: models
  subcategory: account
  description: "Multi-signature account structure"
  priority: P1

definition:
  multisig_account:
    threshold:
      type: u8
      range: "1..=participants.len()"
      description: "Required signatures (M)"
    participants:
      type: "Vec<PublicKey>"
      max_length: 255
      description: "Authorized signers (N)"

constraints:
  - "threshold >= 1"
  - "threshold <= participants.len()"
  - "participants.len() <= MAX_MULTISIG_PARTICIPANTS (255)"
  - "no duplicate participants"

---
spec:
  name: account_model_agent_account_structure
  version: "1.0"
  category: models
  subcategory: account
  description: "Agent account (delegated session) structure"
  priority: P2

definition:
  agent_account:
    parent:
      type: PublicKey
      size: 32
      description: "Parent account with full control"
    session_key:
      type: PublicKey
      size: 32
      description: "Temporary session key"
    permissions:
      type: u64
      description: "Bitmask of allowed operations"
    expiry:
      type: u64
      description: "Session expiry topoheight"

---
spec:
  name: account_model_versioning_update
  version: "1.0"
  category: models
  subcategory: account
  description: "Version updates on state modification"
  priority: P0

preconditions:
  - account:
      address: "tos1sender..."
      balance_version: 100
      nonce_version: 100
  - current_topoheight: 150

action:
  type: transaction
  tx_type: Transfer
  params:
    amount: 10000000

expected:
  status: success

postconditions:
  - account:
      address: "tos1sender..."
      balance_version: 150
      nonce_version: 150

---
spec:
  name: account_model_activation_status
  version: "1.0"
  category: models
  subcategory: account
  description: "Account activation requires sending a transaction"
  priority: P1

definition:
  account_active:
    condition: "nonce > 0"
    description: "Account has sent at least one transaction"

use_cases:
  - "Active accounts can receive energy delegation"
  - "Active accounts can participate in multi-sig"
  - "Active accounts can create agent sessions"
