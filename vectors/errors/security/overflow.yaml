# TOS Arithmetic Overflow Protection Conformance Specifications
# Based on: common/src/config.rs, daemon/src/core/
#
# TOS uses checked/saturating arithmetic in Rust
# Error: BalanceOverflow when u64 balance would overflow
# Error: Overflow for general arithmetic overflow

---
spec:
  name: security_overflow_balance_add
  version: "1.0"
  category: security
  subcategory: arithmetic
  description: "Balance overflow (u64::MAX + 1) is prevented"
  priority: P0

preconditions:
  - account:
      address: "tos1alice..."
      balance: 18446744073709551615  # u64::MAX

action:
  type: receive_transfer
  to: "tos1alice..."
  amount: 1

expected:
  status: error
  error: "BalanceOverflow"
  error_message: "Balance overflow (> u64::MAX)"

postconditions:
  - account:
      address: "tos1alice..."
      balance: 18446744073709551615  # Unchanged

---
spec:
  name: security_underflow_balance_sub
  version: "1.0"
  category: security
  subcategory: arithmetic
  description: "Balance underflow (0 - 1) is prevented"
  priority: P0

preconditions:
  - account:
      address: "tos1alice..."
      balance: 0

action:
  type: transfer
  from: "tos1alice..."
  to: "tos1bob..."
  amount: 1

expected:
  status: error
  error: "NoBalance"
  error_message: "No balance found for address"

postconditions:
  - account:
      address: "tos1alice..."
      balance: 0  # Unchanged (not wrapped to MAX)

---
spec:
  name: security_overflow_fee_calculation
  version: "1.0"
  category: security
  subcategory: arithmetic
  description: "Fee calculation uses checked arithmetic"
  priority: P0

preconditions:
  - FEE_PER_KB: 10000
  - transaction_size: 18446744073709551  # Would overflow when multiplied

action:
  type: calculate_fee
  size_bytes: 18446744073709551

expected:
  status: error
  error: "Overflow"
  error_message: "Overflow detected"

---
spec:
  name: security_overflow_energy_calculation
  version: "1.0"
  category: security
  subcategory: arithmetic
  description: "Energy calculation uses saturating arithmetic"
  priority: P1

preconditions:
  - account_frozen_balance: 18446744073709551615  # u64::MAX
  - freeze_days: 365

action:
  type: calculate_energy
  frozen_amount: 18446744073709551615
  duration_days: 365

expected:
  status: success
  energy: "<= u64::MAX"  # Saturates instead of overflow

---
spec:
  name: security_overflow_contract_arithmetic
  version: "1.0"
  category: security
  subcategory: arithmetic
  description: "Contract arithmetic overflow is caught"
  priority: P0

preconditions:
  - contract_executing: true

action:
  type: contract_operation
  operation: "add"
  operands:
    - 18446744073709551615  # u64::MAX
    - 1

expected:
  status: error
  error: "ArithmeticOverflow"
  contract_reverted: true

---
spec:
  name: security_overflow_topoheight_safe
  version: "1.0"
  category: security
  subcategory: arithmetic
  description: "TopoHeight operations use checked arithmetic"
  priority: P1

preconditions:
  - current_topoheight: 18446744073709551615  # u64::MAX

action:
  type: add_block
  would_increment_topoheight: true

expected:
  status: error
  error: "Overflow"
  note: "Theoretical - topoheight won't reach u64::MAX in practice"
