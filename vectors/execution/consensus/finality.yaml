# TOS Block Finality Conformance Specifications
# Based on: daemon/src/config.rs, daemon/src/core/blockchain.rs
#
# TOS uses STABLE_LIMIT = 24 for finality (NOT 6)
# A block is stable when: current_height - block_height >= STABLE_LIMIT
# Stable blocks cannot be orphaned by DAG reordering

---
spec:
  name: consensus_finality_stable_limit
  version: "1.0"
  category: consensus
  subcategory: finality
  description: "Block considered stable after STABLE_LIMIT (24) depth"
  priority: P0

preconditions:
  - chain_height: 100
  - target_block_height: 76
  - STABLE_LIMIT: 24

action:
  type: check_stability
  block_height: 76

expected:
  status: success
  is_stable: true
  depth: 24  # 100 - 76 = 24 >= STABLE_LIMIT

---
spec:
  name: consensus_finality_not_stable
  version: "1.0"
  category: consensus
  subcategory: finality
  description: "Block not stable before STABLE_LIMIT depth"
  priority: P0

preconditions:
  - chain_height: 100
  - target_block_height: 77
  - STABLE_LIMIT: 24

action:
  type: check_stability
  block_height: 77

expected:
  status: success
  is_stable: false
  depth: 23  # 100 - 77 = 23 < STABLE_LIMIT

---
spec:
  name: consensus_finality_genesis_stable
  version: "1.0"
  category: consensus
  subcategory: finality
  description: "Genesis block becomes stable at height 24"
  priority: P0

preconditions:
  - genesis_height: 0
  - STABLE_LIMIT: 24

action:
  type: check_stability_sequence
  heights: [23, 24, 25]

expected:
  - chain_height: 23
    genesis_stable: false
    depth: 23
  - chain_height: 24
    genesis_stable: true
    depth: 24
  - chain_height: 25
    genesis_stable: true
    depth: 25

---
spec:
  name: consensus_finality_stable_height_calculation
  version: "1.0"
  category: consensus
  subcategory: finality
  description: "Stable height = current_height - STABLE_LIMIT"
  priority: P0

preconditions:
  - STABLE_LIMIT: 24

action:
  type: calculate_stable_height
  test_cases:
    - current_height: 24
      expected_stable_height: 0
    - current_height: 50
      expected_stable_height: 26
    - current_height: 100
      expected_stable_height: 76
    - current_height: 1000
      expected_stable_height: 976

expected:
  status: success
  formula: "stable_height = current_height.saturating_sub(STABLE_LIMIT)"

---
spec:
  name: consensus_finality_monotonic
  version: "1.0"
  category: consensus
  subcategory: finality
  description: "Stable height never decreases (monotonically increasing)"
  priority: P0

preconditions:
  - chain_growing: true

action:
  type: verify_stability_monotonic
  height_sequence: [0, 10, 24, 50, 100]

expected:
  status: success
  property: "stable_height(h+1) >= stable_height(h)"

postconditions:
  - stable_blocks_never_orphaned: true

---
spec:
  name: consensus_finality_prune_safety
  version: "1.0"
  category: consensus
  subcategory: finality
  description: "PRUNE_SAFETY_LIMIT = STABLE_LIMIT * 10"
  priority: P1

preconditions:
  - STABLE_LIMIT: 24
  - PRUNE_SAFETY_LIMIT: 240

action:
  type: verify_prune_safety
  chain_height: 1000

expected:
  status: success
  min_kept_blocks: 240
  safe_to_prune_below: 760  # 1000 - 240

---
spec:
  name: consensus_finality_sync_block
  version: "1.0"
  category: consensus
  subcategory: finality
  description: "Sync block is highest cumulative difficulty block at stable height"
  priority: P1

preconditions:
  - chain_height: 100
  - stable_height: 76
  - blocks_at_stable_height:
      - block_a:
          hash: "abc123..."
          cumulative_difficulty: 500000
      - block_b:
          hash: "def456..."
          cumulative_difficulty: 600000

action:
  type: determine_sync_block
  height: 76

expected:
  status: success
  sync_block: "block_b"
  reason: "highest_cumulative_difficulty"

---
spec:
  name: consensus_finality_reachability_depth
  version: "1.0"
  category: consensus
  subcategory: finality
  description: "Reachability traversal uses 2 * STABLE_LIMIT = 48"
  priority: P2

preconditions:
  - STABLE_LIMIT: 24
  - reachability_depth: 48  # 2 * STABLE_LIMIT

action:
  type: verify_reachability_depth

expected:
  status: success
  depth: 48
  purpose: "DAG ancestor traversal for non-reachability verification"
