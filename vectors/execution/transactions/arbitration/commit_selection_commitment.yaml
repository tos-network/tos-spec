# TOS CommitSelectionCommitment Transaction Conformance Specifications
# Based on: common/src/transaction/payload/arbitration/commit_selection_commitment.rs
#
# Commit juror selection commitment for dispute resolution

---
spec:
  name: tx_commit_selection_commitment_basic
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "Basic juror selection commitment"
  priority: P0

preconditions:
  - arbitration:
      state: "VoteRequested"
      request_id: "0xrequest..."
  - sender:
      address: "tos1arbiter..."  # Potential juror
      is_arbiter: true
      nonce: 0

action:
  type: transaction
  tx_type: CommitSelectionCommitment
  params:
    request_id: "0xrequest..."
    selection_commitment_id: "0xcommitment..."
    selection_commitment_payload: "<commitment_bytes>"
    fee: 15000
    nonce: 0

expected:
  status: success

postconditions:
  - selection_commitment:
      request_id: "0xrequest..."
      commitment_id: "0xcommitment..."
      committer: "tos1arbiter..."

---
spec:
  name: tx_commit_selection_commitment_not_arbiter
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "Only registered arbiters can commit"
  priority: P0

preconditions:
  - sender:
      is_arbiter: false

action:
  type: transaction
  tx_type: CommitSelectionCommitment
  params:
    request_id: "0xrequest..."

expected:
  status: error
  error: "NotRegisteredArbiter"

---
spec:
  name: tx_commit_selection_commitment_invalid_request
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "Request ID must exist"
  priority: P0

action:
  type: transaction
  tx_type: CommitSelectionCommitment
  params:
    request_id: "0xnonexistent..."

expected:
  status: error
  error: "VoteRequestNotFound"

---
spec:
  name: tx_commit_selection_commitment_wrong_state
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "Arbitration must be in VoteRequested state"
  priority: P0

preconditions:
  - arbitration:
      state: "SelectionPhase"  # Past commitment phase

action:
  type: transaction
  tx_type: CommitSelectionCommitment
  params:
    request_id: "0xrequest..."

expected:
  status: error
  error: "InvalidArbitrationState"

---
spec:
  name: tx_commit_selection_commitment_duplicate
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "Cannot commit twice for same request"
  priority: P0

preconditions:
  - existing_commitment:
      request_id: "0xrequest..."
      committer: "tos1arbiter..."  # Already committed
  - sender:
      address: "tos1arbiter..."

action:
  type: transaction
  tx_type: CommitSelectionCommitment
  params:
    request_id: "0xrequest..."

expected:
  status: error
  error: "AlreadyCommitted"

---
spec:
  name: tx_commit_selection_commitment_deadline_passed
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "Must commit before deadline"
  priority: P0

definition:
  COMMITMENT_WINDOW_BLOCKS: 720  # ~12 hours

preconditions:
  - arbitration:
      vote_requested_at_block: 1000
  - current_block: 2000  # Past deadline

action:
  type: transaction
  tx_type: CommitSelectionCommitment
  params:
    request_id: "0xrequest..."

expected:
  status: error
  error: "CommitmentDeadlinePassed"

---
spec:
  name: tx_commit_selection_commitment_payload_too_large
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "Payload size limit enforcement"
  priority: P0

definition:
  MAX_SELECTION_COMMITMENT_BYTES: 65536  # 64 KB

action:
  type: transaction
  tx_type: CommitSelectionCommitment
  params:
    selection_commitment_payload: "<70000 bytes>"

expected:
  status: error
  error: "PayloadTooLarge"

---
spec:
  name: tx_commit_selection_commitment_inactive_arbiter
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "Arbiter must be active to commit"
  priority: P1

preconditions:
  - arbiter:
      address: "tos1arbiter..."
      status: "Exiting"  # Not active

action:
  type: transaction
  tx_type: CommitSelectionCommitment
  params:
    request_id: "0xrequest..."

expected:
  status: error
  error: "ArbiterNotActive"

---
spec:
  name: tx_commit_selection_commitment_payload_structure
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "CommitSelectionCommitmentPayload wire format"
  priority: P0

definition:
  commit_selection_commitment_payload:
    request_id:
      type: Hash
      size: 32
      description: "Vote request this commitment is for"
    selection_commitment_id:
      type: Hash
      size: 32
      description: "Unique commitment identifier"
    selection_commitment_payload:
      type: "Vec<u8>"
      max_size: 65536
      description: "Encrypted commitment content"

serialization_order:
  - request_id (32 bytes)
  - selection_commitment_id (32 bytes)
  - payload_length (4 bytes)
  - selection_commitment_payload (variable)

---
spec:
  name: tx_commit_selection_commitment_gas_cost
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "CommitSelectionCommitment gas consumption"
  priority: P1

definition:
  base_gas: 15000
  per_kb_gas: 500

formula: "total_gas = 15000 + (payload_size_kb * 500)"
