# TOS RegisterArbiter Transaction Conformance Specifications
# Based on: common/src/transaction/payload/arbitration/register_arbiter.rs
#
# Register as an arbiter for escrow dispute resolution

---
spec:
  name: tx_register_arbiter_basic
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "Basic arbiter registration"
  priority: P0

preconditions:
  - registrant:
      address: "tos1arbiter..."
      balance: 200000000000  # 2000 TOS (enough for stake)
      nonce: 0
      is_arbiter: false

action:
  type: transaction
  tx_type: RegisterArbiter
  params:
    name: "Alice Arbiter"
    expertise:
      - General
      - Payment
    stake_amount: 100000000000  # 1000 TOS (MIN_ARBITER_STAKE)
    min_escrow_value: 100000000  # 1 TOS
    max_escrow_value: 100000000000  # 1000 TOS
    fee_basis_points: 200  # 2%
    fee: 10000
    nonce: 0

expected:
  status: success

postconditions:
  - registrant:
      balance: 100000000000 - 10000  # Stake locked
      is_arbiter: true
      nonce: 1
  - arbiter:
      address: "tos1arbiter..."
      name: "Alice Arbiter"
      stake: 100000000000
      status: "Active"

---
spec:
  name: tx_register_arbiter_minimum_stake
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "Minimum stake is 1000 TOS"
  priority: P0

definition:
  MIN_ARBITER_STAKE: 100000000000  # 1000 TOS

tests:
  - name: at_minimum
    stake_amount: 100000000000
    expected: valid

  - name: below_minimum
    stake_amount: 99999999999  # < 1000 TOS
    expected: error
    error: "InsufficientStake"

---
spec:
  name: tx_register_arbiter_insufficient_balance
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "Registration fails without sufficient balance for stake"
  priority: P0

preconditions:
  - registrant:
      balance: 50000000000  # 500 TOS

action:
  type: transaction
  tx_type: RegisterArbiter
  params:
    stake_amount: 100000000000  # 1000 TOS

expected:
  status: error
  error: "InsufficientBalance"

---
spec:
  name: tx_register_arbiter_already_registered
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "Cannot register twice"
  priority: P0

preconditions:
  - registrant:
      is_arbiter: true

action:
  type: transaction
  tx_type: RegisterArbiter

expected:
  status: error
  error: "AlreadyRegistered"

---
spec:
  name: tx_register_arbiter_expertise_domains
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "Valid expertise domain values"
  priority: P0

definition:
  expertise_domains:
    General: 0
    Payment: 1
    NFT: 2
    DeFi: 3
    Gaming: 4
    DataServices: 5
    AI: 6
    Content: 7
    Legal: 8

tests:
  - name: single_domain
    expertise: [General]
    expected: valid

  - name: multiple_domains
    expertise: [General, Payment, DeFi]
    expected: valid

  - name: empty_domains
    expertise: []
    expected: error
    error: "NoExpertiseDomains"

---
spec:
  name: tx_register_arbiter_escrow_value_range
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "min_escrow_value must be <= max_escrow_value"
  priority: P0

tests:
  - name: valid_range
    min_escrow_value: 100000000  # 1 TOS
    max_escrow_value: 1000000000000  # 10000 TOS
    expected: valid

  - name: equal_values
    min_escrow_value: 500000000
    max_escrow_value: 500000000
    expected: valid

  - name: inverted_range
    min_escrow_value: 1000000000
    max_escrow_value: 100000000  # min > max
    expected: error
    error: "InvalidEscrowValueRange"

---
spec:
  name: tx_register_arbiter_fee_basis_points
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "Fee basis points validation"
  priority: P0

definition:
  basis_points: "100 bps = 1%"

tests:
  - name: valid_2_percent
    fee_basis_points: 200
    expected: valid

  - name: valid_10_percent
    fee_basis_points: 1000
    expected: valid

  - name: zero_fee
    fee_basis_points: 0
    expected: valid
    note: "Arbiter can offer free service"

  - name: exceeds_100_percent
    fee_basis_points: 10001
    expected: error
    error: "FeeTooHigh"

---
spec:
  name: tx_register_arbiter_name_validation
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "Arbiter name validation"
  priority: P1

tests:
  - name: valid_name
    name: "Alice Arbiter"
    expected: valid

  - name: empty_name
    name: ""
    expected: error
    error: "EmptyName"

  - name: long_name
    name: "<string longer than 256 chars>"
    expected: error
    error: "NameTooLong"

---
spec:
  name: tx_register_arbiter_stake_locked
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "Staked TOS is locked until exit"
  priority: P0

note: |
  Stake cannot be withdrawn while arbiter is active.
  Must call RequestArbiterExit to begin withdrawal process.
  Stake can be slashed for misbehavior.

---
spec:
  name: tx_register_arbiter_payload_structure
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "RegisterArbiterPayload wire format"
  priority: P0

definition:
  register_arbiter_payload:
    name:
      type: String
      description: "Display name"
    expertise:
      type: "Vec<ExpertiseDomain>"
      description: "Expertise domains"
    stake_amount:
      type: u64
      size: 8
      description: "Initial stake (min 1000 TOS)"
    min_escrow_value:
      type: u64
      size: 8
      description: "Minimum escrow value to handle"
    max_escrow_value:
      type: u64
      size: 8
      description: "Maximum escrow value to handle"
    fee_basis_points:
      type: u16
      size: 2
      description: "Fee percentage in basis points"

serialization_order:
  - name (variable)
  - expertise (variable)
  - stake_amount (8 bytes)
  - min_escrow_value (8 bytes)
  - max_escrow_value (8 bytes)
  - fee_basis_points (2 bytes)

---
spec:
  name: tx_register_arbiter_constants
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "Arbitration-related constants"
  priority: P0

constants:
  MIN_ARBITER_STAKE: 100000000000  # 1000 TOS
  JUROR_SUBMIT_WINDOW: 86400  # blocks after coordinator deadline
  MAX_ARBITRATION_OPEN_BYTES: 65536  # 64 KB
  MAX_VOTE_REQUEST_BYTES: 65536
  MAX_SELECTION_COMMITMENT_BYTES: 65536
  MAX_JUROR_VOTE_BYTES: 8192
  MAX_VERDICT_BUNDLE_BYTES: 131072

---
spec:
  name: tx_register_arbiter_status_lifecycle
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "Arbiter status lifecycle"
  priority: P1

definition:
  arbiter_statuses:
    Active: "Can be selected for disputes"
    Suspended: "Temporarily suspended"
    ExitRequested: "Withdrawal in progress"
    Exited: "Fully withdrawn"
    Slashed: "Stake slashed for misbehavior"

  transitions:
    Active:
      - to: Suspended
        via: "Governance action"
      - to: ExitRequested
        via: RequestArbiterExit
    ExitRequested:
      - to: Active
        via: CancelArbiterExit
      - to: Exited
        via: WithdrawArbiterStake
    Active:
      - to: Slashed
        via: SlashArbiter
