# TOS CancelArbiterExit Transaction Conformance Specifications
# Based on: common/src/transaction/payload/arbitration/cancel_arbiter_exit.rs
#
# Cancel a pending arbiter exit request

---
spec:
  name: tx_cancel_arbiter_exit_basic
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "Basic arbiter exit cancellation"
  priority: P0

preconditions:
  - arbiter:
      address: "tos1arbiter..."
      status: "Exiting"
      exit_requested_at: 1706832000
      stake: 10000000000
  - sender:
      address: "tos1arbiter..."
      nonce: 0

action:
  type: transaction
  tx_type: CancelArbiterExit
  params:
    fee: 10000
    nonce: 0

expected:
  status: success

postconditions:
  - arbiter:
      status: "Active"
      exit_requested_at: null

note: |
  Cancelling exit returns the arbiter to active status.
  They can immediately be assigned to new disputes.

---
spec:
  name: tx_cancel_arbiter_exit_not_exiting
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "Cannot cancel if not in exiting state"
  priority: P0

preconditions:
  - arbiter:
      status: "Active"  # Not exiting

action:
  type: transaction
  tx_type: CancelArbiterExit

expected:
  status: error
  error: "NotInExitingState"

---
spec:
  name: tx_cancel_arbiter_exit_not_registered
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "Cannot cancel if not registered arbiter"
  priority: P0

preconditions:
  - sender:
      is_arbiter: false

action:
  type: transaction
  tx_type: CancelArbiterExit

expected:
  status: error
  error: "NotRegisteredArbiter"

---
spec:
  name: tx_cancel_arbiter_exit_after_cooldown
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "Can still cancel after cooldown expires"
  priority: P1

definition:
  EXIT_COOLDOWN_BLOCKS: 14400  # 10 days

preconditions:
  - arbiter:
      status: "Exiting"
      exit_requested_at_block: 1000
  - current_block: 20000  # Past cooldown

action:
  type: transaction
  tx_type: CancelArbiterExit

expected:
  status: success

postconditions:
  - arbiter:
      status: "Active"

note: |
  Even after cooldown expires, the arbiter can choose to cancel
  and remain active. They must explicitly withdraw to exit.

---
spec:
  name: tx_cancel_arbiter_exit_with_pending_cases
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "Cancelling makes arbiter available for new cases"
  priority: P1

preconditions:
  - arbiter:
      status: "Exiting"
      pending_cases: 2

action:
  type: transaction
  tx_type: CancelArbiterExit

expected:
  status: success

postconditions:
  - arbiter:
      status: "Active"
      available_for_assignment: true

---
spec:
  name: tx_cancel_arbiter_exit_payload_structure
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "CancelArbiterExitPayload wire format"
  priority: P0

definition:
  cancel_arbiter_exit_payload:
    description: "Empty payload - uses sender identity"

serialization_order: []

total_size: 0 bytes

note: |
  This is an empty payload transaction.
  The sender's identity determines which arbiter's exit is cancelled.

---
spec:
  name: tx_cancel_arbiter_exit_gas_cost
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "CancelArbiterExit gas consumption"
  priority: P1

definition:
  gas_cost: 10000
