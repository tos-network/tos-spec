# TOS UnfreezeTos Transaction Conformance Specifications
# Based on: common/src/transaction/payload/energy.rs
#
# Phase 1 of two-phase unfreeze: creates pending unfreeze record

---
spec:
  name: tx_unfreeze_tos_basic
  version: "1.0"
  category: transactions
  subcategory: energy
  description: "Basic unfreeze from self-freeze record"
  priority: P0

preconditions:
  - account:
      address: "tos1staker..."
      balance: 0
      energy: 14
      freeze_records:
        - amount: 100000000  # 1 TOS (whole units stored)
          duration: 7
          unlock_topoheight: 1000
          energy_gained: 14
      pending_unfreezes_count: 0
      nonce: 0
  - current_topoheight: 1001  # After unlock

action:
  type: transaction
  tx_type: Energy
  params:
    payload:
      UnfreezeTos:
        amount: 100000000  # 1 TOS
        from_delegation: false
        record_index: null
        delegatee_address: null
    fee: 0
    nonce: 0

expected:
  status: success

postconditions:
  - account:
      energy: 0  # Energy removed immediately
      freeze_records_count: 0  # Record removed
      pending_unfreezes_count: 1
      pending_unfreeze:
        amount: 100000000
        expire_topoheight: 1001 + (14 * 86400)  # 14-day cooldown
      nonce: 1

---
spec:
  name: tx_unfreeze_tos_before_unlock
  version: "1.0"
  category: transactions
  subcategory: energy
  description: "Unfreeze rejected before unlock time"
  priority: P0

preconditions:
  - account:
      freeze_records:
        - amount: 100000000
          unlock_topoheight: 2000000
      nonce: 0
  - current_topoheight: 1000000  # Before unlock

action:
  type: transaction
  tx_type: Energy
  params:
    payload:
      UnfreezeTos:
        amount: 100000000
        from_delegation: false

expected:
  status: error
  error: "FreezeNotYetUnlocked"

---
spec:
  name: tx_unfreeze_tos_partial
  version: "1.0"
  category: transactions
  subcategory: energy
  description: "Partial unfreeze from a record"
  priority: P0

preconditions:
  - account:
      balance: 0
      energy: 28  # From 2 TOS frozen
      freeze_records:
        - amount: 200000000  # 2 TOS
          energy_gained: 28
          unlock_topoheight: 1000
      nonce: 0
  - current_topoheight: 1001

action:
  type: transaction
  tx_type: Energy
  params:
    payload:
      UnfreezeTos:
        amount: 100000000  # Unfreeze only 1 TOS
        from_delegation: false

expected:
  status: success

postconditions:
  - account:
      energy: 14  # Proportional energy remaining (28 * 1/2)
      freeze_records:
        - amount: 100000000  # 1 TOS remaining
          energy_gained: 14  # Proportional
      pending_unfreezes:
        - amount: 100000000

---
spec:
  name: tx_unfreeze_tos_minimum_amount
  version: "1.0"
  category: transactions
  subcategory: energy
  description: "Minimum unfreeze amount is 1 TOS"
  priority: P0

preconditions:
  - account:
      freeze_records:
        - amount: 200000000
          unlock_topoheight: 1000
      nonce: 0
  - current_topoheight: 1001

action:
  type: transaction
  tx_type: Energy
  params:
    payload:
      UnfreezeTos:
        amount: 50000000  # 0.5 TOS (below minimum)
        from_delegation: false

expected:
  status: error
  error: "AmountBelowMinimum"

---
spec:
  name: tx_unfreeze_tos_exceed_frozen_amount
  version: "1.0"
  category: transactions
  subcategory: energy
  description: "Cannot unfreeze more than frozen"
  priority: P0

preconditions:
  - account:
      freeze_records:
        - amount: 100000000  # 1 TOS
          unlock_topoheight: 1000
      nonce: 0
  - current_topoheight: 1001

action:
  type: transaction
  tx_type: Energy
  params:
    payload:
      UnfreezeTos:
        amount: 200000000  # 2 TOS (more than frozen)
        from_delegation: false

expected:
  status: error
  error: "InsufficientFrozenBalance"

---
spec:
  name: tx_unfreeze_tos_with_record_index
  version: "1.0"
  category: transactions
  subcategory: energy
  description: "Unfreeze from specific record by index"
  priority: P1

preconditions:
  - account:
      freeze_records:
        - index: 0
          amount: 100000000
          unlock_topoheight: 1000
        - index: 1
          amount: 200000000
          unlock_topoheight: 2000
      nonce: 0
  - current_topoheight: 2001  # Both unlocked

action:
  type: transaction
  tx_type: Energy
  params:
    payload:
      UnfreezeTos:
        amount: 200000000
        from_delegation: false
        record_index: 1  # Select second record

expected:
  status: success

postconditions:
  - account:
      freeze_records_count: 1
      freeze_records:
        - index: 0
          amount: 100000000  # First record unchanged

---
spec:
  name: tx_unfreeze_tos_fifo_order
  version: "1.0"
  category: transactions
  subcategory: energy
  description: "Without record_index, uses FIFO order"
  priority: P1

preconditions:
  - account:
      freeze_records:
        - index: 0
          amount: 100000000
          freeze_topoheight: 500
          unlock_topoheight: 1000
        - index: 1
          amount: 200000000
          freeze_topoheight: 600
          unlock_topoheight: 1100
      nonce: 0
  - current_topoheight: 1200  # Both unlocked

action:
  type: transaction
  tx_type: Energy
  params:
    payload:
      UnfreezeTos:
        amount: 100000000
        from_delegation: false
        record_index: null  # FIFO

expected:
  status: success
  note: "Unfreezes from oldest record first (index 0)"

---
spec:
  name: tx_unfreeze_tos_from_delegation
  version: "1.0"
  category: transactions
  subcategory: energy
  description: "Unfreeze from delegation record"
  priority: P0

preconditions:
  - delegator:
      address: "tos1delegator..."
      delegated_records:
        - entries:
            - delegatee: "tos1alice..."
              amount: 100000000
              energy: 14
          unlock_topoheight: 1000
      nonce: 0
  - delegatee:
      address: "tos1alice..."
      energy: 14  # From lease
  - current_topoheight: 1001

action:
  type: transaction
  tx_type: Energy
  params:
    payload:
      UnfreezeTos:
        amount: 100000000
        from_delegation: true
        delegatee_address: "tos1alice..."
    sender: "tos1delegator..."

expected:
  status: success

postconditions:
  - delegator:
      pending_unfreezes:
        - amount: 100000000
  - delegatee:
      energy: 0  # Lease removed

---
spec:
  name: tx_unfreeze_tos_delegation_missing_delegatee
  version: "1.0"
  category: transactions
  subcategory: energy
  description: "Delegation unfreeze requires delegatee_address"
  priority: P0

preconditions:
  - delegator:
      delegated_records:
        - entries:
            - delegatee: "tos1alice..."
              amount: 100000000
          unlock_topoheight: 1000
      nonce: 0
  - current_topoheight: 1001

action:
  type: transaction
  tx_type: Energy
  params:
    payload:
      UnfreezeTos:
        amount: 100000000
        from_delegation: true
        delegatee_address: null  # Missing

expected:
  status: error
  error: "MissingDelegateeAddress"

---
spec:
  name: tx_unfreeze_tos_max_pending
  version: "1.0"
  category: transactions
  subcategory: energy
  description: "Maximum 32 pending unfreezes"
  priority: P0

preconditions:
  - account:
      pending_unfreezes_count: 32  # MAX_PENDING_UNFREEZES
      freeze_records:
        - amount: 100000000
          unlock_topoheight: 1000
      nonce: 0
  - current_topoheight: 1001

action:
  type: transaction
  tx_type: Energy
  params:
    payload:
      UnfreezeTos:
        amount: 100000000
        from_delegation: false

expected:
  status: error
  error: "MaxPendingUnfreezesReached"

---
spec:
  name: tx_unfreeze_tos_no_records
  version: "1.0"
  category: transactions
  subcategory: energy
  description: "Unfreeze fails with no freeze records"
  priority: P0

preconditions:
  - account:
      freeze_records_count: 0
      nonce: 0

action:
  type: transaction
  tx_type: Energy
  params:
    payload:
      UnfreezeTos:
        amount: 100000000
        from_delegation: false

expected:
  status: error
  error: "NoFreezeRecordFound"

---
spec:
  name: tx_unfreeze_tos_payload_structure
  version: "1.0"
  category: transactions
  subcategory: energy
  description: "UnfreezeTos payload wire format"
  priority: P0

definition:
  unfreeze_tos_payload:
    variant_tag: 2  # u8
    amount:
      type: u64
      size: 8
    from_delegation:
      type: bool
      size: 1
    record_index:
      type: "Option<u32>"
      size: "1 or 5"  # 0x00 for None, 0x01 + u32 for Some
    delegatee_address:
      type: "Option<PublicKey>"
      size: "1 or 33"  # 0x00 for None, 0x01 + 32 for Some

serialization_order:
  - variant (1 byte: 0x02)
  - amount (8 bytes)
  - from_delegation (1 byte)
  - record_index (1-5 bytes)
  - delegatee_address (1-33 bytes)

---
spec:
  name: tx_unfreeze_tos_cooldown_period
  version: "1.0"
  category: transactions
  subcategory: energy
  description: "14-day cooldown before withdrawal"
  priority: P0

definition:
  cooldown:
    mainnet: "14 * 86400 = 1,209,600 blocks"
    devnet: "14 * 10 = 140 blocks"

note: |
  After unfreeze, TOS enters pending_unfreezes.
  User must wait for cooldown, then call WithdrawUnfrozen.
  This prevents rapid stake/unstake cycling attacks.
