# TOS AppealKyc Transaction Conformance Specifications
# Based on: common/src/transaction/payload/kyc/appeal.rs
#
# Appeal rejected or revoked KYC to parent committee

---
spec:
  name: tx_appeal_kyc_basic
  version: "1.0"
  category: transactions
  subcategory: kyc
  description: "Basic KYC appeal"
  priority: P0

preconditions:
  - target_account:
      address: "tos1target..."
      kyc_status: "Revoked"
      kyc_committee: "0xoriginal_committee..."
  - original_committee:
      id: "0xoriginal_committee..."
      status: "Active"
      parent_id: "0xparent_committee..."
  - parent_committee:
      id: "0xparent_committee..."
      status: "Active"
  - sender:
      address: "tos1target..."  # User appeals their own KYC
      balance: 100000000
      nonce: 0

action:
  type: transaction
  tx_type: AppealKyc
  params:
    account: "tos1target..."
    original_committee_id: "0xoriginal_committee..."
    parent_committee_id: "0xparent_committee..."
    reason_hash: "0xreason..."  # Hash of appeal reason
    documents_hash: "0xdocs..."  # Hash of supporting documents
    submitted_at: 1706832000
    fee: 40000
    nonce: 0

expected:
  status: success

postconditions:
  - appeal:
      account: "tos1target..."
      status: "Pending"
      reviewer: "0xparent_committee..."

---
spec:
  name: tx_appeal_kyc_rejected_status
  version: "1.0"
  category: transactions
  subcategory: kyc
  description: "Appeal rejected KYC application"
  priority: P0

preconditions:
  - target_account:
      kyc_status: "Rejected"  # Application was rejected

action:
  type: transaction
  tx_type: AppealKyc
  params:
    account: "tos1target..."
    reason_hash: "0xreason..."

expected:
  status: success

note: |
  Both "Rejected" (application denied) and "Revoked"
  (existing KYC removed) can be appealed.

---
spec:
  name: tx_appeal_kyc_no_existing_record
  version: "1.0"
  category: transactions
  subcategory: kyc
  description: "Cannot appeal without existing KYC record"
  priority: P0

preconditions:
  - target_account:
      kyc_status: null  # Never applied

action:
  type: transaction
  tx_type: AppealKyc
  params:
    account: "tos1target..."

expected:
  status: error
  error: "NoKycRecord"

---
spec:
  name: tx_appeal_kyc_active_status
  version: "1.0"
  category: transactions
  subcategory: kyc
  description: "Cannot appeal active KYC"
  priority: P0

preconditions:
  - target_account:
      kyc_status: "Active"

action:
  type: transaction
  tx_type: AppealKyc
  params:
    account: "tos1target..."

expected:
  status: error
  error: "KycIsActive"

---
spec:
  name: tx_appeal_kyc_window_expired
  version: "1.0"
  category: transactions
  subcategory: kyc
  description: "Appeal must be within appeal window"
  priority: P0

definition:
  APPEAL_WINDOW_DAYS: 30

preconditions:
  - target_account:
      kyc_status: "Revoked"
      revoked_at: 1704240000  # 30+ days ago
  - current_timestamp: 1706918400

action:
  type: transaction
  tx_type: AppealKyc
  params:
    account: "tos1target..."
    submitted_at: 1706918400

expected:
  status: error
  error: "AppealWindowExpired"

---
spec:
  name: tx_appeal_kyc_wrong_parent
  version: "1.0"
  category: transactions
  subcategory: kyc
  description: "Parent committee must be actual parent"
  priority: P0

preconditions:
  - original_committee:
      id: "0xoriginal..."
      parent_id: "0xcorrect_parent..."

action:
  type: transaction
  tx_type: AppealKyc
  params:
    original_committee_id: "0xoriginal..."
    parent_committee_id: "0xwrong_parent..."

expected:
  status: error
  error: "NotParentCommittee"

---
spec:
  name: tx_appeal_kyc_suspended_committee
  version: "1.0"
  category: transactions
  subcategory: kyc
  description: "Cannot appeal to suspended committee"
  priority: P1

preconditions:
  - parent_committee:
      status: "Suspended"

action:
  type: transaction
  tx_type: AppealKyc
  params:
    parent_committee_id: "0xsuspended..."

expected:
  status: error
  error: "ParentCommitteeSuspended"

---
spec:
  name: tx_appeal_kyc_already_pending
  version: "1.0"
  category: transactions
  subcategory: kyc
  description: "Cannot have multiple pending appeals"
  priority: P0

preconditions:
  - existing_appeal:
      account: "tos1target..."
      status: "Pending"

action:
  type: transaction
  tx_type: AppealKyc
  params:
    account: "tos1target..."

expected:
  status: error
  error: "AppealAlreadyPending"

---
spec:
  name: tx_appeal_kyc_third_party
  version: "1.0"
  category: transactions
  subcategory: kyc
  description: "Third party cannot appeal on behalf of user"
  priority: P0

preconditions:
  - target_account:
      address: "tos1target..."
  - sender:
      address: "tos1other..."  # Different from target

action:
  type: transaction
  tx_type: AppealKyc
  params:
    account: "tos1target..."

expected:
  status: error
  error: "UnauthorizedAppeal"

note: |
  Only the affected user can initiate an appeal.
  This prevents spam and ensures user consent.

---
spec:
  name: tx_appeal_kyc_payload_structure
  version: "1.0"
  category: transactions
  subcategory: kyc
  description: "AppealKycPayload wire format"
  priority: P0

definition:
  appeal_kyc_payload:
    account:
      type: CompressedPublicKey
      size: 32
      description: "User appealing KYC"
    original_committee_id:
      type: Hash
      size: 32
      description: "Committee that rejected/revoked"
    parent_committee_id:
      type: Hash
      size: 32
      description: "Parent committee (reviewer)"
    reason_hash:
      type: Hash
      size: 32
      description: "Hash of appeal reason"
    documents_hash:
      type: Hash
      size: 32
      description: "Hash of supporting documents"
    submitted_at:
      type: u64
      size: 8
      description: "Appeal submission timestamp"

serialization_order:
  - account (32 bytes)
  - original_committee_id (32 bytes)
  - parent_committee_id (32 bytes)
  - reason_hash (32 bytes)
  - documents_hash (32 bytes)
  - submitted_at (8 bytes)

total_size: 168 bytes

---
spec:
  name: tx_appeal_kyc_gas_cost
  version: "1.0"
  category: transactions
  subcategory: kyc
  description: "AppealKyc gas consumption"
  priority: P1

definition:
  gas_cost: 40000
