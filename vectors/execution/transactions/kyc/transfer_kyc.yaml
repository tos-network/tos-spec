# TOS TransferKyc Transaction Conformance Specifications
# Based on: common/src/transaction/payload/kyc/transfer.rs
#
# Transfer KYC across regions (requires dual committee approval)

---
spec:
  name: tx_transfer_kyc_basic
  version: "1.0"
  category: transactions
  subcategory: kyc
  description: "Basic KYC transfer between regions"
  priority: P0

preconditions:
  - target_account:
      address: "tos1target..."
      kyc_level: 1024  # Tier 5
      kyc_committee: "0xsource_committee..."
  - source_committee:
      id: "0xsource_committee..."
      status: "Active"
      kyc_threshold: 2
  - dest_committee:
      id: "0xdest_committee..."
      status: "Active"
      kyc_threshold: 2
      max_kyc_level: 8191  # >= user's level
  - sender:
      address: "tos1sender..."
      balance: 100000000
      nonce: 0

action:
  type: transaction
  tx_type: TransferKyc
  params:
    account: "tos1target..."
    source_committee_id: "0xsource_committee..."
    source_approvals:
      - member_pubkey: "tos1source_member1..."
        signature: "<valid_signature>"
        timestamp: 1706832000
      - member_pubkey: "tos1source_member2..."
        signature: "<valid_signature>"
        timestamp: 1706832000
    dest_committee_id: "0xdest_committee..."
    dest_approvals:
      - member_pubkey: "tos1dest_member1..."
        signature: "<valid_signature>"
        timestamp: 1706832000
      - member_pubkey: "tos1dest_member2..."
        signature: "<valid_signature>"
        timestamp: 1706832000
    new_data_hash: "0xnew_data..."
    transferred_at: 1706832000
    fee: 60000
    nonce: 0

expected:
  status: success

postconditions:
  - target_account:
      kyc_committee: "0xdest_committee..."
      kyc_data_hash: "0xnew_data..."

---
spec:
  name: tx_transfer_kyc_insufficient_source_approvals
  version: "1.0"
  category: transactions
  subcategory: kyc
  description: "Transfer requires source committee approval"
  priority: P0

preconditions:
  - source_committee:
      kyc_threshold: 3

action:
  type: transaction
  tx_type: TransferKyc
  params:
    source_approvals:
      - member_pubkey: "tos1member1..."
      # Only 1 approval, need 3

expected:
  status: error
  error: "InsufficientSourceApprovals"

---
spec:
  name: tx_transfer_kyc_insufficient_dest_approvals
  version: "1.0"
  category: transactions
  subcategory: kyc
  description: "Transfer requires destination committee approval"
  priority: P0

preconditions:
  - dest_committee:
      kyc_threshold: 2

action:
  type: transaction
  tx_type: TransferKyc
  params:
    dest_approvals:
      - member_pubkey: "tos1member1..."
      # Only 1 approval, need 2

expected:
  status: error
  error: "InsufficientDestApprovals"

---
spec:
  name: tx_transfer_kyc_wrong_source_committee
  version: "1.0"
  category: transactions
  subcategory: kyc
  description: "Source committee must match user's current committee"
  priority: P0

preconditions:
  - target_account:
      kyc_committee: "0xactual_committee..."

action:
  type: transaction
  tx_type: TransferKyc
  params:
    source_committee_id: "0xwrong_committee..."

expected:
  status: error
  error: "SourceCommitteeMismatch"

---
spec:
  name: tx_transfer_kyc_dest_level_too_low
  version: "1.0"
  category: transactions
  subcategory: kyc
  description: "Destination committee must support user's KYC level"
  priority: P0

preconditions:
  - target_account:
      kyc_level: 8191  # Tier 6
  - dest_committee:
      max_kyc_level: 1024  # Only up to Tier 5

action:
  type: transaction
  tx_type: TransferKyc
  params:
    dest_committee_id: "0xdest_committee..."

expected:
  status: error
  error: "DestCommitteeLevelTooLow"

---
spec:
  name: tx_transfer_kyc_same_committee
  version: "1.0"
  category: transactions
  subcategory: kyc
  description: "Cannot transfer to same committee"
  priority: P0

preconditions:
  - target_account:
      kyc_committee: "0xcommittee..."

action:
  type: transaction
  tx_type: TransferKyc
  params:
    source_committee_id: "0xcommittee..."
    dest_committee_id: "0xcommittee..."  # Same

expected:
  status: error
  error: "SameCommittee"

---
spec:
  name: tx_transfer_kyc_not_verified
  version: "1.0"
  category: transactions
  subcategory: kyc
  description: "Cannot transfer unverified account"
  priority: P0

preconditions:
  - target_account:
      kyc_level: 0

action:
  type: transaction
  tx_type: TransferKyc
  params:
    account: "tos1target..."

expected:
  status: error
  error: "AccountNotVerified"

---
spec:
  name: tx_transfer_kyc_suspended_source
  version: "1.0"
  category: transactions
  subcategory: kyc
  description: "Cannot transfer from suspended committee"
  priority: P1

preconditions:
  - source_committee:
      status: "Suspended"

action:
  type: transaction
  tx_type: TransferKyc
  params:
    source_committee_id: "0xsuspended..."

expected:
  status: error
  error: "SourceCommitteeSuspended"

---
spec:
  name: tx_transfer_kyc_payload_structure
  version: "1.0"
  category: transactions
  subcategory: kyc
  description: "TransferKycPayload wire format"
  priority: P0

definition:
  transfer_kyc_payload:
    account:
      type: CompressedPublicKey
      size: 32
    source_committee_id:
      type: Hash
      size: 32
    source_approvals:
      type: "Vec<CommitteeApproval>"
    dest_committee_id:
      type: Hash
      size: 32
    dest_approvals:
      type: "Vec<CommitteeApproval>"
    new_data_hash:
      type: Hash
      size: 32
      description: "Off-chain data hash from destination committee"
    transferred_at:
      type: u64
      size: 8

serialization_order:
  - account (32 bytes)
  - source_committee_id (32 bytes)
  - source_approval_count (1 byte)
  - [source_approvals]
  - dest_committee_id (32 bytes)
  - dest_approval_count (1 byte)
  - [dest_approvals]
  - new_data_hash (32 bytes)
  - transferred_at (8 bytes)

---
spec:
  name: tx_transfer_kyc_use_cases
  version: "1.0"
  category: transactions
  subcategory: kyc
  description: "KYC transfer use cases"
  priority: P2

use_cases:
  - name: user_relocation
    description: "User moves from one region to another"

  - name: regulatory_requirement
    description: "Jurisdiction change requires different committee"

  - name: committee_upgrade
    description: "User moves to committee with higher capabilities"

---
spec:
  name: tx_transfer_kyc_gas_cost
  version: "1.0"
  category: transactions
  subcategory: kyc
  description: "TransferKyc gas consumption"
  priority: P1

definition:
  gas_cost: 60000
  note: "Higher cost due to dual committee verification"
