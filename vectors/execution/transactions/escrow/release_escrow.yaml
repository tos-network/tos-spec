# TOS ReleaseEscrow Transaction Conformance Specifications
# Based on: common/src/transaction/payload/escrow/mod.rs
#
# Release escrowed funds to service provider

---
spec:
  name: tx_release_escrow_basic
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Basic escrow release to provider"
  priority: P0

preconditions:
  - escrow:
      id: "0xescrow..."
      payer: "tos1payer..."
      provider: "tos1provider..."
      amount: 500000000  # 5 TOS
      state: "Created"
  - provider:
      balance: 0
  - sender:
      address: "tos1payer..."  # Payer initiates release
      nonce: 0

action:
  type: transaction
  tx_type: ReleaseEscrow
  params:
    escrow_id: "0xescrow..."
    amount: 500000000  # Full amount
    completion_proof: null
    fee: 5000
    nonce: 0

expected:
  status: success

postconditions:
  - escrow:
      state: "Released"
      released_amount: 500000000
  - provider:
      balance: 500000000  # Received funds

---
spec:
  name: tx_release_escrow_partial
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Partial escrow release"
  priority: P0

preconditions:
  - escrow:
      id: "0xescrow..."
      payer: "tos1payer..."
      provider: "tos1provider..."
      amount: 500000000
      state: "Created"

action:
  type: transaction
  tx_type: ReleaseEscrow
  params:
    escrow_id: "0xescrow..."
    amount: 200000000  # Partial: 2 TOS of 5

expected:
  status: success

postconditions:
  - escrow:
      remaining_amount: 300000000  # 3 TOS left
      state: "Created"  # Still active for remaining
  - provider:
      balance_increase: 200000000

---
spec:
  name: tx_release_escrow_with_proof
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Release with completion proof hash"
  priority: P1

action:
  type: transaction
  tx_type: ReleaseEscrow
  params:
    escrow_id: "0xescrow..."
    amount: 500000000
    completion_proof: "0xproof_hash..."  # Hash of off-chain proof

expected:
  status: success

postconditions:
  - escrow:
      completion_proof: "0xproof_hash..."

---
spec:
  name: tx_release_escrow_unauthorized
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Only payer can release escrow"
  priority: P0

preconditions:
  - escrow:
      payer: "tos1payer..."
  - sender:
      address: "tos1unauthorized..."  # Not the payer

action:
  type: transaction
  tx_type: ReleaseEscrow
  params:
    escrow_id: "0xescrow..."
    amount: 500000000

expected:
  status: error
  error: "UnauthorizedRelease"

---
spec:
  name: tx_release_escrow_not_found
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Release non-existent escrow fails"
  priority: P0

action:
  type: transaction
  tx_type: ReleaseEscrow
  params:
    escrow_id: "0xnonexistent..."

expected:
  status: error
  error: "EscrowNotFound"

---
spec:
  name: tx_release_escrow_already_released
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Cannot release already released escrow"
  priority: P0

preconditions:
  - escrow:
      state: "Released"
      remaining_amount: 0

action:
  type: transaction
  tx_type: ReleaseEscrow
  params:
    escrow_id: "0xescrow..."
    amount: 100000000

expected:
  status: error
  error: "EscrowAlreadyReleased"

---
spec:
  name: tx_release_escrow_exceed_remaining
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Cannot release more than remaining"
  priority: P0

preconditions:
  - escrow:
      amount: 500000000
      released_amount: 200000000
      remaining_amount: 300000000

action:
  type: transaction
  tx_type: ReleaseEscrow
  params:
    escrow_id: "0xescrow..."
    amount: 400000000  # More than remaining

expected:
  status: error
  error: "InsufficientEscrowBalance"

---
spec:
  name: tx_release_escrow_zero_amount
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Zero amount release rejected"
  priority: P0

action:
  type: transaction
  tx_type: ReleaseEscrow
  params:
    escrow_id: "0xescrow..."
    amount: 0

expected:
  status: error
  error: "InvalidAmount"

---
spec:
  name: tx_release_escrow_disputed
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Cannot release disputed escrow"
  priority: P0

preconditions:
  - escrow:
      state: "Disputed"

action:
  type: transaction
  tx_type: ReleaseEscrow
  params:
    escrow_id: "0xescrow..."
    amount: 100000000

expected:
  status: error
  error: "EscrowDisputed"

---
spec:
  name: tx_release_escrow_optimistic_auto_release
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Optimistic escrow auto-releases after challenge window"
  priority: P1

preconditions:
  - escrow:
      optimistic_release: true
      challenge_window: 3600
      created_at_block: 1000
      state: "Created"
  - current_block: 5000  # > 1000 + 3600

action:
  type: transaction
  tx_type: ReleaseEscrow
  params:
    escrow_id: "0xescrow..."
    amount: 500000000
    sender: "anyone"  # Anyone can trigger after window

expected:
  status: success
  note: "Optimistic release can be triggered by anyone after window"

---
spec:
  name: tx_release_escrow_during_challenge
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Release during active challenge"
  priority: P1

preconditions:
  - escrow:
      state: "Challenged"

action:
  type: transaction
  tx_type: ReleaseEscrow
  params:
    escrow_id: "0xescrow..."
    amount: 500000000
    sender: "payer"  # Payer can still release

expected:
  status: success
  note: "Payer can release during challenge (withdrawing claim)"

postconditions:
  - escrow:
      state: "Released"

---
spec:
  name: tx_release_escrow_payload_structure
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "ReleaseEscrowPayload wire format"
  priority: P0

definition:
  release_escrow_payload:
    escrow_id:
      type: Hash
      size: 32
    amount:
      type: u64
      size: 8
    completion_proof:
      type: "Option<Hash>"
      size: "1 or 33"

serialization_order:
  - "escrow_id (32 bytes)"
  - "amount (8 bytes)"
  - "completion_proof_flag (1 byte)"
  - "[completion_proof] (32 bytes if present)"

---
spec:
  name: tx_release_escrow_multiple_releases
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Multiple partial releases supported"
  priority: P1

preconditions:
  - escrow:
      amount: 1000000000  # 10 TOS

actions:
  - type: transaction
    tx_type: ReleaseEscrow
    params:
      amount: 200000000  # 2 TOS

  - type: transaction
    tx_type: ReleaseEscrow
    params:
      amount: 300000000  # 3 TOS

  - type: transaction
    tx_type: ReleaseEscrow
    params:
      amount: 500000000  # 5 TOS (remaining)

expected:
  - status: success
    remaining: 800000000
  - status: success
    remaining: 500000000
  - status: success
    remaining: 0

postconditions:
  - escrow:
      state: "Released"
      total_released: 1000000000
