# TOS Transfer Transaction Conformance Specifications
# Based on: common/src/transaction/payload/transfer.rs, common/src/transaction/mod.rs
#
# Plaintext TOS transfers between accounts

---
spec:
  name: tx_transfer_basic
  version: "1.0"
  category: transactions
  subcategory: core
  description: "Basic single transfer transaction"
  priority: P0

preconditions:
  - sender:
      address: "tos1sender..."
      balance: 200000000  # 2 TOS
      nonce: 5

action:
  type: transaction
  tx_type: Transfers
  params:
    transfers:
      - asset: "0x0000...0000"  # TOS_ASSET
        destination: "tos1receiver..."
        amount: 100000000  # 1 TOS
        extra_data: null
    fee: 7500
    fee_type: TOS
    nonce: 5

expected:
  status: success
  fee_charged: 7500

postconditions:
  - sender:
      balance: 92492500  # 2 TOS - 1 TOS - 7500 fee
      nonce: 6
  - receiver:
      balance: 100000000  # 1 TOS

---
spec:
  name: tx_transfer_batch
  version: "1.0"
  category: transactions
  subcategory: core
  description: "Batch transfer to multiple recipients"
  priority: P0

preconditions:
  - sender:
      address: "tos1sender..."
      balance: 500000000  # 5 TOS
      nonce: 10

action:
  type: transaction
  tx_type: Transfers
  params:
    transfers:
      - asset: "0x0000...0000"
        destination: "tos1bob..."
        amount: 100000000
      - asset: "0x0000...0000"
        destination: "tos1alice..."
        amount: 100000000
      - asset: "0x0000...0000"
        destination: "tos1charlie..."
        amount: 100000000
    fee: 17500  # 3 transfers
    fee_type: TOS
    nonce: 10

expected:
  status: success

postconditions:
  - sender:
      balance: 182482500  # 5 - 3 - 0.000175 TOS
      nonce: 11

---
spec:
  name: tx_transfer_with_memo
  version: "1.0"
  category: transactions
  subcategory: core
  description: "Transfer with extra_data memo field"
  priority: P1

preconditions:
  - sender:
      address: "tos1sender..."
      balance: 200000000
      nonce: 0

action:
  type: transaction
  tx_type: Transfers
  params:
    transfers:
      - asset: "0x0000...0000"
        destination: "tos1receiver..."
        amount: 100000000
        extra_data: "0x6f726465725f3132333435"  # "order_12345" hex
    fee: 7500
    nonce: 0

expected:
  status: success

---
spec:
  name: tx_transfer_insufficient_balance
  version: "1.0"
  category: transactions
  subcategory: core
  description: "Transfer fails with insufficient balance"
  priority: P0

preconditions:
  - sender:
      address: "tos1sender..."
      balance: 50000000  # 0.5 TOS
      nonce: 0

action:
  type: transaction
  tx_type: Transfers
  params:
    transfers:
      - asset: "0x0000...0000"
        destination: "tos1receiver..."
        amount: 100000000  # 1 TOS (more than available)
    fee: 7500
    nonce: 0

expected:
  status: error
  error: "InsufficientBalance"

postconditions:
  - sender:
      balance: 50000000  # Unchanged
      nonce: 0  # Unchanged on rejection

---
spec:
  name: tx_transfer_invalid_nonce
  version: "1.0"
  category: transactions
  subcategory: core
  description: "Transfer fails with wrong nonce"
  priority: P0

preconditions:
  - sender:
      address: "tos1sender..."
      balance: 200000000
      nonce: 5

action:
  type: transaction
  tx_type: Transfers
  params:
    transfers:
      - asset: "0x0000...0000"
        destination: "tos1receiver..."
        amount: 100000000
    fee: 7500
    nonce: 6  # Wrong nonce (should be 5)

expected:
  status: error
  error: "InvalidNonce"

postconditions:
  - sender:
      nonce: 5  # Unchanged

---
spec:
  name: tx_transfer_self_transfer
  version: "1.0"
  category: transactions
  subcategory: core
  description: "Self-transfer is allowed (no-op for balance)"
  priority: P1

preconditions:
  - sender:
      address: "tos1sender..."
      balance: 200000000
      nonce: 0

action:
  type: transaction
  tx_type: Transfers
  params:
    transfers:
      - asset: "0x0000...0000"
        destination: "tos1sender..."  # Same as sender
        amount: 100000000
    fee: 7500
    nonce: 0

expected:
  status: success
  note: "Self-transfers are allowed; balance net change is zero minus fee"

postconditions:
  - sender:
      balance: 199992500  # Only fee deducted
      nonce: 1

---
spec:
  name: tx_transfer_zero_amount
  version: "1.0"
  category: transactions
  subcategory: core
  description: "Zero-amount transfer behavior"
  priority: P1

preconditions:
  - sender:
      address: "tos1sender..."
      balance: 100000000
      nonce: 0

action:
  type: transaction
  tx_type: Transfers
  params:
    transfers:
      - asset: "0x0000...0000"
        destination: "tos1receiver..."
        amount: 0
    fee: 7500
    nonce: 0

expected:
  status: success
  note: "Zero-amount transfers are valid (fee still charged)"

---
spec:
  name: tx_transfer_new_account_creation
  version: "1.0"
  category: transactions
  subcategory: core
  description: "Transfer to non-existent account creates it"
  priority: P0

preconditions:
  - sender:
      address: "tos1sender..."
      balance: 200000000
      nonce: 0
  - receiver:
      address: "tos1newaccount..."
      exists: false

action:
  type: transaction
  tx_type: Transfers
  params:
    transfers:
      - asset: "0x0000...0000"
        destination: "tos1newaccount..."
        amount: 100000000
    fee: 7500
    nonce: 0

expected:
  status: success

postconditions:
  - receiver:
      address: "tos1newaccount..."
      exists: true
      balance: 100000000
      nonce: 0

---
spec:
  name: tx_transfer_with_energy_fee
  version: "1.0"
  category: transactions
  subcategory: core
  description: "Transfer using energy instead of TOS fee"
  priority: P0

preconditions:
  - sender:
      address: "tos1sender..."
      balance: 200000000
      energy: 10
      nonce: 0

action:
  type: transaction
  tx_type: Transfers
  params:
    transfers:
      - asset: "0x0000...0000"
        destination: "tos1receiver..."
        amount: 100000000
    fee: 0
    fee_type: Energy
    nonce: 0

expected:
  status: success
  energy_consumed: 1  # ENERGY_PER_TRANSFER

postconditions:
  - sender:
      balance: 100000000  # No TOS fee deducted
      energy: 9  # 10 - 1
      nonce: 1

---
spec:
  name: tx_transfer_insufficient_energy
  version: "1.0"
  category: transactions
  subcategory: core
  description: "Energy transfer fails without sufficient energy"
  priority: P0

preconditions:
  - sender:
      address: "tos1sender..."
      balance: 200000000
      energy: 0
      nonce: 0

action:
  type: transaction
  tx_type: Transfers
  params:
    transfers:
      - asset: "0x0000...0000"
        destination: "tos1receiver..."
        amount: 100000000
    fee_type: Energy
    nonce: 0

expected:
  status: error
  error: "InsufficientEnergy"

---
spec:
  name: tx_transfer_max_batch
  version: "1.0"
  category: transactions
  subcategory: core
  description: "Maximum batch transfer (500 outputs)"
  priority: P1

preconditions:
  - sender:
      address: "tos1sender..."
      balance: 100000000000  # 1000 TOS
      nonce: 0

action:
  type: transaction
  tx_type: Transfers
  params:
    transfers_count: 500  # MAX_TRANSFER_COUNT
    transfer_amount: 100000000  # 1 TOS each
    nonce: 0

expected:
  status: success

---
spec:
  name: tx_transfer_exceed_max_batch
  version: "1.0"
  category: transactions
  subcategory: core
  description: "Batch exceeding MAX_TRANSFER_COUNT rejected"
  priority: P0

preconditions:
  - sender:
      balance: 100000000000
      nonce: 0

action:
  type: transaction
  tx_type: Transfers
  params:
    transfers_count: 501  # Exceeds MAX_TRANSFER_COUNT
    nonce: 0

expected:
  status: error
  error: "InvalidSize"

---
spec:
  name: tx_transfer_memo_too_large
  version: "1.0"
  category: transactions
  subcategory: core
  description: "Extra data exceeding limit rejected"
  priority: P1

preconditions:
  - sender:
      balance: 200000000
      nonce: 0

action:
  type: transaction
  tx_type: Transfers
  params:
    transfers:
      - asset: "0x0000...0000"
        destination: "tos1receiver..."
        amount: 100000000
        extra_data_size: 129  # Exceeds EXTRA_DATA_LIMIT_SIZE (128)
    nonce: 0

expected:
  status: error
  error: "ExtraDataTooLarge"

---
spec:
  name: tx_transfer_custom_asset
  version: "1.0"
  category: transactions
  subcategory: core
  description: "Transfer of custom token asset"
  priority: P1

preconditions:
  - sender:
      address: "tos1sender..."
      balances:
        "0x0000...0000": 100000000  # TOS
        "0xabc1...2345": 50000000   # Custom token
      nonce: 0

action:
  type: transaction
  tx_type: Transfers
  params:
    transfers:
      - asset: "0xabc1...2345"  # Custom token
        destination: "tos1receiver..."
        amount: 20000000
    fee: 7500
    fee_type: TOS  # Fee always in TOS
    nonce: 0

expected:
  status: success

postconditions:
  - sender:
      balances:
        "0x0000...0000": 99992500  # TOS minus fee
        "0xabc1...2345": 30000000  # Token minus transfer
  - receiver:
      balances:
        "0xabc1...2345": 20000000

---
spec:
  name: tx_transfer_payload_structure
  version: "1.0"
  category: transactions
  subcategory: core
  description: "TransferPayload wire format"
  priority: P0

definition:
  transfer_payload:
    asset:
      type: Hash
      size: 32
    destination:
      type: CompressedPublicKey
      size: 32
    amount:
      type: u64
      size: 8
    extra_data:
      type: "Option<Vec<u8>>"
      size: "1 + 0..128"

serialization_order:
  - asset (32 bytes)
  - destination (32 bytes)
  - amount (8 bytes)
  - extra_data (option flag + data)

---
spec:
  name: tx_transfer_overflow_protection
  version: "1.0"
  category: transactions
  subcategory: core
  description: "Balance overflow protection"
  priority: P0

preconditions:
  - sender:
      balance: 100000000
  - receiver:
      balance: 18446744073709551615  # u64::MAX

action:
  type: transaction
  tx_type: Transfers
  params:
    transfers:
      - destination: "tos1receiver..."
        amount: 1  # Would overflow

expected:
  status: error
  error: "BalanceOverflow"
