# TOS TAKO Cross-Program Invocation (CPI) Syscalls Conformance Specifications
# Based on: daemon/src/tako_integration/loader.rs, executor.rs
#
# TAKO uses invoke syscall for cross-program invocation (CPI)
# Recursive CPI to same contract is prevented (no re-entrancy)
# MAX_CALL_DEPTH = 64 (executor.rs:71)

---
spec:
  name: syscall_invoke_basic
  version: "1.0"
  category: syscalls
  subcategory: call
  description: "Basic cross-program invocation (CPI)"
  priority: P0

preconditions:
  - caller_contract: "contract_a_hash"
  - target_contract:
      hash: "contract_b_hash"
      deployed: true

action:
  type: syscall
  name: invoke
  params:
    target: "contract_b_hash"  # &[u8; 32]
    input: "0xabcdef..."       # &[u8] - call data

expected:
  status: success
  result:
    return_code: 0  # u32 - success
    output: "Vec<u8>"  # return data
  compute_units: 10000  # ~10000+ CU base

---
spec:
  name: syscall_invoke_with_return_data
  version: "1.0"
  category: syscalls
  subcategory: call
  description: "CPI with return data from callee"
  priority: P0

preconditions:
  - target_contract:
      hash: "contract_b_hash"
      returns: "0x123456..."

action:
  type: syscall
  name: invoke
  params:
    target: "contract_b_hash"
    input: "0x..."

expected:
  status: success
  result:
    return_code: 0
    output: "0x123456..."

---
spec:
  name: syscall_invoke_nonexistent_contract
  version: "1.0"
  category: syscalls
  subcategory: call
  description: "CPI to non-existent contract fails"
  priority: P0

preconditions:
  - contract_not_exists: "unknown_hash..."

action:
  type: syscall
  name: invoke
  params:
    target: "unknown_hash..."
    input: "0x..."

expected:
  status: error
  error: "ContractNotFound"

---
spec:
  name: syscall_invoke_reentrancy_blocked
  version: "1.0"
  category: syscalls
  subcategory: call
  description: "Re-entrant CPI to same contract is blocked"
  priority: P0

preconditions:
  - current_contract: "contract_a_hash"

action:
  type: syscall
  name: invoke
  params:
    target: "contract_a_hash"  # Same as caller
    input: "0x..."

expected:
  status: error
  error: "ReentrantCallProhibited"
  note: "TAKO prevents recursive CPI to same contract"

---
spec:
  name: syscall_invoke_call_depth_limit
  version: "1.0"
  category: syscalls
  subcategory: call
  description: "CPI fails when MAX_CALL_DEPTH (64) exceeded"
  priority: P0

preconditions:
  - current_call_depth: 64

action:
  type: syscall
  name: invoke
  params:
    target: "some_contract_hash"
    input: "0x..."

expected:
  status: error
  error: "CallDepthExceeded"
  max_call_depth: 64

---
spec:
  name: syscall_invoke_callee_error
  version: "1.0"
  category: syscalls
  subcategory: call
  description: "CPI returns error code when callee fails"
  priority: P0

preconditions:
  - target_contract:
      hash: "failing_contract_hash"
      will_fail: true

action:
  type: syscall
  name: invoke
  params:
    target: "failing_contract_hash"
    input: "0x..."

expected:
  status: success  # invoke itself succeeds
  result:
    return_code: 1  # Non-zero indicates error
    output: "0x..."  # Error message

---
spec:
  name: syscall_invoke_compute_budget
  version: "1.0"
  category: syscalls
  subcategory: call
  description: "CPI consumes compute units from caller's budget"
  priority: P1

preconditions:
  - caller_compute_budget: 100000
  - target_compute_usage: 50000

action:
  type: syscall
  name: invoke
  params:
    target: "compute_heavy_contract"
    input: "0x..."

expected:
  status: success
  compute_units_consumed: ">= 50000"
  caller_budget_remaining: "<= 50000"

---
spec:
  name: syscall_invoke_insufficient_compute
  version: "1.0"
  category: syscalls
  subcategory: call
  description: "CPI fails when compute budget exhausted"
  priority: P1

preconditions:
  - caller_compute_budget: 1000
  - target_requires: 10000

action:
  type: syscall
  name: invoke
  params:
    target: "compute_heavy_contract"
    input: "0x..."

expected:
  status: error
  error: "ComputeBudgetExceeded"

---
spec:
  name: syscall_invoke_state_isolation
  version: "1.0"
  category: syscalls
  subcategory: call
  description: "CPI maintains storage isolation between contracts"
  priority: P0

preconditions:
  - caller_storage:
      key: "0x01"
      value: "0xaaa"
  - callee_storage:
      key: "0x01"
      value: "0xbbb"

action:
  type: syscall
  name: invoke
  params:
    target: "callee_contract"
    input: "0x..."  # Callee reads storage key 0x01

expected:
  status: success
  callee_sees: "0xbbb"  # Callee's own storage

postconditions:
  - caller_storage:
      key: "0x01"
      value: "0xaaa"  # Unchanged
