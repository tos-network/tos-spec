# TOS TAKO Transfer Syscalls Conformance Specifications
# Based on: daemon/src/tako_integration/accounts.rs
#
# TAKO uses transfer syscall for balance transfers
# Transfers queued as ContractOutput::Transfer, applied post-execution
# Integer overflow protection using checked/saturating arithmetic

---
spec:
  name: syscall_transfer_basic
  version: "1.0"
  category: syscalls
  subcategory: balance
  description: "Basic balance transfer between accounts"
  priority: P0

preconditions:
  - account_from:
      address: "tos1alice..."
      balance: 100000000  # 1 TOS
  - account_to:
      address: "tos1bob..."
      balance: 50000000  # 0.5 TOS

action:
  type: syscall
  name: transfer
  params:
    from: "tos1alice..."  # &[u8; 32]
    to: "tos1bob..."      # &[u8; 32]
    amount: 10000000      # 0.1 TOS

expected:
  status: success
  compute_units: 5000  # ~5000 CU

postconditions:
  - account:
      address: "tos1alice..."
      balance: 90000000  # 1 - 0.1 TOS
  - account:
      address: "tos1bob..."
      balance: 60000000  # 0.5 + 0.1 TOS

---
spec:
  name: syscall_transfer_insufficient_balance
  version: "1.0"
  category: syscalls
  subcategory: balance
  description: "Transfer fails with insufficient balance"
  priority: P0

preconditions:
  - account_from:
      address: "tos1alice..."
      balance: 10000000  # 0.1 TOS
  - account_to:
      address: "tos1bob..."
      balance: 0

action:
  type: syscall
  name: transfer
  params:
    from: "tos1alice..."
    to: "tos1bob..."
    amount: 20000000  # 0.2 TOS (more than available)

expected:
  status: error
  error: "InsufficientBalance"

postconditions:
  - account:
      address: "tos1alice..."
      balance: 10000000  # Unchanged
  - account:
      address: "tos1bob..."
      balance: 0  # Unchanged

---
spec:
  name: syscall_transfer_zero_amount
  version: "1.0"
  category: syscalls
  subcategory: balance
  description: "Zero-amount transfer is a no-op (EVM-compatible)"
  priority: P1

preconditions:
  - account:
      address: "tos1alice..."
      balance: 100000000

action:
  type: syscall
  name: transfer
  params:
    from: "tos1alice..."
    to: "tos1bob..."
    amount: 0

expected:
  status: success
  note: "Zero-amount transfers are no-ops for EVM compatibility"

postconditions:
  - account:
      address: "tos1alice..."
      balance: 100000000  # Unchanged

---
spec:
  name: syscall_transfer_self
  version: "1.0"
  category: syscalls
  subcategory: balance
  description: "Self-transfer (from == to) is rejected"
  priority: P0

preconditions:
  - account:
      address: "tos1alice..."
      balance: 100000000

action:
  type: syscall
  name: transfer
  params:
    from: "tos1alice..."
    to: "tos1alice..."  # Same address
    amount: 10000000

expected:
  status: error
  error: "SenderIsReceiver"

postconditions:
  - account:
      address: "tos1alice..."
      balance: 100000000  # Unchanged

---
spec:
  name: syscall_transfer_queued
  version: "1.0"
  category: syscalls
  subcategory: balance
  description: "Transfers queued as ContractOutput, applied post-execution"
  priority: P1

preconditions:
  - contract_executing: true
  - account_from:
      address: "tos1alice..."
      balance: 100000000

action:
  type: syscall_sequence
  calls:
    - name: transfer
      params: { from: "tos1alice...", to: "tos1bob...", amount: 10000000 }
    - name: get_balance
      params: { address: "tos1alice..." }

expected:
  - status: success
  - status: success
    result: 90000000  # Virtual balance reflects pending transfer

---
spec:
  name: syscall_transfer_overflow_protection
  version: "1.0"
  category: syscalls
  subcategory: balance
  description: "Transfer uses checked arithmetic to prevent overflow"
  priority: P1

preconditions:
  - account_from:
      address: "tos1alice..."
      balance: 100000000
  - account_to:
      address: "tos1bob..."
      balance: 18446744073709551615  # u64::MAX

action:
  type: syscall
  name: transfer
  params:
    from: "tos1alice..."
    to: "tos1bob..."
    amount: 1  # Would overflow

expected:
  status: error
  error: "BalanceOverflow"

---
spec:
  name: syscall_transfer_with_asset
  version: "1.0"
  category: syscalls
  subcategory: balance
  description: "Transfer specific asset (not native TOS)"
  priority: P2

preconditions:
  - account_from:
      address: "tos1alice..."
      balances:
        token_abc: 50000000

action:
  type: syscall
  name: transfer
  params:
    from: "tos1alice..."
    to: "tos1bob..."
    amount: 10000000
    asset: "token_abc_hash"

expected:
  status: success
  compute_units: 5000

postconditions:
  - account:
      address: "tos1alice..."
      balances:
        token_abc: 40000000
