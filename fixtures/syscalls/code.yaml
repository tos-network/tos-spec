# TOS TAKO Code Operations Syscalls Conformance Specifications
# Based on: daemon/src/tako_integration/loader.rs
#
# TAKO uses get_external_code_* syscalls for contract inspection
# All contracts must be TOS Kernel(TAKO) ELF format
# ELF magic validation: bytecode must start with 0x7F 'E' 'L' 'F'

---
spec:
  name: syscall_get_external_code_size
  version: "1.0"
  category: syscalls
  subcategory: code
  description: "Get bytecode size of external contract"
  priority: P0

preconditions:
  - external_contract:
      hash: "contract_hash_abc..."  # 32-byte Hash
      bytecode_size: 1024

action:
  type: syscall
  name: get_external_code_size
  params:
    contract: "contract_hash_abc..."  # &[u8; 32]

expected:
  status: success
  result: 1024  # u64
  compute_units: 1000  # ~1000 CU

---
spec:
  name: syscall_get_external_code_size_nonexistent
  version: "1.0"
  category: syscalls
  subcategory: code
  description: "Code size of non-existent contract returns 0"
  priority: P0

preconditions:
  - contract_not_exists: "unknown_hash..."

action:
  type: syscall
  name: get_external_code_size
  params:
    contract: "unknown_hash..."

expected:
  status: success
  result: 0  # Non-existent contracts have zero size
  compute_units: 1000

---
spec:
  name: syscall_get_external_code_hash
  version: "1.0"
  category: syscalls
  subcategory: code
  description: "Get BLAKE3 hash of external contract bytecode"
  priority: P0

preconditions:
  - external_contract:
      hash: "contract_hash_abc..."
      bytecode: "0x7f454c46..."  # ELF bytecode

action:
  type: syscall
  name: get_external_code_hash
  params:
    contract: "contract_hash_abc..."

expected:
  status: success
  result: "[u8; 32]"  # BLAKE3 hash of bytecode (NOT keccak256)
  compute_units: 1500  # ~1500 CU

---
spec:
  name: syscall_get_external_code_copy
  version: "1.0"
  category: syscalls
  subcategory: code
  description: "Copy portion of external contract bytecode"
  priority: P0

preconditions:
  - external_contract:
      hash: "contract_hash_abc..."
      bytecode_size: 1024

action:
  type: syscall
  name: get_external_code_copy
  params:
    contract: "contract_hash_abc..."  # &[u8; 32]
    offset: 0                         # u64
    size: 32                          # u64

expected:
  status: success
  result: "Vec<u8>"  # 32 bytes of bytecode
  compute_units: 2000  # ~2000 CU

---
spec:
  name: syscall_get_external_code_copy_partial
  version: "1.0"
  category: syscalls
  subcategory: code
  description: "Copy beyond bytecode returns shorter result"
  priority: P1

preconditions:
  - external_contract:
      hash: "contract_hash_abc..."
      bytecode_size: 10

action:
  type: syscall
  name: get_external_code_copy
  params:
    contract: "contract_hash_abc..."
    offset: 0
    size: 100  # Requesting more than available

expected:
  status: success
  result_length: 10  # Returns only available bytes

---
spec:
  name: syscall_code_elf_validation
  version: "1.0"
  category: syscalls
  subcategory: code
  description: "Contract bytecode must be valid ELF format"
  priority: P0

preconditions:
  - contract_bytecode: "0x7f454c46..."  # ELF magic: 0x7F 'E' 'L' 'F'

action:
  type: validate_contract
  bytecode: "0x7f454c46..."

expected:
  status: success
  elf_magic_valid: true

---
spec:
  name: syscall_code_reject_non_elf
  version: "1.0"
  category: syscalls
  subcategory: code
  description: "Non-ELF bytecode is rejected"
  priority: P0

preconditions:
  - invalid_bytecode: "0xdeadbeef..."  # Not ELF magic

action:
  type: deploy_contract
  bytecode: "0xdeadbeef..."

expected:
  status: error
  error: "InvalidElfFormat"

---
spec:
  name: syscall_code_reject_legacy_format
  version: "1.0"
  category: syscalls
  subcategory: code
  description: "Legacy contract format is rejected"
  priority: P1

preconditions:
  - legacy_bytecode: "0x6080604052..."  # EVM-style bytecode

action:
  type: deploy_contract
  bytecode: "0x6080604052..."

expected:
  status: error
  error: "LegacyFormatNotSupported"
