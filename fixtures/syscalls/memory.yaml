# TOS TAKO Memory and Storage Syscalls Conformance Specifications
# Based on: daemon/src/tako_integration/executor.rs, loader.rs
#           daemon/src/config.rs (HEAP_SIZE, STACK_SIZE)
#
# TAKO Memory Model:
# - Heap: 32 KB (HEAP_SIZE = 32768)
# - Stack: 256 KB (STACK_SIZE = 262144, 4 KB per frame Ã— 64 max depth)
# - Permanent storage: sload/sstore (persists across transactions)
# - Transient storage: tload/tstore (EIP-1153, cleared after transaction)

---
spec:
  name: syscall_sload_basic
  version: "1.0"
  category: syscalls
  subcategory: memory
  description: "Permanent storage load (sload)"
  priority: P0

preconditions:
  - contract:
      hash: "contract_hash"
      storage:
        key: "0x0000000000000000000000000000000000000000000000000000000000000001"
        value: "0x0000000000000000000000000000000000000000000000000000000000000042"

action:
  type: syscall
  name: sload
  syscall_id: "0x10"
  params:
    key: "0x0000000000000000000000000000000000000000000000000000000000000001"

expected:
  status: success
  result: "0x0000000000000000000000000000000000000000000000000000000000000042"
  compute_units: 1000  # ~1000 CU for storage read
  note: "Permanent storage read, persists across transactions"

---
spec:
  name: syscall_sload_uninitialized
  version: "1.0"
  category: syscalls
  subcategory: memory
  description: "Load from uninitialized storage returns zero"
  priority: P0

preconditions:
  - storage_key_not_set: true

action:
  type: syscall
  name: sload
  syscall_id: "0x10"
  params:
    key: "0x0000000000000000000000000000000000000000000000000000000000000099"

expected:
  status: success
  result: "0x0000000000000000000000000000000000000000000000000000000000000000"
  compute_units: 1000
  note: "Uninitialized storage slots return zero"

---
spec:
  name: syscall_sstore_basic
  version: "1.0"
  category: syscalls
  subcategory: memory
  description: "Permanent storage write (sstore)"
  priority: P0

preconditions:
  - contract:
      hash: "contract_hash"

action:
  type: syscall
  name: sstore
  syscall_id: "0x11"
  params:
    key: "0x0000000000000000000000000000000000000000000000000000000000000001"
    value: "0x0000000000000000000000000000000000000000000000000000000000000042"

expected:
  status: success
  compute_units: 5000  # ~5000 CU for storage write
  note: "Permanent storage write, persists after transaction"

postconditions:
  - storage:
      key: "0x0000000000000000000000000000000000000000000000000000000000000001"
      value: "0x0000000000000000000000000000000000000000000000000000000000000042"

---
spec:
  name: syscall_sstore_update
  version: "1.0"
  category: syscalls
  subcategory: memory
  description: "Update existing storage value"
  priority: P1

preconditions:
  - storage:
      key: "0x01"
      value: "0xold_value"

action:
  type: syscall
  name: sstore
  syscall_id: "0x11"
  params:
    key: "0x01"
    value: "0xnew_value"

expected:
  status: success
  compute_units: 5000
  note: "Update costs same as initial write"

postconditions:
  - storage:
      key: "0x01"
      value: "0xnew_value"

---
spec:
  name: syscall_sstore_clear
  version: "1.0"
  category: syscalls
  subcategory: memory
  description: "Clear storage by setting to zero"
  priority: P1

preconditions:
  - storage:
      key: "0x01"
      value: "0x42"

action:
  type: syscall
  name: sstore
  syscall_id: "0x11"
  params:
    key: "0x01"
    value: "0x0000000000000000000000000000000000000000000000000000000000000000"

expected:
  status: success
  compute_units: 5000
  note: "Clearing storage may provide gas refund in some cases"

postconditions:
  - storage:
      key: "0x01"
      value: "0x0000000000000000000000000000000000000000000000000000000000000000"

---
spec:
  name: syscall_tload_basic
  version: "1.0"
  category: syscalls
  subcategory: memory
  description: "Transient storage load (tload, EIP-1153)"
  priority: P0

preconditions:
  - transient_storage:
      key: "0x01"
      value: "0x42"

action:
  type: syscall
  name: tload
  syscall_id: "0x12"
  params:
    key: "0x0000000000000000000000000000000000000000000000000000000000000001"

expected:
  status: success
  result: "0x0000000000000000000000000000000000000000000000000000000000000042"
  compute_units: 100  # Much cheaper than sload
  note: "Transient storage is per-transaction, cleared after TX"

---
spec:
  name: syscall_tstore_basic
  version: "1.0"
  category: syscalls
  subcategory: memory
  description: "Transient storage write (tstore, EIP-1153)"
  priority: P0

preconditions:
  - contract_executing: true

action:
  type: syscall
  name: tstore
  syscall_id: "0x13"
  params:
    key: "0x0000000000000000000000000000000000000000000000000000000000000001"
    value: "0x0000000000000000000000000000000000000000000000000000000000000042"

expected:
  status: success
  compute_units: 100  # Much cheaper than sstore
  note: "Transient storage write, cleared after transaction ends"

postconditions:
  - transient_storage:
      key: "0x01"
      value: "0x42"

---
spec:
  name: syscall_tstore_cleared_after_tx
  version: "1.0"
  category: syscalls
  subcategory: memory
  description: "Transient storage is cleared after transaction"
  priority: P0

preconditions:
  - previous_transaction_set:
      transient_key: "0x01"
      transient_value: "0x42"

action:
  type: new_transaction
  sequence:
    - syscall:
        name: tload
        params:
          key: "0x01"

expected:
  status: success
  result: "0x0000000000000000000000000000000000000000000000000000000000000000"
  note: "Transient storage from previous TX is not visible"

---
spec:
  name: memory_heap_limit
  version: "1.0"
  category: syscalls
  subcategory: memory
  description: "Heap allocation limited to HEAP_SIZE (32 KB)"
  priority: P0

preconditions:
  - HEAP_SIZE: 32768  # 32 KB
  - allocation_request: 65536  # 64 KB

action:
  type: heap_allocate
  size: 65536

expected:
  status: error
  error: "HeapExhausted"
  note: "Heap allocation cannot exceed 32 KB"

---
spec:
  name: memory_stack_limit
  version: "1.0"
  category: syscalls
  subcategory: memory
  description: "Stack limited to STACK_SIZE (256 KB)"
  priority: P0

preconditions:
  - STACK_SIZE: 262144  # 256 KB
  - STACK_PER_FRAME: 4096  # 4 KB per call frame
  - MAX_CALL_DEPTH: 64

action:
  type: deep_recursion
  depth: 100  # Exceeds MAX_CALL_DEPTH

expected:
  status: error
  error: "CallDepthExceeded"
  max_call_depth: 64
  note: "Stack overflow prevented by call depth limit"

---
spec:
  name: memory_get_input_data
  version: "1.0"
  category: syscalls
  subcategory: memory
  description: "Get call input data into memory"
  priority: P0

preconditions:
  - call_input: "0xabcdef123456..."

action:
  type: syscall
  name: get_input_data
  params:
    offset: 0
    length: 32

expected:
  status: success
  data_in_memory: "0xabcdef123456..."
  note: "Input data copied to contract memory"

---
spec:
  name: memory_input_data_bounded
  version: "1.0"
  category: syscalls
  subcategory: memory
  description: "Input data size bounded to 1 MB"
  priority: P1

preconditions:
  - MAX_INPUT_SIZE: 1048576  # 1 MB
  - call_input_size: 2000000  # 2 MB

action:
  type: contract_call
  input_size: 2000000

expected:
  status: error
  error: "InputTooLarge"
  note: "DoS protection: input data limited to 1 MB"

---
spec:
  name: storage_isolation_between_contracts
  version: "1.0"
  category: syscalls
  subcategory: memory
  description: "Storage is isolated between contracts"
  priority: P0

preconditions:
  - contract_a:
      storage:
        key: "0x01"
        value: "0xaaa"
  - contract_b:
      storage:
        key: "0x01"
        value: "0xbbb"

action:
  type: contract_call
  from: "contract_a"
  to: "contract_b"
  method: "read_storage_key_01"

expected:
  status: success
  contract_b_reads: "0xbbb"
  contract_a_storage_unchanged: "0xaaa"
  note: "Each contract has isolated storage namespace"

---
spec:
  name: transient_storage_shared_in_tx
  version: "1.0"
  category: syscalls
  subcategory: memory
  description: "Transient storage visible across CPI within same TX"
  priority: P1

preconditions:
  - contract_a_executing: true

action:
  type: sequence
  steps:
    - contract_a_tstore:
        key: "0x01"
        value: "0x42"
    - contract_a_calls_contract_b: true
    - contract_b_tload:
        key: "0x01"

expected:
  contract_b_sees: "0x0000000000000000000000000000000000000000000000000000000000000000"
  note: "Transient storage is per-contract, not shared across CPI"
