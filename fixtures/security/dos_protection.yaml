# TOS DoS Protection Conformance Specifications
# Based on: daemon/src/config.rs, daemon/src/tako_integration/executor.rs
#
# TOS DoS protection mechanisms:
# - Compute budget limits (not gas)
# - MAX_CALL_DEPTH = 64
# - MAX_BLOCK_SIZE = 1.25 MB
# - MAX_TXS_PER_BLOCK = 10,000
# - Memory limits: HEAP_SIZE = 32 KB, STACK_SIZE = 256 KB

---
spec:
  name: security_dos_compute_budget_limit
  version: "1.0"
  category: security
  subcategory: dos_protection
  description: "Compute budget limits prevent infinite loops"
  priority: P0

preconditions:
  - DEFAULT_COMPUTE_BUDGET: 200000
  - MAX_COMPUTE_BUDGET: 10000000
  - malicious_contract:
      has_infinite_loop: true

action:
  type: execute_contract
  contract: "malicious_contract"
  method: "infinite_loop"
  compute_budget: 200000

expected:
  status: error
  error: "ComputeBudgetExceeded"
  compute_units_used: 200000

---
spec:
  name: security_dos_call_depth_limit
  version: "1.0"
  category: security
  subcategory: dos_protection
  description: "MAX_CALL_DEPTH (64) prevents stack overflow"
  priority: P0

preconditions:
  - MAX_CALL_DEPTH: 64
  - recursive_contract:
      recursion_depth: 100

action:
  type: execute_contract
  contract: "recursive_contract"
  method: "recurse"
  params:
    depth: 100

expected:
  status: error
  error: "CallDepthExceeded"
  max_depth: 64

---
spec:
  name: security_dos_block_size_limit
  version: "1.0"
  category: security
  subcategory: dos_protection
  description: "MAX_BLOCK_SIZE (1.25 MB) limits block size"
  priority: P0

preconditions:
  - MAX_BLOCK_SIZE: 1310720  # 1.25 MB
  - oversized_block:
      size: 2000000  # 2 MB

action:
  type: validate_block
  block: "oversized_block"

expected:
  status: error
  error: "InvalidBlockSize"
  error_message: "Block size is {actual} while limit is {limit}"

---
spec:
  name: security_dos_txs_per_block_limit
  version: "1.0"
  category: security
  subcategory: dos_protection
  description: "MAX_TXS_PER_BLOCK (10,000) limits transaction count"
  priority: P0

preconditions:
  - MAX_TXS_PER_BLOCK: 10000
  - block_with_too_many_txs:
      tx_count: 15000

action:
  type: validate_block
  block: "block_with_too_many_txs"

expected:
  status: error
  error: "InvalidBlockTxs"
  error_message: "Invalid TX count in block"

---
spec:
  name: security_dos_heap_memory_limit
  version: "1.0"
  category: security
  subcategory: dos_protection
  description: "HEAP_SIZE (32 KB) limits contract memory allocation"
  priority: P0

preconditions:
  - HEAP_SIZE: 32768  # 32 KB
  - contract_memory_request: 1048576  # 1 MB

action:
  type: execute_contract
  contract: "memory_hungry_contract"
  method: "allocate_memory"
  params:
    size: 1048576

expected:
  status: error
  error: "HeapExhausted"
  max_heap: 32768

---
spec:
  name: security_dos_stack_size_limit
  version: "1.0"
  category: security
  subcategory: dos_protection
  description: "STACK_SIZE (256 KB) limits call stack"
  priority: P1

preconditions:
  - STACK_SIZE: 262144  # 256 KB
  - deep_call_stack: true

action:
  type: execute_contract
  contract: "deep_stack_contract"

expected:
  status: error
  error: "StackOverflow"

---
spec:
  name: security_dos_bytecode_limit
  version: "1.0"
  category: security
  subcategory: dos_protection
  description: "LOADED_DATA_LIMIT (128 KB) limits bytecode per tx"
  priority: P1

preconditions:
  - LOADED_DATA_LIMIT: 131072  # 128 KB
  - large_contract:
      bytecode_size: 200000  # 200 KB

action:
  type: execute_contract
  contract: "large_contract"

expected:
  status: error
  error: "BytecodeTooLarge"

---
spec:
  name: security_dos_transaction_size_limit
  version: "1.0"
  category: security
  subcategory: dos_protection
  description: "MAX_TRANSACTION_SIZE (1 MB) limits tx size"
  priority: P0

preconditions:
  - MAX_TRANSACTION_SIZE: 1048576  # 1 MB
  - oversized_transaction:
      size: 2000000  # 2 MB

action:
  type: submit_transaction
  transaction: "oversized_transaction"

expected:
  status: error
  error: "TxTooBig"
  error_message: "Transaction size is {actual} while limit is {limit}"

---
spec:
  name: security_dos_peer_timeout
  version: "1.0"
  category: security
  subcategory: dos_protection
  description: "P2P_PING_TIMEOUT prevents hanging connections"
  priority: P1

preconditions:
  - P2P_PING_TIMEOUT: 60  # 60 seconds
  - unresponsive_peer: true

action:
  type: peer_connection
  peer: "unresponsive_peer"
  wait_seconds: 70

expected:
  status: disconnected
  reason: "ping_timeout"

---
spec:
  name: security_dos_mempool_limit
  version: "1.0"
  category: security
  subcategory: dos_protection
  description: "Mempool size limits prevent memory exhaustion"
  priority: P1

preconditions:
  - mempool_max_size: 10000

action:
  type: flood_mempool
  transaction_count: 20000

expected:
  status: partial_accept
  accepted: "<= 10000"
  rejected_reason: "mempool_full"
