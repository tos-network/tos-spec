# TOS Reentrancy Protection Conformance Specifications
# Based on: daemon/src/tako_integration/loader.rs
#
# TAKO blocks re-entrant CPI to same contract at protocol level
# MAX_CALL_DEPTH = 64 prevents deep recursion
# Error: ReentrantCallProhibited

---
spec:
  name: security_reentrancy_blocked_protocol
  version: "1.0"
  category: security
  subcategory: reentrancy
  description: "TAKO prevents re-entrant calls at protocol level"
  priority: P0

preconditions:
  - contract_a:
      hash: "contract_a_hash"
      executing: true

action:
  type: syscall
  name: invoke
  from_contract: "contract_a_hash"
  params:
    target: "contract_a_hash"  # Same contract
    input: "0x..."

expected:
  status: error
  error: "ReentrantCallProhibited"
  note: "TAKO blocks CPI to currently executing contract"

---
spec:
  name: security_reentrancy_different_contracts_allowed
  version: "1.0"
  category: security
  subcategory: reentrancy
  description: "CPI to different contract is allowed"
  priority: P0

preconditions:
  - contract_a:
      hash: "contract_a_hash"
      executing: true
  - contract_b:
      hash: "contract_b_hash"
      deployed: true

action:
  type: syscall
  name: invoke
  from_contract: "contract_a_hash"
  params:
    target: "contract_b_hash"  # Different contract
    input: "0x..."

expected:
  status: success
  note: "Different contract CPI is allowed"

---
spec:
  name: security_reentrancy_call_depth_limit
  version: "1.0"
  category: security
  subcategory: reentrancy
  description: "MAX_CALL_DEPTH (64) prevents deep recursion"
  priority: P0

preconditions:
  - current_call_depth: 64

action:
  type: syscall
  name: invoke
  params:
    target: "any_contract"
    input: "0x..."

expected:
  status: error
  error: "CallDepthExceeded"
  max_call_depth: 64

---
spec:
  name: security_reentrancy_cross_contract_chain
  version: "1.0"
  category: security
  subcategory: reentrancy
  description: "A -> B -> A call chain is blocked"
  priority: P0

preconditions:
  - call_chain: ["contract_a", "contract_b"]
  - contract_b_tries_to_call: "contract_a"

action:
  type: execute_contract
  contract: "contract_b"
  input: "call_contract_a"

expected:
  status: error
  error: "ReentrantCallProhibited"
  note: "contract_a is already in the call stack"

---
spec:
  name: security_reentrancy_state_consistency
  version: "1.0"
  category: security
  subcategory: reentrancy
  description: "Failed CPI does not affect caller state"
  priority: P0

preconditions:
  - contract_a:
      hash: "contract_a_hash"
      storage:
        key: "0x01"
        value: "0xoriginal"

action:
  type: execute_contract
  contract: "contract_a_hash"
  sequence:
    - write_storage: { key: "0x01", value: "0xmodified" }
    - invoke_self_fails: true  # Reentrancy blocked

expected:
  status: error
  error: "ReentrantCallProhibited"

postconditions:
  - storage:
      key: "0x01"
      value: "0xoriginal"  # Rolled back

---
spec:
  name: security_reentrancy_vs_delegatecall
  version: "1.0"
  category: security
  subcategory: reentrancy
  description: "TAKO does not have delegatecall (unlike EVM)"
  priority: P1

preconditions:
  - tako_vm: true

action:
  type: syscall
  name: delegatecall
  params:
    target: "library_contract"

expected:
  status: error
  error: "SyscallNotFound"
  note: "TAKO uses invoke (CPI), not delegatecall"
