# TOS WebSocket Events Conformance Specifications
# Based on: common/src/api/daemon/mod.rs, daemon/src/rpc/mod.rs
#
# WebSocket events use JSON-RPC 2.0 notification format:
# {"jsonrpc": "2.0", "method": "on_{event_name}", "params": {...}}
#
# TOS uses "subscribe" method (NOT eth_subscribe)

---
spec:
  name: ws_subscribe_new_block
  version: "1.0"
  category: api
  subcategory: websocket
  description: "Subscribe to new block events"
  priority: P0

preconditions:
  - websocket_connected: true

action:
  type: ws_subscribe
  method: subscribe
  params:
    notify: NewBlock

expected:
  status: success
  notification:
    method: "on_new_block"
    params:
      hash: "Hash"
      topoheight: "u64"
      height: "u64"
      timestamp: "u64"
      miner: "CompressedPublicKey"
      tips: "Vec<Hash>"
      txs_hashes: "Vec<Hash>"

---
spec:
  name: ws_subscribe_block_ordered
  version: "1.0"
  category: api
  subcategory: websocket
  description: "Subscribe to block ordering events"
  priority: P0

preconditions:
  - websocket_connected: true

action:
  type: ws_subscribe
  method: subscribe
  params:
    notify: BlockOrdered

expected:
  status: success
  notification:
    method: "on_block_ordered"
    params:
      block_hash: "Hash"
      topoheight: "u64"

---
spec:
  name: ws_subscribe_block_orphaned
  version: "1.0"
  category: api
  subcategory: websocket
  description: "Subscribe to block orphaning events (DAG reorg)"
  priority: P0

preconditions:
  - websocket_connected: true

action:
  type: ws_subscribe
  method: subscribe
  params:
    notify: BlockOrphaned

expected:
  status: success
  notification:
    method: "on_block_orphaned"
    params:
      block_hash: "Hash"
      old_topoheight: "u64"

---
spec:
  name: ws_subscribe_transaction_mempool
  version: "1.0"
  category: api
  subcategory: websocket
  description: "Subscribe to mempool transaction events"
  priority: P0

preconditions:
  - websocket_connected: true

action:
  type: ws_subscribe
  method: subscribe
  params:
    notify: TransactionAddedInMempool

expected:
  status: success
  notification:
    method: "on_transaction_added_in_mempool"
    params:
      hash: "Hash"
      source: "CompressedPublicKey"
      fee: "u64"
      nonce: "u64"

---
spec:
  name: ws_subscribe_transaction_executed
  version: "1.0"
  category: api
  subcategory: websocket
  description: "Subscribe to transaction execution events"
  priority: P0

preconditions:
  - websocket_connected: true

action:
  type: ws_subscribe
  method: subscribe
  params:
    notify: TransactionExecuted

expected:
  status: success
  notification:
    method: "on_transaction_executed"
    params:
      tx_hash: "Hash"
      block_hash: "Hash"
      topoheight: "u64"

---
spec:
  name: ws_subscribe_transaction_orphaned
  version: "1.0"
  category: api
  subcategory: websocket
  description: "Subscribe to transaction orphaning events"
  priority: P1

preconditions:
  - websocket_connected: true

action:
  type: ws_subscribe
  method: subscribe
  params:
    notify: TransactionOrphaned

expected:
  status: success
  notification:
    method: "on_transaction_orphaned"
    params:
      tx_hash: "Hash"

---
spec:
  name: ws_subscribe_stable_height
  version: "1.0"
  category: api
  subcategory: websocket
  description: "Subscribe to stable height changes"
  priority: P0

preconditions:
  - websocket_connected: true

action:
  type: ws_subscribe
  method: subscribe
  params:
    notify: StableHeightChanged

expected:
  status: success
  notification:
    method: "on_stable_height_changed"
    params:
      previous_stable_height: "u64"
      new_stable_height: "u64"

---
spec:
  name: ws_subscribe_stable_topoheight
  version: "1.0"
  category: api
  subcategory: websocket
  description: "Subscribe to stable topoheight changes"
  priority: P0

preconditions:
  - websocket_connected: true

action:
  type: ws_subscribe
  method: subscribe
  params:
    notify: StableTopoHeightChanged

expected:
  status: success
  notification:
    method: "on_stable_topoheight_changed"
    params:
      previous_stable_topoheight: "u64"
      new_stable_topoheight: "u64"

---
spec:
  name: ws_subscribe_peer_connected
  version: "1.0"
  category: api
  subcategory: websocket
  description: "Subscribe to peer connection events"
  priority: P1

preconditions:
  - websocket_connected: true

action:
  type: ws_subscribe
  method: subscribe
  params:
    notify: PeerConnected

expected:
  status: success
  notification:
    method: "on_peer_connected"
    params:
      peer_id: "u64"
      peer_addr: "SocketAddr"

---
spec:
  name: ws_subscribe_peer_disconnected
  version: "1.0"
  category: api
  subcategory: websocket
  description: "Subscribe to peer disconnection events"
  priority: P1

preconditions:
  - websocket_connected: true

action:
  type: ws_subscribe
  method: subscribe
  params:
    notify: PeerDisconnected

expected:
  status: success
  notification:
    method: "on_peer_disconnected"
    params:
      peer_id: "u64"

---
spec:
  name: ws_subscribe_contract_event
  version: "1.0"
  category: api
  subcategory: websocket
  description: "Subscribe to contract events"
  priority: P1

preconditions:
  - websocket_connected: true
  - contract_hash: "contract123..."

action:
  type: ws_subscribe
  method: subscribe
  params:
    notify: ContractEvent
    contract: "contract123..."
    id: 0  # Optional event ID filter

expected:
  status: success
  notification:
    method: "on_contract_event"
    params:
      contract: "Hash"
      event_id: "u64"
      topoheight: "u64"
      data: "Value"

---
spec:
  name: ws_subscribe_new_asset
  version: "1.0"
  category: api
  subcategory: websocket
  description: "Subscribe to new asset events"
  priority: P2

preconditions:
  - websocket_connected: true

action:
  type: ws_subscribe
  method: subscribe
  params:
    notify: NewAsset

expected:
  status: success
  notification:
    method: "on_new_asset"
    params:
      asset: "Hash"
      topoheight: "u64"

---
spec:
  name: ws_unsubscribe
  version: "1.0"
  category: api
  subcategory: websocket
  description: "Unsubscribe from event"
  priority: P0

preconditions:
  - websocket_connected: true
  - subscribed_to: NewBlock

action:
  type: ws_call
  method: unsubscribe
  params:
    notify: NewBlock

expected:
  status: success
  result: true

postconditions:
  - subscription_active: false

---
spec:
  name: ws_connection_keepalive
  version: "1.0"
  category: api
  subcategory: websocket
  description: "WebSocket connection stays alive with ping/pong"
  priority: P1

preconditions:
  - websocket_connected: true

action:
  type: ws_ping
  interval: 30

expected:
  status: success
  connection: "alive"
  pong_received: true
