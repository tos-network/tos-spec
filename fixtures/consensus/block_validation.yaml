# TOS Block Validation Conformance Specifications
# Based on: daemon/src/core/blockchain.rs, daemon/src/core/error.rs
#
# TOS uses BlockDAG with TIPS (up to 3 parent blocks), NOT single previous_hash
# TIPS_LIMIT = 3 (common/src/config.rs:148)
# TIMESTAMP_IN_FUTURE_LIMIT = 2 seconds (daemon/src/config.rs:93)

---
spec:
  name: consensus_block_valid_dag
  version: "1.0"
  category: consensus
  subcategory: block
  description: "Valid block with DAG tips is accepted"
  priority: P0

preconditions:
  - existing_tips: ["tip1_hash", "tip2_hash"]
  - tips_height: 100
  - TIPS_LIMIT: 3

action:
  type: validate_block
  block:
    version: "Nobunaga"
    height: 101
    tips: ["tip1_hash", "tip2_hash"]  # DAG parents (1-3 tips)
    timestamp: 1700000000000  # Milliseconds
    miner: "tos1..."
    extra_nonce: "0x..."
    txs_hashes: []

expected:
  status: success

---
spec:
  name: consensus_block_invalid_no_tips
  version: "1.0"
  category: consensus
  subcategory: block
  description: "Block with no tips (except genesis) is rejected"
  priority: P0

preconditions:
  - chain_height: 100

action:
  type: validate_block
  block:
    height: 101
    tips: []  # Empty tips not allowed

expected:
  status: error
  error: "ExpectedTips"
  error_message: "expected at least one tip"

---
spec:
  name: consensus_block_invalid_tips_count
  version: "1.0"
  category: consensus
  subcategory: block
  description: "Block with more than TIPS_LIMIT tips is rejected"
  priority: P0

preconditions:
  - TIPS_LIMIT: 3
  - existing_blocks: ["tip1", "tip2", "tip3", "tip4"]

action:
  type: validate_block
  block:
    height: 101
    tips: ["tip1", "tip2", "tip3", "tip4"]  # 4 tips > TIPS_LIMIT

expected:
  status: error
  error: "InvalidTipsCount"
  error_message: "Block {hash} has invalid tips count: 4"

---
spec:
  name: consensus_block_invalid_tip_not_found
  version: "1.0"
  category: consensus
  subcategory: block
  description: "Block with unknown tip is rejected"
  priority: P0

preconditions:
  - existing_tips: ["tip1_hash"]

action:
  type: validate_block
  block:
    height: 101
    tips: ["tip1_hash", "unknown_hash"]

expected:
  status: error
  error: "InvalidTipsNotFound"
  error_message: "Block {hash} has an invalid tip {unknown_hash} which is not present in chain"

---
spec:
  name: consensus_block_invalid_height
  version: "1.0"
  category: consensus
  subcategory: block
  description: "Block with height not matching tips is rejected"
  priority: P0

preconditions:
  - tip_block:
      hash: "tip_hash"
      height: 100

action:
  type: validate_block
  block:
    height: 99  # Should be 101 (tip_height + 1)
    tips: ["tip_hash"]

expected:
  status: error
  error: "InvalidBlockHeight"
  error_message: "Block height mismatch, expected {expected}, got 99"

---
spec:
  name: consensus_block_invalid_height_stable
  version: "1.0"
  category: consensus
  subcategory: block
  description: "Block with height in stable range is rejected"
  priority: P0

preconditions:
  - current_height: 100
  - stable_height: 76  # 100 - STABLE_LIMIT(24)

action:
  type: validate_block
  block:
    height: 75  # In stable range
    tips: ["some_old_tip"]

expected:
  status: error
  error: "InvalidBlockHeightStableHeight"
  error_message: "Block height is in stable height which is not allowed"

---
spec:
  name: consensus_block_invalid_timestamp_future
  version: "1.0"
  category: consensus
  subcategory: block
  description: "Block with timestamp >2 seconds in future is rejected"
  priority: P0

preconditions:
  - current_time_ms: 1700000000000
  - TIMESTAMP_IN_FUTURE_LIMIT: 2000  # 2 seconds in ms

action:
  type: validate_block
  block:
    height: 101
    tips: ["tip_hash"]
    timestamp: 1700000003000  # 3 seconds in future

expected:
  status: error
  error: "TimestampIsInFuture"
  error_message: "Timestamp {block_ts} is greater than current time {current_ts}"

---
spec:
  name: consensus_block_invalid_timestamp_past
  version: "1.0"
  category: consensus
  subcategory: block
  description: "Block with timestamp less than parent is rejected"
  priority: P0

preconditions:
  - parent_block:
      hash: "parent_hash"
      timestamp: 1700000000000

action:
  type: validate_block
  block:
    height: 101
    tips: ["parent_hash"]
    timestamp: 1699999999000  # Before parent

expected:
  status: error
  error: "TimestampIsLessThanParent"
  error_message: "Timestamp is less than parent: {parent_ts}"

---
spec:
  name: consensus_block_invalid_difficulty
  version: "1.0"
  category: consensus
  subcategory: block
  description: "Block with invalid proof-of-work difficulty is rejected"
  priority: P0

preconditions:
  - expected_difficulty: 100000
  - pow_algorithm: "Xelishash_V2"

action:
  type: validate_block
  block:
    height: 101
    nonce: 12345
    extra_nonce: "0x..."

expected:
  status: error
  error: "InvalidDifficulty"
  error_message: "Invalid difficulty"

---
spec:
  name: consensus_block_invalid_tips_difficulty
  version: "1.0"
  category: consensus
  subcategory: block
  description: "Block must reference tips with highest cumulative difficulty"
  priority: P1

preconditions:
  - available_tips:
      - tip_a:
          hash: "tip_a_hash"
          cumulative_difficulty: 500000
      - tip_b:
          hash: "tip_b_hash"
          cumulative_difficulty: 300000

action:
  type: validate_block
  block:
    height: 101
    tips: ["tip_b_hash"]  # Chose lower difficulty tip

expected:
  status: error
  error: "InvalidTipsDifficulty"
  error_message: "Block {hash} has invalid tips difficulty: {tip_b_hash}"

---
spec:
  name: consensus_block_size_limit
  version: "1.0"
  category: consensus
  subcategory: block
  description: "Block exceeding MAX_BLOCK_SIZE is rejected"
  priority: P0

preconditions:
  - MAX_BLOCK_SIZE: 1310720  # 1.25 MB

action:
  type: validate_block
  block:
    size_bytes: 1400000  # > 1.25 MB

expected:
  status: error
  error: "InvalidBlockSize"
  error_message: "Block size is {actual} while limit is {limit}"

---
spec:
  name: consensus_nonce_sequential
  version: "1.0"
  category: consensus
  subcategory: block
  description: "Transactions in block must have sequential nonces per sender"
  priority: P0

preconditions:
  - account:
      address: "tos1..."
      nonce: 0

action:
  type: execute_block
  block:
    transactions:
      - from: "tos1..."
        nonce: 0
      - from: "tos1..."
        nonce: 1
      - from: "tos1..."
        nonce: 2

expected:
  status: success

postconditions:
  - account:
      address: "tos1..."
      nonce: 3

---
spec:
  name: consensus_nonce_gap_rejected
  version: "1.0"
  category: consensus
  subcategory: block
  description: "Transaction with nonce gap is orphaned"
  priority: P0

preconditions:
  - account:
      address: "tos1..."
      nonce: 0

action:
  type: validate_transaction_in_block
  transaction:
    from: "tos1..."
    nonce: 2  # Gap: should be 0

expected:
  status: orphaned
  error: "InvalidTransactionNonce"
  fee_deducted: false  # Nonce validation fails = no fee

---
spec:
  name: consensus_block_version
  version: "1.0"
  category: consensus
  subcategory: block
  description: "Block version must be valid for current height"
  priority: P1

preconditions:
  - hard_fork_at_height_0: "Nobunaga"

action:
  type: validate_block
  block:
    version: "InvalidVersion"
    height: 101

expected:
  status: error
  error: "InvalidBlockVersion"
  error_message: "Invalid block version"
