# TOS Fork Choice Conformance Specifications
# Based on: daemon/src/core/blockchain.rs, daemon/src/core/blockdag.rs
#
# TOS BlockDAG uses cumulative difficulty for chain selection
# TopoHeight provides total ordering of blocks
# Multiple tips are allowed (up to TIPS_LIMIT = 3)

---
spec:
  name: consensus_fork_choice_cumulative_difficulty
  version: "1.0"
  category: consensus
  subcategory: fork_choice
  description: "Select tip with highest cumulative difficulty"
  priority: P0

preconditions:
  - tip_a:
      hash: "tip_a_hash"
      height: 100
      cumulative_difficulty: 1000000
  - tip_b:
      hash: "tip_b_hash"
      height: 95
      cumulative_difficulty: 900000

action:
  type: fork_choice
  available_tips: ["tip_a", "tip_b"]

expected:
  status: success
  best_tip: "tip_a"
  reason: "highest_cumulative_difficulty"

---
spec:
  name: consensus_fork_choice_same_height_different_difficulty
  version: "1.0"
  category: consensus
  subcategory: fork_choice
  description: "At same height, prefer higher cumulative difficulty"
  priority: P0

preconditions:
  - tip_a:
      hash: "tip_a_hash"
      height: 100
      cumulative_difficulty: 1000000
  - tip_b:
      hash: "tip_b_hash"
      height: 100
      cumulative_difficulty: 1100000

action:
  type: fork_choice
  available_tips: ["tip_a", "tip_b"]

expected:
  status: success
  best_tip: "tip_b"
  reason: "higher_cumulative_difficulty_at_same_height"

---
spec:
  name: consensus_fork_choice_tie_breaker_hash
  version: "1.0"
  category: consensus
  subcategory: fork_choice
  description: "Tie-break by block hash when difficulty equal"
  priority: P1

preconditions:
  - tip_a:
      hash: "abc123def456..."  # Higher hash
      height: 100
      cumulative_difficulty: 1000000
  - tip_b:
      hash: "123abc456def..."  # Lower hash
      height: 100
      cumulative_difficulty: 1000000

action:
  type: fork_choice
  available_tips: ["tip_a", "tip_b"]

expected:
  status: success
  best_tip: "tip_b"  # Lower hash wins
  reason: "hash_tiebreaker"

---
spec:
  name: consensus_fork_choice_invalid_tip_rejected
  version: "1.0"
  category: consensus
  subcategory: fork_choice
  description: "Invalid blocks are never selected as tips"
  priority: P0

preconditions:
  - tip_a:
      hash: "tip_a_hash"
      height: 100
      cumulative_difficulty: 1000000
      valid: true
  - tip_b:
      hash: "tip_b_hash"
      height: 150
      cumulative_difficulty: 2000000
      valid: false
      invalid_reason: "InvalidDifficulty"

action:
  type: fork_choice
  available_tips: ["tip_a", "tip_b"]

expected:
  status: success
  best_tip: "tip_a"
  reason: "only_valid_tip"

---
spec:
  name: consensus_fork_choice_dag_multiple_tips
  version: "1.0"
  category: consensus
  subcategory: fork_choice
  description: "DAG can maintain multiple valid tips simultaneously"
  priority: P0

preconditions:
  - TIPS_LIMIT: 3
  - tips:
      - tip_a: { hash: "a", height: 100, cumulative_difficulty: 1000000 }
      - tip_b: { hash: "b", height: 100, cumulative_difficulty: 999000 }
      - tip_c: { hash: "c", height: 99, cumulative_difficulty: 990000 }

action:
  type: get_tips

expected:
  status: success
  tips_count: 3
  best_tip: "tip_a"
  all_tips: ["tip_a", "tip_b", "tip_c"]

---
spec:
  name: consensus_fork_choice_topoheight_ordering
  version: "1.0"
  category: consensus
  subcategory: fork_choice
  description: "TopoHeight provides total ordering for execution"
  priority: P0

preconditions:
  - dag_blocks:
      - block_a: { hash: "a", height: 10, cumulative_difficulty: 500 }
      - block_b: { hash: "b", height: 10, cumulative_difficulty: 600 }
      - block_c: { hash: "c", height: 11, tips: ["a", "b"] }

action:
  type: compute_topoheight_order

expected:
  status: success
  execution_order:
    - block: "a"
      topoheight: 10
    - block: "b"
      topoheight: 11  # Same height but lower CD
    - block: "c"
      topoheight: 12

---
spec:
  name: consensus_fork_choice_reorg_deeper_than_stable
  version: "1.0"
  category: consensus
  subcategory: fork_choice
  description: "Cannot reorg past STABLE_LIMIT depth"
  priority: P0

preconditions:
  - current_height: 100
  - stable_height: 76  # 100 - STABLE_LIMIT(24)
  - competing_chain:
      fork_point_height: 70  # Before stable height
      tip_height: 105
      cumulative_difficulty: 2000000

action:
  type: attempt_reorg
  competing_chain: "competing_chain"

expected:
  status: reject
  reason: "fork_point_in_stable_zone"
  stable_blocks_unchanged: true

---
spec:
  name: consensus_fork_choice_lower_difficulty_rejected
  version: "1.0"
  category: consensus
  subcategory: fork_choice
  description: "Chain with lower cumulative difficulty is rejected"
  priority: P0

preconditions:
  - current_chain:
      tip_hash: "current_tip"
      cumulative_difficulty: 1000000
  - competing_chain:
      tip_hash: "competing_tip"
      cumulative_difficulty: 900000  # Lower

action:
  type: attempt_reorg
  competing_chain: "competing_chain"

expected:
  status: reject
  error: "LowerCumulativeDifficulty"
  reason: "Chain has too low cumulative difficulty"

---
spec:
  name: consensus_fork_choice_block_deviation
  version: "1.0"
  category: consensus
  subcategory: fork_choice
  description: "Block that deviates too much from tips is rejected"
  priority: P1

preconditions:
  - current_tips_height: 100
  - max_deviation: 10  # Hypothetical limit

action:
  type: validate_block
  block:
    height: 85  # Too far behind tips
    tips: ["old_tip"]

expected:
  status: error
  error: "BlockDeviation"
  error_message: "Block has too much deviated"

---
spec:
  name: consensus_fork_choice_non_reachability
  version: "1.0"
  category: consensus
  subcategory: fork_choice
  description: "Block tips must not be ancestors of each other"
  priority: P1

preconditions:
  - block_a:
      hash: "a"
      height: 90
  - block_b:
      hash: "b"
      height: 95
      ancestor_of: "a"  # b is ancestor of a

action:
  type: validate_block
  block:
    height: 96
    tips: ["a", "b"]  # Invalid: one is ancestor of the other

expected:
  status: error
  error: "InvalidReachability"
  error_message: "Block has invalid reachability"
