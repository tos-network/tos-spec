# TOS Transaction Ordering Conformance Specifications
# Based on: daemon/src/core/blockchain.rs, daemon/src/core/mempool.rs
#
# TOS uses fee-based ordering (NOT gas_price)
# Transactions from same sender must be ordered by nonce
# FEE_PER_KB = 10000, FEE_PER_TRANSFER = 5000 (common/src/config.rs)

---
spec:
  name: consensus_tx_ordering_by_nonce
  version: "1.0"
  category: consensus
  subcategory: transaction_ordering
  description: "Transactions from same sender ordered by nonce"
  priority: P0

preconditions:
  - sender: "tos1alice..."
  - account_nonce: 0
  - mempool_transactions:
      - tx1: { nonce: 2, fee: 10000 }
      - tx2: { nonce: 0, fee: 10000 }
      - tx3: { nonce: 1, fee: 10000 }

action:
  type: block_assembly
  include_transactions: ["tx1", "tx2", "tx3"]

expected:
  status: success
  execution_order: ["tx2", "tx3", "tx1"]  # Ordered by nonce: 0, 1, 2

---
spec:
  name: consensus_tx_ordering_by_fee
  version: "1.0"
  category: consensus
  subcategory: transaction_ordering
  description: "Transactions from different senders ordered by fee (highest first)"
  priority: P0

preconditions:
  - mempool_transactions:
      - tx_alice: { sender: "tos1alice...", nonce: 0, fee: 10000 }
      - tx_bob: { sender: "tos1bob...", nonce: 0, fee: 20000 }
      - tx_charlie: { sender: "tos1charlie...", nonce: 0, fee: 15000 }

action:
  type: block_assembly
  include_transactions: ["tx_alice", "tx_bob", "tx_charlie"]

expected:
  status: success
  execution_order: ["tx_bob", "tx_charlie", "tx_alice"]  # Ordered by fee: 20000, 15000, 10000

---
spec:
  name: consensus_tx_ordering_nonce_gap_deferred
  version: "1.0"
  category: consensus
  subcategory: transaction_ordering
  description: "Transaction with nonce gap is deferred in mempool"
  priority: P0

preconditions:
  - sender: "tos1alice..."
  - account_nonce: 0
  - mempool_transactions:
      - tx1: { nonce: 0, fee: 10000 }
      - tx2: { nonce: 2, fee: 20000 }  # Gap: nonce 1 missing

action:
  type: block_assembly
  include_transactions: ["tx1", "tx2"]

expected:
  status: success
  included: ["tx1"]
  deferred: ["tx2"]  # Cannot execute until nonce 1 arrives

---
spec:
  name: consensus_tx_ordering_insufficient_balance
  version: "1.0"
  category: consensus
  subcategory: transaction_ordering
  description: "Transaction with insufficient balance for fee+amount is skipped"
  priority: P0

preconditions:
  - sender: "tos1alice..."
  - balance: 100000000  # 1 TOS (10^8 atomic units)
  - mempool_transactions:
      - tx1: { nonce: 0, amount: 50000000, fee: 10000 }
      - tx2: { nonce: 1, amount: 50000000, fee: 10000 }
      - tx3: { nonce: 2, amount: 50000000, fee: 10000 }

action:
  type: block_assembly
  include_transactions: ["tx1", "tx2", "tx3"]

expected:
  status: success
  included: ["tx1"]
  skipped_reason:
    tx2: "insufficient_balance"
    tx3: "nonce_depends_on_skipped"

---
spec:
  name: consensus_tx_ordering_block_size_limit
  version: "1.0"
  category: consensus
  subcategory: transaction_ordering
  description: "Block size limit respected in transaction ordering"
  priority: P0

preconditions:
  - MAX_BLOCK_SIZE: 1310720  # 1.25 MB
  - mempool_transactions:
      - tx1: { sender: "tos1alice...", size: 600000, fee: 100000 }
      - tx2: { sender: "tos1bob...", size: 600000, fee: 90000 }
      - tx3: { sender: "tos1charlie...", size: 300000, fee: 80000 }

action:
  type: block_assembly
  include_transactions: ["tx1", "tx2", "tx3"]

expected:
  status: success
  included: ["tx1", "tx3"]  # tx2 doesn't fit (600000 + 600000 > remaining space)
  total_size: "<= 1310720"

---
spec:
  name: consensus_tx_ordering_fee_replacement
  version: "1.0"
  category: consensus
  subcategory: transaction_ordering
  description: "Transaction with same nonce but higher fee replaces in mempool"
  priority: P1

preconditions:
  - sender: "tos1alice..."
  - mempool_state:
      - existing_tx: { nonce: 0, fee: 10000, hash: "tx_old" }
  - new_transaction:
      nonce: 0
      fee: 15000  # Higher fee
      hash: "tx_new"

action:
  type: submit_transaction
  transaction: "new_transaction"

expected:
  status: success
  replaced: "tx_old"
  new_mempool_state:
    - tx: { nonce: 0, fee: 15000, hash: "tx_new" }

---
spec:
  name: consensus_tx_ordering_fee_too_low_rejected
  version: "1.0"
  category: consensus
  subcategory: transaction_ordering
  description: "Replacement transaction with lower/equal fee is rejected"
  priority: P1

preconditions:
  - sender: "tos1alice..."
  - mempool_state:
      - existing_tx: { nonce: 0, fee: 10000, hash: "tx_old" }
  - new_transaction:
      nonce: 0
      fee: 10000  # Same fee
      hash: "tx_new"

action:
  type: submit_transaction
  transaction: "new_transaction"

expected:
  status: error
  error: "FeesToLowToOverride"
  error_message: "Fee too low to override"
  mempool_unchanged: true

---
spec:
  name: consensus_tx_ordering_already_in_mempool
  version: "1.0"
  category: consensus
  subcategory: transaction_ordering
  description: "Duplicate transaction (same hash) is rejected"
  priority: P0

preconditions:
  - mempool_state:
      - existing_tx: { hash: "tx_hash_abc", nonce: 0 }

action:
  type: submit_transaction
  transaction:
    hash: "tx_hash_abc"  # Same hash
    nonce: 0

expected:
  status: error
  error: "TxAlreadyInMempool"
  error_message: "TX already in mempool"

---
spec:
  name: consensus_tx_ordering_already_in_blockchain
  version: "1.0"
  category: consensus
  subcategory: transaction_ordering
  description: "Transaction already executed in blockchain is rejected"
  priority: P0

preconditions:
  - blockchain_state:
      - executed_tx: { hash: "tx_hash_def", nonce: 5 }

action:
  type: submit_transaction
  transaction:
    hash: "tx_hash_def"

expected:
  status: error
  error: "TxAlreadyInBlockchain"
  error_message: "TX already in blockchain"

---
spec:
  name: consensus_tx_ordering_max_txs_per_block
  version: "1.0"
  category: consensus
  subcategory: transaction_ordering
  description: "Block cannot exceed MAX_TXS_PER_BLOCK transactions"
  priority: P1

preconditions:
  - MAX_TXS_PER_BLOCK: 10000
  - mempool_size: 12000

action:
  type: block_assembly
  include_all: true

expected:
  status: success
  included_count: "<= 10000"
  deferred_count: ">= 2000"

---
spec:
  name: consensus_tx_ordering_energy_vs_fee
  version: "1.0"
  category: consensus
  subcategory: transaction_ordering
  description: "Transaction can use energy instead of fee"
  priority: P1

preconditions:
  - sender: "tos1alice..."
  - account_energy: 100
  - transaction:
      nonce: 0
      fee_type: "Energy"
      fee: 0  # No TOS fee, using energy

action:
  type: submit_transaction
  transaction: "transaction"

expected:
  status: success
  energy_consumed: 1  # ENERGY_PER_TRANSFER

postconditions:
  - account_energy: 99

---
spec:
  name: consensus_tx_ordering_multisig_fee
  version: "1.0"
  category: consensus
  subcategory: transaction_ordering
  description: "Multisig transactions include additional signature fees"
  priority: P2

preconditions:
  - FEE_PER_MULTISIG_SIGNATURE: 500
  - transaction:
      type: "Transfer"
      multisig_signatures: 3

action:
  type: calculate_fee
  transaction: "transaction"

expected:
  status: success
  base_fee: "FEE_PER_TRANSFER"
  signature_fee: 1500  # 3 * 500
  total_min_fee: "FEE_PER_TRANSFER + 1500"
