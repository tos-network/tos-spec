# TOS Block Limits Conformance Specifications
# Based on: common/src/config.rs
#
# Defines all block and transaction size limits for DoS protection

---
spec:
  name: block_limits_overview
  version: "1.0"
  category: models
  subcategory: limits
  description: "Block and transaction size limits"
  priority: P0

constants:
  # Size units
  BYTES_PER_KB: 1024

  # Block limits
  MAX_BLOCK_SIZE: 1310720  # 1.25 MB (1024*1024 + 256*1024)
  TIPS_LIMIT: 3
  MAX_TXS_PER_BLOCK: 10000

  # Transaction limits
  MAX_TRANSACTION_SIZE: 1048576  # 1 MB

---
spec:
  name: block_size_validation
  version: "1.0"
  category: models
  subcategory: limits
  description: "Block size must not exceed MAX_BLOCK_SIZE"
  priority: P0

rule: "block_size <= MAX_BLOCK_SIZE"

tests:
  - name: valid_block_size
    block_size: 1000000  # ~1 MB
    expected: valid

  - name: max_block_size
    block_size: 1310720  # Exactly 1.25 MB
    expected: valid

  - name: oversized_block
    block_size: 1310721  # 1.25 MB + 1
    expected: error
    error: "BlockTooLarge"

---
spec:
  name: tips_limit_validation
  version: "1.0"
  category: models
  subcategory: limits
  description: "Block must have 1-3 parent tips"
  priority: P0

rule: "1 <= tips.len() <= TIPS_LIMIT"

tests:
  - name: single_tip
    tips_count: 1
    expected: valid

  - name: three_tips_max
    tips_count: 3
    expected: valid

  - name: no_tips
    tips_count: 0
    expected: error
    error: "InvalidTipsCount"
    note: "Genesis block is exception"

  - name: too_many_tips
    tips_count: 4
    expected: error
    error: "TooManyTips"

---
spec:
  name: transaction_count_validation
  version: "1.0"
  category: models
  subcategory: limits
  description: "Block transaction count limit"
  priority: P0

rule: "txs_hashes.len() <= MAX_TXS_PER_BLOCK"

tests:
  - name: empty_block
    tx_count: 0
    expected: valid

  - name: max_transactions
    tx_count: 10000
    expected: valid

  - name: too_many_transactions
    tx_count: 10001
    expected: error
    error: "TooManyTransactions"

---
spec:
  name: transaction_size_validation
  version: "1.0"
  category: models
  subcategory: limits
  description: "Individual transaction size limit"
  priority: P0

rule: "tx_size <= MAX_TRANSACTION_SIZE"

tests:
  - name: small_transaction
    tx_size: 256
    expected: valid

  - name: max_transaction
    tx_size: 1048576  # 1 MB
    expected: valid

  - name: oversized_transaction
    tx_size: 1048577
    expected: error
    error: "TransactionTooLarge"

---
spec:
  name: transfer_count_limit
  version: "1.0"
  category: models
  subcategory: limits
  description: "Transfers per transaction limit"
  priority: P0

constant:
  MAX_TRANSFER_COUNT: 500

rule: "transfers.len() <= MAX_TRANSFER_COUNT"

tests:
  - name: single_transfer
    count: 1
    expected: valid

  - name: max_transfers
    count: 500
    expected: valid

  - name: too_many_transfers
    count: 501
    expected: error
    error: "InvalidSize"

---
spec:
  name: extra_data_limits
  version: "1.0"
  category: models
  subcategory: limits
  description: "Extra data (memo) size limits"
  priority: P0

constants:
  EXTRA_DATA_LIMIT_SIZE: 128  # Per transfer
  EXTRA_DATA_LIMIT_SUM_SIZE: 4096  # Per transaction (128 * 32)

tests:
  - name: valid_memo
    memo_size: 64
    expected: valid

  - name: max_memo
    memo_size: 128
    expected: valid

  - name: memo_too_large
    memo_size: 129
    expected: error
    error: "ExtraDataTooLarge"

---
spec:
  name: multisig_limits
  version: "1.0"
  category: models
  subcategory: limits
  description: "Multi-signature participant limits"
  priority: P0

constants:
  MAX_MULTISIG_PARTICIPANTS: 255
  MAX_DEPOSIT_PER_INVOKE_CALL: 255

tests:
  - name: valid_multisig
    participants: 5
    threshold: 3
    expected: valid

  - name: max_participants
    participants: 255
    threshold: 128
    expected: valid

  - name: too_many_participants
    participants: 256
    expected: error
    error: "TooManyParticipants"

---
spec:
  name: energy_system_limits
  version: "1.0"
  category: models
  subcategory: limits
  description: "Energy system operational limits"
  priority: P0

constants:
  MAX_FREEZE_RECORDS: 32
  MAX_PENDING_UNFREEZES: 32
  MAX_DELEGATEES: 500
  MIN_FREEZE_DURATION_DAYS: 3
  MAX_FREEZE_DURATION_DAYS: 365
  MIN_FREEZE_TOS_AMOUNT: 100000000  # 1 TOS
  MIN_UNFREEZE_TOS_AMOUNT: 100000000  # 1 TOS

---
spec:
  name: privacy_limits
  version: "1.0"
  category: models
  subcategory: limits
  description: "Privacy transaction limits"
  priority: P1

constants:
  MIN_SHIELD_TOS_AMOUNT: 10000000000  # 100 TOS (anti-money-laundering)

---
spec:
  name: static_assertions
  version: "1.0"
  category: models
  subcategory: limits
  description: "Compile-time invariants"
  priority: P0

assertions:
  - "MAX_TRANSACTION_SIZE <= MAX_BLOCK_SIZE"
  - "MAXIMUM_SUPPLY >= COIN_VALUE"
