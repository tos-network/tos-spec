# TOS Energy System Conformance Specifications
# Based on: common/src/account/energy.rs, common/src/config.rs
#
# Energy model for fee-free transfers through TOS staking

---
spec:
  name: energy_system_overview
  version: "1.0"
  category: models
  subcategory: energy
  description: "Energy system overview and calculation rules"
  priority: P0

definition:
  energy_resource:
    energy:
      type: u64
      description: "Available energy balance"
    freeze_records:
      type: "Vec<FreezeRecord>"
      max_length: 32
      description: "Self-freeze records"
    delegated_records:
      type: "Vec<DelegatedFreezeRecord>"
      max_length: 32
      description: "Delegation freeze records"
    pending_unfreezes:
      type: "Vec<PendingUnfreeze>"
      max_length: 32
      description: "Pending withdrawal records"
    leases:
      type: "Vec<EnergyLease>"
      description: "Energy received from delegators"

---
spec:
  name: energy_calculation_formula
  version: "1.0"
  category: models
  subcategory: energy
  description: "Energy gain calculation formula"
  priority: P0

definition:
  formula: "energy = (amount / COIN_VALUE) * (2 * days)"

examples:
  - input:
      amount: 100000000  # 1 TOS
      days: 3
    output:
      energy: 6

  - input:
      amount: 100000000  # 1 TOS
      days: 7
    output:
      energy: 14

  - input:
      amount: 100000000  # 1 TOS
      days: 30
    output:
      energy: 60

  - input:
      amount: 1000000000  # 10 TOS
      days: 30
    output:
      energy: 600

  - input:
      amount: 10000000000  # 100 TOS
      days: 365
    output:
      energy: 73000

---
spec:
  name: freeze_duration_validation
  version: "1.0"
  category: models
  subcategory: energy
  description: "FreezeDuration constraints"
  priority: P0

definition:
  freeze_duration:
    days:
      type: u32
      min: 3   # MIN_FREEZE_DURATION_DAYS
      max: 365 # MAX_FREEZE_DURATION_DAYS

tests:
  - name: valid_minimum_duration
    input: { days: 3 }
    expected: valid

  - name: valid_maximum_duration
    input: { days: 365 }
    expected: valid

  - name: invalid_below_minimum
    input: { days: 2 }
    expected: error
    error: "Freeze duration must be between 3 and 365 days"

  - name: invalid_above_maximum
    input: { days: 366 }
    expected: error
    error: "Freeze duration must be between 3 and 365 days"

---
spec:
  name: freeze_record_structure
  version: "1.0"
  category: models
  subcategory: energy
  description: "FreezeRecord structure definition"
  priority: P0

definition:
  freeze_record:
    amount:
      type: u64
      description: "Frozen TOS (whole units, min 1 TOS)"
    duration:
      type: FreezeDuration
      description: "Lock duration"
    freeze_topoheight:
      type: u64
      description: "When frozen (topoheight)"
    unlock_topoheight:
      type: u64
      description: "When unlockable (topoheight)"
    energy_gained:
      type: u64
      description: "Energy generated by this freeze"

serialization:
  - amount: 8 bytes (u64)
  - duration.days: 4 bytes (u32)
  - freeze_topoheight: 8 bytes (u64)
  - unlock_topoheight: 8 bytes (u64)
  - energy_gained: 8 bytes (u64)

---
spec:
  name: delegated_freeze_record_structure
  version: "1.0"
  category: models
  subcategory: energy
  description: "DelegatedFreezeRecord for batch delegation"
  priority: P0

definition:
  delegated_freeze_record:
    entries:
      type: "Vec<DelegateRecordEntry>"
      max_length: 500  # MAX_DELEGATEES
      description: "Individual delegatee entries"
    duration:
      type: FreezeDuration
      description: "Shared lock duration"
    freeze_topoheight:
      type: u64
    unlock_topoheight:
      type: u64
    total_amount:
      type: u64
      description: "Sum of all entry amounts"
    total_energy:
      type: u64
      description: "Sum of all entry energies"

  delegate_record_entry:
    delegatee:
      type: PublicKey
      size: 32
    amount:
      type: u64
      min: 100000000  # MIN_FREEZE_TOS_AMOUNT (1 TOS)
    energy:
      type: u64

---
spec:
  name: pending_unfreeze_structure
  version: "1.0"
  category: models
  subcategory: energy
  description: "PendingUnfreeze for two-phase withdrawal"
  priority: P0

definition:
  pending_unfreeze:
    amount:
      type: u64
      description: "TOS pending withdrawal (whole units)"
    expire_topoheight:
      type: u64
      description: "When withdrawal is allowed"

  cooldown_period:
    mainnet: "14 days (UNFREEZE_COOLDOWN_DAYS * 86400 blocks)"
    devnet: "14 * 10 blocks (accelerated)"

---
spec:
  name: energy_consumption_rate
  version: "1.0"
  category: models
  subcategory: energy
  description: "Energy consumption per transfer"
  priority: P0

definition:
  ENERGY_PER_TRANSFER: 1

usage:
  - "Each transfer output consumes 1 energy"
  - "Batch transfers consume N energy for N outputs"
  - "Energy-based fees only for Transfer-type transactions"

---
spec:
  name: energy_limits
  version: "1.0"
  category: models
  subcategory: energy
  description: "Energy system limits"
  priority: P0

constants:
  MIN_FREEZE_DURATION_DAYS: 3
  MAX_FREEZE_DURATION_DAYS: 365
  MIN_FREEZE_TOS_AMOUNT: 100000000  # 1 TOS
  MIN_UNFREEZE_TOS_AMOUNT: 100000000  # 1 TOS
  MAX_FREEZE_RECORDS: 32
  MAX_PENDING_UNFREEZES: 32
  MAX_DELEGATEES: 500
  UNFREEZE_COOLDOWN_DAYS: 14

---
spec:
  name: energy_operations_are_free
  version: "1.0"
  category: models
  subcategory: energy
  description: "All energy operations have zero fee"
  priority: P0

definition:
  free_operations:
    - FreezeTos
    - FreezeTosDelegate
    - UnfreezeTos
    - WithdrawUnfrozen

  fee: 0
  energy_cost: 0
  rationale: "Encourages staking participation and network security"

---
spec:
  name: unlock_topoheight_calculation
  version: "1.0"
  category: models
  subcategory: energy
  description: "Unlock topoheight calculation per network"
  priority: P0

formula:
  mainnet: "unlock = freeze_topoheight + (days * 86400)"
  devnet: "unlock = freeze_topoheight + (days * 10)"

examples:
  - network: mainnet
    freeze_topoheight: 1000000
    days: 7
    unlock_topoheight: 1604800  # 1000000 + 604800

  - network: devnet
    freeze_topoheight: 1000
    days: 7
    unlock_topoheight: 1070  # 1000 + 70

---
spec:
  name: energy_invariants
  version: "1.0"
  category: models
  subcategory: energy
  description: "Energy system invariants"
  priority: P0

invariants:
  - "freeze_records.len() <= MAX_FREEZE_RECORDS"
  - "delegated_records.len() <= MAX_FREEZE_RECORDS"
  - "pending_unfreezes.len() <= MAX_PENDING_UNFREEZES"
  - "total_frozen_tos <= account_balance (before freeze)"
  - "energy >= 0"
  - "Each delegatee amount >= MIN_FREEZE_TOS_AMOUNT"
  - "Delegator cannot delegate to self"
