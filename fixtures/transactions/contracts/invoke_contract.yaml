# TOS InvokeContract Transaction Conformance Specifications
# Based on: common/src/transaction/payload/contract/invoke.rs
#
# Call entry points on deployed smart contracts

---
spec:
  name: tx_invoke_contract_basic
  version: "1.0"
  category: transactions
  subcategory: contracts
  description: "Basic contract invocation"
  priority: P0

preconditions:
  - caller:
      address: "tos1caller..."
      balance: 500000000  # 5 TOS
      nonce: 0
  - contract:
      address: "0xcontract..."
      exists: true
      entry_points:
        - id: 0
          name: "transfer"

action:
  type: transaction
  tx_type: InvokeContract
  params:
    contract: "0xcontract..."
    entry_id: 0
    max_gas: 100000000  # 1 TOS
    deposits: []
    parameters: []
    fee: 100000000
    nonce: 0

expected:
  status: success
  gas_used: "<actual_gas>"

postconditions:
  - caller:
      nonce: 1

---
spec:
  name: tx_invoke_contract_with_deposit
  version: "1.0"
  category: transactions
  subcategory: contracts
  description: "Contract call with TOS deposit"
  priority: P0

preconditions:
  - caller:
      balance: 500000000
      nonce: 0
  - contract:
      address: "0xcontract..."
      balance: 0

action:
  type: transaction
  tx_type: InvokeContract
  params:
    contract: "0xcontract..."
    entry_id: 0
    max_gas: 50000000
    deposits:
      - asset: "0x0000...0000"
        amount: 100000000  # 1 TOS
    parameters: []
    fee: 50000000

expected:
  status: success

postconditions:
  - caller:
      balance: 350000000  # 5 - 0.5 gas - 1 deposit
  - contract:
      balance: 100000000  # Received deposit

---
spec:
  name: tx_invoke_contract_with_parameters
  version: "1.0"
  category: transactions
  subcategory: contracts
  description: "Contract call with typed parameters"
  priority: P0

preconditions:
  - caller:
      balance: 500000000
      nonce: 0
  - contract:
      address: "0xcontract..."
      entry_points:
        - id: 1
          name: "set_value"
          params: ["u64", "string"]

action:
  type: transaction
  tx_type: InvokeContract
  params:
    contract: "0xcontract..."
    entry_id: 1
    max_gas: 50000000
    deposits: []
    parameters:
      - type: u64
        value: 42
      - type: string
        value: "hello"
    fee: 50000000

expected:
  status: success

---
spec:
  name: tx_invoke_contract_nonexistent
  version: "1.0"
  category: transactions
  subcategory: contracts
  description: "Invoke non-existent contract fails"
  priority: P0

preconditions:
  - caller:
      balance: 500000000
      nonce: 0
  - contract:
      address: "0xnonexistent..."
      exists: false

action:
  type: transaction
  tx_type: InvokeContract
  params:
    contract: "0xnonexistent..."
    entry_id: 0
    max_gas: 50000000

expected:
  status: error
  error: "ContractNotFound"

---
spec:
  name: tx_invoke_contract_invalid_entry_point
  version: "1.0"
  category: transactions
  subcategory: contracts
  description: "Invoke invalid entry point fails"
  priority: P0

preconditions:
  - contract:
      address: "0xcontract..."
      entry_points:
        - id: 0
          name: "main"
      max_entry_id: 0

action:
  type: transaction
  tx_type: InvokeContract
  params:
    contract: "0xcontract..."
    entry_id: 99  # Invalid
    max_gas: 50000000

expected:
  status: error
  error: "InvalidEntryPoint"

---
spec:
  name: tx_invoke_contract_insufficient_gas
  version: "1.0"
  category: transactions
  subcategory: contracts
  description: "Execution stops when gas exhausted"
  priority: P0

preconditions:
  - caller:
      balance: 500000000
      nonce: 0
  - contract:
      address: "0xcontract..."
      entry_points:
        - id: 0
          name: "expensive_operation"
          estimated_gas: 100000000

action:
  type: transaction
  tx_type: InvokeContract
  params:
    contract: "0xcontract..."
    entry_id: 0
    max_gas: 1000  # Very low
    deposits: []

expected:
  status: success  # TX succeeds
  execution_result: "OutOfGas"  # But execution stopped
  gas_used: 1000

---
spec:
  name: tx_invoke_contract_max_gas_limit
  version: "1.0"
  category: transactions
  subcategory: contracts
  description: "max_gas cannot exceed MAX_GAS_USAGE_PER_TX"
  priority: P0

preconditions:
  - caller:
      balance: 100000000000  # 1000 TOS
      nonce: 0

action:
  type: transaction
  tx_type: InvokeContract
  params:
    contract: "0xcontract..."
    entry_id: 0
    max_gas: 1000000001  # > MAX_GAS_USAGE_PER_TX (10 TOS)

expected:
  status: error
  error: "GasLimitExceeded"

---
spec:
  name: tx_invoke_contract_multiple_deposits
  version: "1.0"
  category: transactions
  subcategory: contracts
  description: "Contract call with multiple asset deposits"
  priority: P1

preconditions:
  - caller:
      balances:
        "0x0000...0000": 500000000
        "0xtoken1...": 1000000000
        "0xtoken2...": 500000000
      nonce: 0

action:
  type: transaction
  tx_type: InvokeContract
  params:
    contract: "0xcontract..."
    entry_id: 0
    max_gas: 50000000
    deposits:
      - asset: "0x0000...0000"
        amount: 100000000
      - asset: "0xtoken1..."
        amount: 200000000
      - asset: "0xtoken2..."
        amount: 100000000

expected:
  status: success

postconditions:
  - contract:
      balances:
        "0x0000...0000": 100000000
        "0xtoken1...": 200000000
        "0xtoken2...": 100000000

---
spec:
  name: tx_invoke_contract_max_deposits
  version: "1.0"
  category: transactions
  subcategory: contracts
  description: "Maximum 255 deposits per invocation"
  priority: P1

definition:
  MAX_DEPOSIT_PER_INVOKE_CALL: 255

tests:
  - name: at_limit
    deposits_count: 255
    expected: valid

  - name: exceed_limit
    deposits_count: 256
    expected: error
    error: "TooManyDeposits"

---
spec:
  name: tx_invoke_contract_insufficient_deposit
  version: "1.0"
  category: transactions
  subcategory: contracts
  description: "Insufficient balance for deposit"
  priority: P0

preconditions:
  - caller:
      balance: 50000000  # 0.5 TOS
      nonce: 0

action:
  type: transaction
  tx_type: InvokeContract
  params:
    contract: "0xcontract..."
    entry_id: 0
    max_gas: 10000000
    deposits:
      - asset: "0x0000...0000"
        amount: 100000000  # 1 TOS (more than available after gas)

expected:
  status: error
  error: "InsufficientBalance"

---
spec:
  name: tx_invoke_contract_revert
  version: "1.0"
  category: transactions
  subcategory: contracts
  description: "Contract execution revert behavior"
  priority: P0

preconditions:
  - caller:
      balance: 500000000
      nonce: 0
  - contract:
      state:
        value: 100

action:
  type: transaction
  tx_type: InvokeContract
  params:
    contract: "0xcontract..."
    entry_id: 0  # Function that reverts
    max_gas: 100000000
    deposits:
      - asset: "0x0000...0000"
        amount: 100000000

expected:
  status: success  # TX included
  execution_result: "Reverted"
  gas_used: "<some_amount>"  # Gas consumed until revert

postconditions:
  - caller:
      nonce: 1  # Nonce incremented
      balance: "<original - gas_used>"  # Deposit refunded
  - contract:
      state:
        value: 100  # State unchanged

---
spec:
  name: tx_invoke_contract_gas_burn
  version: "1.0"
  category: transactions
  subcategory: contracts
  description: "30% of execution gas is burned"
  priority: P0

definition:
  TX_GAS_BURN_PERCENT: 30

example:
  gas_used: 100000000  # 1 TOS
  distribution:
    miner: 70000000  # 0.7 TOS
    burned: 30000000  # 0.3 TOS

---
spec:
  name: tx_invoke_contract_storage_fees
  version: "1.0"
  category: transactions
  subcategory: contracts
  description: "Storage operations have additional fees"
  priority: P1

constants:
  FEE_PER_STORE_CONTRACT: 100  # Per store operation
  FEE_PER_BYTE_STORED_CONTRACT: 5  # Per byte stored
  FEE_PER_BYTE_IN_CONTRACT_MEMORY: 1  # Per byte in memory
  FEE_PER_BYTE_OF_EVENT_DATA: 2  # Per byte of event

example:
  store_operation:
    key_size: 32
    value_size: 64
    fee: 100 + (32 + 64) * 5  # 100 + 480 = 580

---
spec:
  name: tx_invoke_contract_payload_structure
  version: "1.0"
  category: transactions
  subcategory: contracts
  description: "InvokeContractPayload wire format"
  priority: P0

definition:
  invoke_contract_payload:
    contract:
      type: Hash
      size: 32
      description: "Contract address (deployment tx hash)"
    deposits:
      type: Deposits
      description: "Asset deposits"
    entry_id:
      type: u16
      size: 2
    max_gas:
      type: u64
      size: 8
    parameters:
      type: "Vec<ValueCell>"
      description: "Typed parameters"

serialization_order:
  - contract (32 bytes)
  - deposits (variable)
  - entry_id (2 bytes)
  - max_gas (8 bytes)
  - parameters_count (1 byte)
  - parameters (variable)

---
spec:
  name: tx_invoke_contract_value_cell_types
  version: "1.0"
  category: transactions
  subcategory: contracts
  description: "Supported parameter value types"
  priority: P1

definition:
  value_cell_types:
    - U8
    - U16
    - U32
    - U64
    - U128
    - U256
    - Bool
    - String
    - Optional
    - Array
    - Map
    - Blob
    - Address
    - Hash
