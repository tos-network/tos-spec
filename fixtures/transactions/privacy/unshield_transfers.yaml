# TOS Unshield Transfer Transaction Conformance Specifications
# Based on: common/src/transaction/payload/unshield_transfer.rs
#
# Convert encrypted UNO balance back to plaintext TOS (exit privacy mode)

---
spec:
  name: tx_unshield_transfer_basic
  version: "1.0"
  category: transactions
  subcategory: privacy
  description: "Basic unshield transfer (UNO to TOS)"
  priority: P0

preconditions:
  - sender:
      address: "tos1sender..."
      balance: 100000000  # 1 TOS (for fees)
      uno_balance: "<encrypted: 500000000>"  # 5 TOS encrypted
      nonce: 0

action:
  type: transaction
  tx_type: UnshieldTransfer
  params:
    asset: "0x0000...0000"  # TOS_ASSET
    destination: "tos1sender..."  # Unshield to self
    amount: 300000000  # 3 TOS (publicly revealed)
    commitment: "<C = amount * G + r * H>"
    sender_handle: "<D_s = r * P_sender>"
    ct_validity_proof: "<CiphertextValidityProof>"
    extra_data: null
    fee: 50000
    nonce: 0

expected:
  status: success

postconditions:
  - sender:
      balance: 399950000  # 1 + 3 - fee
      uno_balance: "<encrypted: 200000000>"  # 5 - 3
      nonce: 1

---
spec:
  name: tx_unshield_transfer_to_other
  version: "1.0"
  category: transactions
  subcategory: privacy
  description: "Unshield to another address"
  priority: P0

preconditions:
  - sender:
      uno_balance: "<encrypted: 500000000>"
  - receiver:
      address: "tos1receiver..."
      balance: 0

action:
  type: transaction
  tx_type: UnshieldTransfer
  params:
    destination: "tos1receiver..."
    amount: 200000000  # 2 TOS

expected:
  status: success

postconditions:
  - sender:
      uno_balance: "<encrypted: 300000000>"
  - receiver:
      balance: 200000000  # Received as plaintext

---
spec:
  name: tx_unshield_transfer_proof_requirements
  version: "1.0"
  category: transactions
  subcategory: privacy
  description: "Unshield proof verification"
  priority: P0

definition:
  unshield_verification:
    requires:
      - ct_validity_proof: "Proves commitment contains claimed amount"
      - balance_check: "Proves sender has sufficient UNO balance"
      - range_proof: "Proves remaining balance is non-negative"

note: |
  Unshield requires CiphertextValidityProof (same as UNO transfer)
  because sender must prove they are deducting the claimed amount.

---
spec:
  name: tx_unshield_transfer_insufficient_uno
  version: "1.0"
  category: transactions
  subcategory: privacy
  description: "Cannot unshield more than UNO balance"
  priority: P0

preconditions:
  - sender:
      uno_balance: "<encrypted: 100000000>"  # 1 TOS

action:
  type: transaction
  tx_type: UnshieldTransfer
  params:
    amount: 500000000  # 5 TOS (more than UNO balance)

expected:
  status: error
  error: "InsufficientUnoBalance"
  note: "Range proof for remaining balance will fail"

---
spec:
  name: tx_unshield_transfer_invalid_proof
  version: "1.0"
  category: transactions
  subcategory: privacy
  description: "Invalid unshield proof rejected"
  priority: P0

action:
  type: transaction
  tx_type: UnshieldTransfer
  params:
    amount: 100000000
    commitment: "<commitment for 200000000>"  # Mismatch
    ct_validity_proof: "<proof for 200000000>"

expected:
  status: error
  error: "InvalidCiphertextProof"

---
spec:
  name: tx_unshield_transfer_zero_amount
  version: "1.0"
  category: transactions
  subcategory: privacy
  description: "Zero amount unshield rejected"
  priority: P0

action:
  type: transaction
  tx_type: UnshieldTransfer
  params:
    amount: 0

expected:
  status: error
  error: "InvalidAmount"

---
spec:
  name: tx_unshield_transfer_full_balance
  version: "1.0"
  category: transactions
  subcategory: privacy
  description: "Unshield entire UNO balance"
  priority: P1

preconditions:
  - sender:
      uno_balance: "<encrypted: 500000000>"

action:
  type: transaction
  tx_type: UnshieldTransfer
  params:
    amount: 500000000  # Unshield all

expected:
  status: success

postconditions:
  - sender:
      uno_balance: "<encrypted: 0>"  # Zero ciphertext

---
spec:
  name: tx_unshield_transfer_payload_structure
  version: "1.0"
  category: transactions
  subcategory: privacy
  description: "UnshieldTransferPayload wire format"
  priority: P0

definition:
  unshield_transfer_payload:
    asset:
      type: Hash
      size: 32
    destination:
      type: CompressedPublicKey
      size: 32
    amount:
      type: u64
      size: 8
      description: "Plaintext amount (publicly revealed)"
    extra_data:
      type: "Option<UnknownExtraDataFormat>"
    commitment:
      type: CompressedCommitment
      size: 32
      description: "C = amount * G + r * H"
    sender_handle:
      type: CompressedHandle
      size: 32
      description: "D_s = r * P_sender"
    ct_validity_proof:
      type: CiphertextValidityProof
      size: variable
      description: "Proves amount matches commitment"

serialization_order:
  - asset (32 bytes)
  - destination (32 bytes)
  - amount (8 bytes)
  - extra_data (option flag + data)
  - commitment (32 bytes)
  - sender_handle (32 bytes)
  - ct_validity_proof (variable)

---
spec:
  name: tx_unshield_transfer_fee_model
  version: "1.0"
  category: transactions
  subcategory: privacy
  description: "Unshield transfer fee calculation"
  priority: P0

definition:
  fee_model:
    base_fee: 50000
    proof_verification_cost: 30000
    balance_update_cost: 10000
    total_minimum: 50000

note: |
  Unshield costs similar to UNO transfer because:
  - Same CiphertextValidityProof verification
  - Homomorphic balance deduction
  - Additional plaintext balance update

---
spec:
  name: tx_unshield_transfer_amount_visibility
  version: "1.0"
  category: transactions
  subcategory: privacy
  description: "Unshielded amount is publicly visible"
  priority: P1

note: |
  Unlike UNO transfers where amounts are hidden,
  unshield reveals the amount publicly:
  - amount field is u64 plaintext
  - Visible in transaction data
  - Recorded on-chain permanently

  Users should be aware that unshielding breaks
  the privacy chain for that amount.

---
spec:
  name: tx_unshield_transfer_privacy_considerations
  version: "1.0"
  category: transactions
  subcategory: privacy
  description: "Privacy implications of unshielding"
  priority: P2

considerations:
  - name: amount_revealed
    description: "The unshielded amount becomes public"

  - name: destination_visible
    description: "Destination address is visible"

  - name: timing_analysis
    description: "Timing can reveal user patterns"
    recommendation: "Use time delays between shield/unshield"

  - name: amount_correlation
    description: "Matching shield/unshield amounts can be correlated"
    recommendation: "Use different amounts or multiple transactions"
