# TOS EmergencySuspend Transaction Conformance Specifications
# Based on: common/src/transaction/payload/kyc/revoke.rs
#
# Fast-track KYC suspension with 24-hour auto-expire

---
spec:
  name: tx_emergency_suspend_basic
  version: "1.0"
  category: transactions
  subcategory: kyc
  description: "Emergency KYC suspension"
  priority: P0

preconditions:
  - target_account:
      address: "tos1target..."
      kyc_level: 1024  # Tier 5
      kyc_status: "Active"
  - committee:
      id: "0xcommittee..."
      status: "Active"
  - sender:
      address: "tos1sender..."
      balance: 100000000
      nonce: 0

action:
  type: transaction
  tx_type: EmergencySuspend
  params:
    account: "tos1target..."
    reason_hash: "0xreason..."  # Hash of suspension reason
    committee_id: "0xcommittee..."
    approvals:  # Only 2 members required
      - member_pubkey: "tos1member1..."
        signature: "<valid_signature>"
        timestamp: 1706832000
      - member_pubkey: "tos1member2..."
        signature: "<valid_signature>"
        timestamp: 1706832000
    expires_at: 1706918400  # 24 hours from now
    fee: 20000
    nonce: 0

expected:
  status: success

postconditions:
  - target_account:
      kyc_status: "EmergencySuspended"
      suspension_expires_at: 1706918400

---
spec:
  name: tx_emergency_suspend_minimum_approvals
  version: "1.0"
  category: transactions
  subcategory: kyc
  description: "Emergency suspend requires minimum 2 approvals"
  priority: P0

action:
  type: transaction
  tx_type: EmergencySuspend
  params:
    approvals:
      - member_pubkey: "tos1member1..."
      # Only 1 approval

expected:
  status: error
  error: "InsufficientEmergencyApprovals"

definition:
  minimum_emergency_approvals: 2

---
spec:
  name: tx_emergency_suspend_auto_expire
  version: "1.0"
  category: transactions
  subcategory: kyc
  description: "Suspension auto-expires after 24 hours"
  priority: P0

preconditions:
  - target_account:
      kyc_status: "EmergencySuspended"
      suspension_expires_at: 1706918400

context:
  current_timestamp: 1706920000  # After expiry

expected:
  result: "Suspension automatically lifted"

postconditions:
  - target_account:
      kyc_status: "Active"

note: |
  If not confirmed by full committee within 24 hours,
  the emergency suspension is automatically lifted.

---
spec:
  name: tx_emergency_suspend_confirm_with_revoke
  version: "1.0"
  category: transactions
  subcategory: kyc
  description: "Confirm suspension with full revocation"
  priority: P1

preconditions:
  - target_account:
      kyc_status: "EmergencySuspended"
  - committee:
      kyc_threshold: 3  # Full threshold

action:
  type: transaction
  tx_type: RevokeKyc  # Full revocation
  params:
    account: "tos1target..."
    approvals:
      - member_pubkey: "tos1member1..."
      - member_pubkey: "tos1member2..."
      - member_pubkey: "tos1member3..."

expected:
  status: success

postconditions:
  - target_account:
      kyc_status: "Revoked"

---
spec:
  name: tx_emergency_suspend_already_suspended
  version: "1.0"
  category: transactions
  subcategory: kyc
  description: "Cannot emergency suspend already suspended account"
  priority: P0

preconditions:
  - target_account:
      kyc_status: "EmergencySuspended"

action:
  type: transaction
  tx_type: EmergencySuspend
  params:
    account: "tos1target..."

expected:
  status: error
  error: "AlreadySuspended"

---
spec:
  name: tx_emergency_suspend_not_verified
  version: "1.0"
  category: transactions
  subcategory: kyc
  description: "Cannot suspend unverified account"
  priority: P0

preconditions:
  - target_account:
      kyc_level: 0

action:
  type: transaction
  tx_type: EmergencySuspend
  params:
    account: "tos1target..."

expected:
  status: error
  error: "AccountNotVerified"

---
spec:
  name: tx_emergency_suspend_expiry_validation
  version: "1.0"
  category: transactions
  subcategory: kyc
  description: "Expiry timestamp validation"
  priority: P0

preconditions:
  - current_timestamp: 1706832000

tests:
  - name: expiry_in_past
    expires_at: 1706830000  # Before now
    expected: error
    error: "ExpiryInPast"

  - name: expiry_too_far
    expires_at: 1707000000  # > 24 hours
    expected: error
    error: "ExpiryTooFar"

  - name: valid_expiry
    expires_at: 1706918400  # Exactly 24 hours
    expected: valid

---
spec:
  name: tx_emergency_suspend_payload_structure
  version: "1.0"
  category: transactions
  subcategory: kyc
  description: "EmergencySuspendPayload wire format"
  priority: P0

definition:
  emergency_suspend_payload:
    account:
      type: CompressedPublicKey
      size: 32
    reason_hash:
      type: Hash
      size: 32
    committee_id:
      type: Hash
      size: 32
    approvals:
      type: "Vec<CommitteeApproval>"
      min_count: 2
    expires_at:
      type: u64
      size: 8
      description: "Auto-expire timestamp (24h max)"

serialization_order:
  - account (32 bytes)
  - reason_hash (32 bytes)
  - committee_id (32 bytes)
  - approval_count (1 byte)
  - [approvals] (N * 104 bytes)
  - expires_at (8 bytes)

---
spec:
  name: tx_emergency_suspend_gas_cost
  version: "1.0"
  category: transactions
  subcategory: kyc
  description: "EmergencySuspend gas consumption"
  priority: P1

definition:
  gas_cost: 20000
  note: "Lower than RevokeKyc due to simpler requirements"

---
spec:
  name: tx_emergency_suspend_use_cases
  version: "1.0"
  category: transactions
  subcategory: kyc
  description: "Emergency suspension use cases"
  priority: P2

use_cases:
  - name: fraud_detection
    description: "Immediate action on detected fraud"
    note: "Gives committee time to investigate"

  - name: security_breach
    description: "User reports account compromise"
    note: "Protects user while verifying identity"

  - name: regulatory_requirement
    description: "Urgent compliance action required"
    note: "Time-limited while gathering full committee"
