# TOS DisputeEscrow Transaction Conformance Specifications
# Based on: common/src/transaction/payload/escrow/mod.rs
#
# Initiate formal dispute on escrow (triggers arbitration)

---
spec:
  name: tx_dispute_escrow_basic
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Basic escrow dispute"
  priority: P0

preconditions:
  - escrow:
      id: "0xescrow..."
      payer: "tos1payer..."
      provider: "tos1provider..."
      amount: 500000000
      state: "Challenged"  # Must be challenged first
      arbitration_config:
        arbiters: ["tos1arbiter..."]
        threshold: 1
  - sender:
      address: "tos1payer..."
      nonce: 0

action:
  type: transaction
  tx_type: DisputeEscrow
  params:
    escrow_id: "0xescrow..."
    reason: "Provider refuses to acknowledge challenge"
    evidence_hash: "0xevidence..."
    fee: 20000
    nonce: 0

expected:
  status: success

postconditions:
  - escrow:
      state: "Disputed"
      dispute_id: "<generated>"
      dispute_initiator: "tos1payer..."

---
spec:
  name: tx_dispute_escrow_from_created_state
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Direct dispute from created state (non-optimistic)"
  priority: P0

preconditions:
  - escrow:
      state: "Created"
      optimistic_release: false
      arbitration_config:
        arbiters: ["tos1arbiter..."]

action:
  type: transaction
  tx_type: DisputeEscrow
  params:
    escrow_id: "0xescrow..."
    reason: "Provider not delivering service"

expected:
  status: success

postconditions:
  - escrow:
      state: "Disputed"

note: |
  Non-optimistic escrows can go directly to dispute
  without going through challenge phase.

---
spec:
  name: tx_dispute_escrow_no_arbitration_config
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Cannot dispute escrow without arbitration config"
  priority: P0

preconditions:
  - escrow:
      arbitration_config: null  # No arbiters configured

action:
  type: transaction
  tx_type: DisputeEscrow
  params:
    escrow_id: "0xescrow..."

expected:
  status: error
  error: "NoArbitrationConfig"

---
spec:
  name: tx_dispute_escrow_only_parties
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Only payer or provider can initiate dispute"
  priority: P0

preconditions:
  - escrow:
      payer: "tos1payer..."
      provider: "tos1provider..."
  - sender:
      address: "tos1other..."  # Neither payer nor provider

action:
  type: transaction
  tx_type: DisputeEscrow
  params:
    escrow_id: "0xescrow..."

expected:
  status: error
  error: "UnauthorizedDispute"

---
spec:
  name: tx_dispute_escrow_provider_initiates
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Provider can also initiate dispute"
  priority: P1

preconditions:
  - escrow:
      payer: "tos1payer..."
      provider: "tos1provider..."
      state: "Created"
      optimistic_release: false
  - sender:
      address: "tos1provider..."  # Provider initiates

action:
  type: transaction
  tx_type: DisputeEscrow
  params:
    escrow_id: "0xescrow..."
    reason: "Payer refuses to release despite completion"

expected:
  status: success

postconditions:
  - escrow:
      state: "Disputed"
      dispute_initiator: "tos1provider..."

---
spec:
  name: tx_dispute_escrow_already_disputed
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Cannot dispute already disputed escrow"
  priority: P0

preconditions:
  - escrow:
      state: "Disputed"

action:
  type: transaction
  tx_type: DisputeEscrow
  params:
    escrow_id: "0xescrow..."

expected:
  status: error
  error: "EscrowAlreadyDisputed"

---
spec:
  name: tx_dispute_escrow_invalid_state
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Cannot dispute certain escrow states"
  priority: P0

tests:
  - name: released_escrow
    escrow_state: "Released"
    expected: error
    error: "EscrowAlreadyReleased"

  - name: refunded_escrow
    escrow_state: "Refunded"
    expected: error
    error: "EscrowAlreadyRefunded"

  - name: resolved_escrow
    escrow_state: "Resolved"
    expected: error
    error: "EscrowAlreadyResolved"

---
spec:
  name: tx_dispute_escrow_empty_reason
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Dispute reason cannot be empty"
  priority: P0

action:
  type: transaction
  tx_type: DisputeEscrow
  params:
    escrow_id: "0xescrow..."
    reason: ""

expected:
  status: error
  error: "EmptyReason"

---
spec:
  name: tx_dispute_escrow_triggers_arbitration
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Dispute triggers arbitration process"
  priority: P1

preconditions:
  - escrow:
      arbitration_config:
        arbiters: ["tos1arbiter1...", "tos1arbiter2..."]
        threshold: 2

action:
  type: transaction
  tx_type: DisputeEscrow
  params:
    escrow_id: "0xescrow..."
    reason: "Dispute over service quality"

expected:
  status: success

postconditions:
  - dispute:
      escrow_id: "0xescrow..."
      round: 0  # Initial arbitration
      required_signatures: 2
      status: "Open"

---
spec:
  name: tx_dispute_escrow_payload_structure
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "DisputeEscrowPayload wire format"
  priority: P0

definition:
  dispute_escrow_payload:
    escrow_id:
      type: Hash
      size: 32
    reason:
      type: String
      description: "Dispute reason"
    evidence_hash:
      type: "Option<Hash>"
      description: "Hash of off-chain evidence"

serialization_order:
  - escrow_id (32 bytes)
  - reason (variable)
  - evidence_hash_flag (1 byte)
  - [evidence_hash] (32 bytes if present)

---
spec:
  name: tx_dispute_escrow_gas_cost
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "DisputeEscrow gas consumption"
  priority: P1

definition:
  gas_cost: 20000
