# TOS ChallengeEscrow Transaction Conformance Specifications
# Based on: common/src/transaction/payload/escrow/mod.rs
#
# Challenge escrow during optimistic release window

---
spec:
  name: tx_challenge_escrow_basic
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Basic escrow challenge"
  priority: P0

preconditions:
  - escrow:
      id: "0xescrow..."
      payer: "tos1payer..."
      provider: "tos1provider..."
      amount: 500000000  # 5 TOS
      challenge_deposit_bps: 1000  # 10%
      challenge_window: 3600  # blocks
      optimistic_release: true
      state: "Created"
      created_at_block: 1000
  - current_block: 1500  # Within challenge window
  - payer:
      balance: 100000000  # Enough for deposit
      nonce: 0

action:
  type: transaction
  tx_type: ChallengeEscrow
  params:
    escrow_id: "0xescrow..."
    reason: "Work not completed as agreed"
    evidence_hash: "0xevidence..."  # Hash of off-chain evidence
    deposit: 50000000  # 10% of 5 TOS
    fee: 10000
    nonce: 0

expected:
  status: success

postconditions:
  - escrow:
      state: "Challenged"
      challenger: "tos1payer..."
      challenge_deposit: 50000000
  - payer:
      balance: 49990000  # 100M - 50M deposit - fee

---
spec:
  name: tx_challenge_escrow_window_expired
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Cannot challenge after window expires"
  priority: P0

preconditions:
  - escrow:
      challenge_window: 3600
      created_at_block: 1000
  - current_block: 5000  # > 1000 + 3600

action:
  type: transaction
  tx_type: ChallengeEscrow
  params:
    escrow_id: "0xescrow..."

expected:
  status: error
  error: "ChallengeWindowExpired"

---
spec:
  name: tx_challenge_escrow_not_optimistic
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Cannot challenge non-optimistic escrow"
  priority: P0

preconditions:
  - escrow:
      optimistic_release: false

action:
  type: transaction
  tx_type: ChallengeEscrow
  params:
    escrow_id: "0xescrow..."

expected:
  status: error
  error: "EscrowNotOptimistic"

---
spec:
  name: tx_challenge_escrow_only_payer
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Only payer can challenge"
  priority: P0

preconditions:
  - escrow:
      payer: "tos1payer..."
  - sender:
      address: "tos1other..."  # Not the payer

action:
  type: transaction
  tx_type: ChallengeEscrow
  params:
    escrow_id: "0xescrow..."

expected:
  status: error
  error: "UnauthorizedChallenge"

---
spec:
  name: tx_challenge_escrow_insufficient_deposit
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Challenge deposit must meet minimum"
  priority: P0

preconditions:
  - escrow:
      amount: 500000000
      challenge_deposit_bps: 1000  # 10% = 50M

action:
  type: transaction
  tx_type: ChallengeEscrow
  params:
    escrow_id: "0xescrow..."
    deposit: 40000000  # Only 8%, less than required 10%

expected:
  status: error
  error: "InsufficientChallengeDeposit"

---
spec:
  name: tx_challenge_escrow_already_challenged
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Cannot challenge already challenged escrow"
  priority: P0

preconditions:
  - escrow:
      state: "Challenged"

action:
  type: transaction
  tx_type: ChallengeEscrow
  params:
    escrow_id: "0xescrow..."

expected:
  status: error
  error: "EscrowAlreadyChallenged"

---
spec:
  name: tx_challenge_escrow_empty_reason
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Challenge reason cannot be empty"
  priority: P0

action:
  type: transaction
  tx_type: ChallengeEscrow
  params:
    escrow_id: "0xescrow..."
    reason: ""
    deposit: 50000000

expected:
  status: error
  error: "EmptyReason"

---
spec:
  name: tx_challenge_escrow_invalid_state
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Cannot challenge certain escrow states"
  priority: P0

tests:
  - name: released_escrow
    escrow_state: "Released"
    expected: error
    error: "EscrowAlreadyReleased"

  - name: refunded_escrow
    escrow_state: "Refunded"
    expected: error
    error: "EscrowAlreadyRefunded"

  - name: disputed_escrow
    escrow_state: "Disputed"
    expected: error
    error: "EscrowDisputed"

---
spec:
  name: tx_challenge_escrow_deposit_calculation
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Challenge deposit calculation"
  priority: P0

definition:
  deposit_calculation: "deposit >= (escrow_amount * challenge_deposit_bps) / 10000"

tests:
  - name: 10_percent_of_5_tos
    escrow_amount: 500000000
    challenge_deposit_bps: 1000
    minimum_deposit: 50000000

  - name: 5_percent_of_10_tos
    escrow_amount: 1000000000
    challenge_deposit_bps: 500
    minimum_deposit: 50000000

---
spec:
  name: tx_challenge_escrow_payload_structure
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "ChallengeEscrowPayload wire format"
  priority: P0

definition:
  challenge_escrow_payload:
    escrow_id:
      type: Hash
      size: 32
    reason:
      type: String
      description: "Challenge reason"
    evidence_hash:
      type: "Option<Hash>"
      description: "Hash of off-chain evidence"
    deposit:
      type: u64
      size: 8
      description: "Challenge deposit amount"

serialization_order:
  - escrow_id (32 bytes)
  - reason (variable)
  - evidence_hash_flag (1 byte)
  - [evidence_hash] (32 bytes if present)
  - deposit (8 bytes)
