# TOS CreateEscrow Transaction Conformance Specifications
# Based on: common/src/transaction/payload/escrow/mod.rs
#
# Create A2A escrow for task-based payments with optimistic settlement

---
spec:
  name: tx_create_escrow_basic
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Basic escrow creation"
  priority: P0

preconditions:
  - payer:
      address: "tos1payer..."
      balance: 1000000000  # 10 TOS
      nonce: 0
  - provider:
      address: "tos1provider..."
      exists: true

action:
  type: transaction
  tx_type: CreateEscrow
  params:
    task_id: "task-001"
    provider: "tos1provider..."
    amount: 500000000  # 5 TOS
    asset: "0x0000...0000"  # TOS_ASSET
    timeout_blocks: 86400  # ~1 day
    challenge_window: 3600  # ~1 hour
    challenge_deposit_bps: 1000  # 10% (1000 basis points)
    optimistic_release: true
    arbitration_config: null
    metadata: null
    fee: 10000
    nonce: 0

expected:
  status: success
  escrow_id: "<tx_hash>"  # Escrow ID = creation tx hash

postconditions:
  - payer:
      balance: 499990000  # 10 - 5 - fee
      nonce: 1
  - escrow:
      id: "<tx_hash>"
      payer: "tos1payer..."
      provider: "tos1provider..."
      amount: 500000000
      state: "Created"

---
spec:
  name: tx_create_escrow_with_arbitration
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Escrow with arbitration configuration"
  priority: P0

preconditions:
  - payer:
      balance: 1000000000
      nonce: 0
  - arbiter:
      address: "tos1arbiter..."
      registered: true
      stake: 100000000000  # 1000 TOS

action:
  type: transaction
  tx_type: CreateEscrow
  params:
    task_id: "task-002"
    provider: "tos1provider..."
    amount: 500000000
    asset: "0x0000...0000"
    timeout_blocks: 86400
    challenge_window: 3600
    challenge_deposit_bps: 1000
    optimistic_release: false  # Requires explicit release
    arbitration_config:
      arbiters:
        - "tos1arbiter..."
      threshold: 1
      appeal_enabled: true
    metadata: null

expected:
  status: success

postconditions:
  - escrow:
      arbitration_config:
        arbiters: ["tos1arbiter..."]
        threshold: 1

---
spec:
  name: tx_create_escrow_with_metadata
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Escrow with metadata (task description hash)"
  priority: P1

action:
  type: transaction
  tx_type: CreateEscrow
  params:
    task_id: "task-003"
    provider: "tos1provider..."
    amount: 100000000
    metadata: "0xhash_of_task_description..."

expected:
  status: success

postconditions:
  - escrow:
      metadata: "0xhash_of_task_description..."

---
spec:
  name: tx_create_escrow_insufficient_balance
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Escrow creation fails with insufficient balance"
  priority: P0

preconditions:
  - payer:
      balance: 100000000  # 1 TOS
      nonce: 0

action:
  type: transaction
  tx_type: CreateEscrow
  params:
    amount: 500000000  # 5 TOS (more than balance)

expected:
  status: error
  error: "InsufficientBalance"

---
spec:
  name: tx_create_escrow_zero_amount
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Zero amount escrow rejected"
  priority: P0

action:
  type: transaction
  tx_type: CreateEscrow
  params:
    amount: 0

expected:
  status: error
  error: "InvalidAmount"

---
spec:
  name: tx_create_escrow_self_provider
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Payer cannot be provider"
  priority: P0

preconditions:
  - payer:
      address: "tos1payer..."

action:
  type: transaction
  tx_type: CreateEscrow
  params:
    provider: "tos1payer..."  # Same as sender

expected:
  status: error
  error: "SelfEscrowNotAllowed"

---
spec:
  name: tx_create_escrow_invalid_timeout
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Timeout must be reasonable"
  priority: P1

tests:
  - name: zero_timeout
    timeout_blocks: 0
    expected: error
    error: "InvalidTimeout"

  - name: very_long_timeout
    timeout_blocks: 999999999999
    expected: error
    error: "TimeoutTooLong"

---
spec:
  name: tx_create_escrow_challenge_window_validation
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Challenge window must be valid"
  priority: P1

tests:
  - name: zero_window
    challenge_window: 0
    expected: error
    error: "InvalidChallengeWindow"

  - name: window_exceeds_timeout
    timeout_blocks: 1000
    challenge_window: 2000
    expected: error
    error: "ChallengeWindowExceedsTimeout"

---
spec:
  name: tx_create_escrow_challenge_deposit_bps
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Challenge deposit percentage validation"
  priority: P1

definition:
  basis_points: "100 bps = 1%"

tests:
  - name: valid_10_percent
    challenge_deposit_bps: 1000
    expected: valid

  - name: zero_deposit
    challenge_deposit_bps: 0
    expected: error
    error: "InvalidChallengeDeposit"

  - name: exceeds_100_percent
    challenge_deposit_bps: 10001  # > 100%
    expected: error
    error: "ChallengeDepositTooHigh"

---
spec:
  name: tx_create_escrow_custom_asset
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Escrow with custom token asset"
  priority: P1

preconditions:
  - payer:
      balances:
        "0xtoken...": 1000000000

action:
  type: transaction
  tx_type: CreateEscrow
  params:
    amount: 500000000
    asset: "0xtoken..."  # Custom token
    fee: 10000  # Fee still in TOS

expected:
  status: success

postconditions:
  - escrow:
      asset: "0xtoken..."
      amount: 500000000

---
spec:
  name: tx_create_escrow_duplicate_task_id
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Duplicate task_id handling"
  priority: P1

note: |
  task_id is for off-chain reference only.
  Multiple escrows can share the same task_id.
  Escrow is uniquely identified by its creation tx hash.

---
spec:
  name: tx_create_escrow_escrow_id_derivation
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Escrow ID is the creation transaction hash"
  priority: P0

rule: "escrow_id = hash(create_escrow_transaction)"

---
spec:
  name: tx_create_escrow_payload_structure
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "CreateEscrowPayload wire format"
  priority: P0

definition:
  create_escrow_payload:
    task_id:
      type: String
      description: "A2A task ID (off-chain reference)"
    provider:
      type: PublicKey
      size: 32
    amount:
      type: u64
      size: 8
    asset:
      type: Hash
      size: 32
    timeout_blocks:
      type: u64
      size: 8
    challenge_window:
      type: u64
      size: 8
    challenge_deposit_bps:
      type: u16
      size: 2
    optimistic_release:
      type: bool
      size: 1
    arbitration_config:
      type: "Option<ArbitrationConfig>"
    metadata:
      type: "Option<Vec<u8>>"

serialization_order:
  - task_id (variable)
  - provider (32 bytes)
  - amount (8 bytes)
  - asset (32 bytes)
  - timeout_blocks (8 bytes)
  - challenge_window (8 bytes)
  - challenge_deposit_bps (2 bytes)
  - optimistic_release (1 byte)
  - arbitration_config (option flag + data)
  - metadata (option flag + data)

---
spec:
  name: tx_create_escrow_state_machine
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Escrow state transitions"
  priority: P0

definition:
  escrow_states:
    Created: "Initial state after creation"
    Deposited: "Additional funds deposited"
    Released: "Funds released to provider"
    Refunded: "Funds returned to payer"
    Challenged: "Challenge initiated"
    Disputed: "Dispute in progress"
    Resolved: "Arbitration complete"

  transitions:
    Created:
      - to: Released
        via: ReleaseEscrow
      - to: Refunded
        via: RefundEscrow
      - to: Challenged
        via: ChallengeEscrow
      - to: Deposited
        via: DepositEscrow
    Challenged:
      - to: Disputed
        via: DisputeEscrow
      - to: Released
        via: ReleaseEscrow
    Disputed:
      - to: Resolved
        via: SubmitVerdict
