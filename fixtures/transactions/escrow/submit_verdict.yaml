# TOS SubmitVerdict Transaction Conformance Specifications
# Based on: common/src/transaction/payload/escrow/mod.rs
#
# Submit arbitration verdict with threshold signatures

---
spec:
  name: tx_submit_verdict_basic
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Basic arbitration verdict submission"
  priority: P0

preconditions:
  - escrow:
      id: "0xescrow..."
      payer: "tos1payer..."
      provider: "tos1provider..."
      amount: 500000000  # 5 TOS
      state: "Disputed"
      arbitration_config:
        arbiters: ["tos1arbiter..."]
        threshold: 1
  - arbiter:
      address: "tos1arbiter..."
      registered: true
  - payer:
      balance: 0
  - provider:
      balance: 0

action:
  type: transaction
  tx_type: SubmitVerdict
  params:
    escrow_id: "0xescrow..."
    dispute_id: "0xdispute..."
    round: 0  # Initial arbitration
    payer_amount: 200000000  # 2 TOS to payer
    payee_amount: 300000000  # 3 TOS to provider
    signatures:
      - arbiter_pubkey: "tos1arbiter..."
        signature: "<valid_signature>"
        timestamp: 1706832000
    fee: 10000
    nonce: 0

expected:
  status: success

postconditions:
  - escrow:
      state: "Resolved"
  - payer:
      balance: 200000000  # Received refund portion
  - provider:
      balance: 300000000  # Received payment portion

---
spec:
  name: tx_submit_verdict_full_to_payer
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Verdict awarding full amount to payer (refund)"
  priority: P0

preconditions:
  - escrow:
      amount: 500000000
      state: "Disputed"

action:
  type: transaction
  tx_type: SubmitVerdict
  params:
    escrow_id: "0xescrow..."
    dispute_id: "0xdispute..."
    round: 0
    payer_amount: 500000000  # Full refund
    payee_amount: 0

expected:
  status: success

postconditions:
  - payer:
      balance_increase: 500000000
  - provider:
      balance_increase: 0

---
spec:
  name: tx_submit_verdict_full_to_provider
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Verdict awarding full amount to provider"
  priority: P0

preconditions:
  - escrow:
      amount: 500000000
      state: "Disputed"

action:
  type: transaction
  tx_type: SubmitVerdict
  params:
    escrow_id: "0xescrow..."
    dispute_id: "0xdispute..."
    round: 0
    payer_amount: 0
    payee_amount: 500000000  # Full payment

expected:
  status: success

postconditions:
  - payer:
      balance_increase: 0
  - provider:
      balance_increase: 500000000

---
spec:
  name: tx_submit_verdict_amount_mismatch
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Verdict amounts must equal escrow amount"
  priority: P0

preconditions:
  - escrow:
      amount: 500000000

action:
  type: transaction
  tx_type: SubmitVerdict
  params:
    payer_amount: 200000000
    payee_amount: 200000000  # Total 400M != 500M

expected:
  status: error
  error: "VerdictAmountMismatch"

---
spec:
  name: tx_submit_verdict_insufficient_signatures
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Verdict requires threshold signatures"
  priority: P0

preconditions:
  - escrow:
      arbitration_config:
        threshold: 3
  - signatures_count: 2  # Less than threshold

action:
  type: transaction
  tx_type: SubmitVerdict
  params:
    signatures: [sig1, sig2]  # Only 2

expected:
  status: error
  error: "InsufficientSignatures"

---
spec:
  name: tx_submit_verdict_invalid_signature
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Invalid arbiter signature rejected"
  priority: P0

action:
  type: transaction
  tx_type: SubmitVerdict
  params:
    signatures:
      - arbiter_pubkey: "tos1arbiter..."
        signature: "<invalid_signature>"

expected:
  status: error
  error: "InvalidArbiterSignature"

---
spec:
  name: tx_submit_verdict_unregistered_arbiter
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Signature from unregistered arbiter rejected"
  priority: P0

preconditions:
  - arbiter:
      address: "tos1unregistered..."
      registered: false

action:
  type: transaction
  tx_type: SubmitVerdict
  params:
    signatures:
      - arbiter_pubkey: "tos1unregistered..."

expected:
  status: error
  error: "ArbiterNotRegistered"

---
spec:
  name: tx_submit_verdict_escrow_not_disputed
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Cannot submit verdict for non-disputed escrow"
  priority: P0

preconditions:
  - escrow:
      state: "Created"  # Not disputed

action:
  type: transaction
  tx_type: SubmitVerdict

expected:
  status: error
  error: "EscrowNotDisputed"

---
spec:
  name: tx_submit_verdict_wrong_dispute_id
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Dispute ID must match active dispute"
  priority: P0

preconditions:
  - escrow:
      active_dispute_id: "0xcorrect..."

action:
  type: transaction
  tx_type: SubmitVerdict
  params:
    dispute_id: "0xwrong..."  # Mismatch

expected:
  status: error
  error: "DisputeIdMismatch"

---
spec:
  name: tx_submit_verdict_appeal_round
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Appeal verdict (round > 0)"
  priority: P1

preconditions:
  - escrow:
      state: "Appealed"
      appeal_round: 1
      arbitration_config:
        appeal_enabled: true

action:
  type: transaction
  tx_type: SubmitVerdict
  params:
    round: 1  # Appeal round
    payer_amount: 300000000
    payee_amount: 200000000

expected:
  status: success

postconditions:
  - escrow:
      state: "Resolved"
      final_round: 1

---
spec:
  name: tx_submit_verdict_by_juror
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Fallback verdict submission by juror"
  priority: P1

preconditions:
  - escrow:
      state: "Disputed"
      coordinator_deadline_passed: true
  - current_block: coordinator_deadline + JUROR_SUBMIT_WINDOW

action:
  type: transaction
  tx_type: SubmitVerdictByJuror
  params:
    escrow_id: "0xescrow..."
    dispute_id: "0xdispute..."
    round: 0
    payer_amount: 250000000
    payee_amount: 250000000
    signatures: [...]

expected:
  status: success
  note: "Juror can submit if coordinator misses deadline"

---
spec:
  name: tx_submit_verdict_signature_structure
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "ArbiterSignature structure"
  priority: P0

definition:
  arbiter_signature:
    arbiter_pubkey:
      type: PublicKey
      size: 32
    signature:
      type: Signature
      size: 64
    timestamp:
      type: u64
      size: 8

  total_size: 104 bytes

---
spec:
  name: tx_submit_verdict_payload_structure
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "SubmitVerdictPayload wire format"
  priority: P0

definition:
  submit_verdict_payload:
    escrow_id:
      type: Hash
      size: 32
    dispute_id:
      type: Hash
      size: 32
    round:
      type: u32
      size: 4
    payer_amount:
      type: u64
      size: 8
    payee_amount:
      type: u64
      size: 8
    signatures:
      type: "Vec<ArbiterSignature>"

serialization_order:
  - escrow_id (32 bytes)
  - dispute_id (32 bytes)
  - round (4 bytes)
  - payer_amount (8 bytes)
  - payee_amount (8 bytes)
  - signatures (variable)

---
spec:
  name: tx_submit_verdict_signature_message
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Message signed by arbiters"
  priority: P0

definition:
  verdict_message:
    fields:
      - escrow_id
      - dispute_id
      - round
      - payer_amount
      - payee_amount

  signature_covers: |
    hash(escrow_id || dispute_id || round || payer_amount || payee_amount)

---
spec:
  name: tx_submit_verdict_duplicate_signatures
  version: "1.0"
  category: transactions
  subcategory: escrow
  description: "Duplicate arbiter signatures rejected"
  priority: P0

action:
  type: transaction
  tx_type: SubmitVerdict
  params:
    signatures:
      - arbiter_pubkey: "tos1arbiter..."
      - arbiter_pubkey: "tos1arbiter..."  # Duplicate

expected:
  status: error
  error: "DuplicateSignature"
