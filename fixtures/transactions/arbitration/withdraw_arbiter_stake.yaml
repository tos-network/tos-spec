# TOS WithdrawArbiterStake Transaction Conformance Specifications
# Based on: common/src/transaction/payload/arbitration/withdraw_arbiter_stake.rs
#
# Withdraw stake after exit cooldown

---
spec:
  name: tx_withdraw_arbiter_stake_basic
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "Basic arbiter stake withdrawal"
  priority: P0

preconditions:
  - arbiter:
      address: "tos1arbiter..."
      status: "Exiting"
      exit_requested_at_block: 1000
      stake: 10000000000
      pending_cases: 0
  - current_block: 15500  # Past cooldown
  - sender:
      address: "tos1arbiter..."
      balance: 100000000
      nonce: 0

action:
  type: transaction
  tx_type: WithdrawArbiterStake
  params:
    amount: 10000000000  # Full stake
    fee: 10000
    nonce: 0

expected:
  status: success

postconditions:
  - sender:
      balance: 10100000000  # Original + stake - fee
  - arbiter:
      status: "Withdrawn"
      stake: 0

---
spec:
  name: tx_withdraw_arbiter_stake_partial
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "Partial stake withdrawal"
  priority: P1

preconditions:
  - arbiter:
      stake: 10000000000
      status: "Exiting"
      pending_cases: 0
  - current_block_past_cooldown: true

action:
  type: transaction
  tx_type: WithdrawArbiterStake
  params:
    amount: 5000000000  # Half stake

expected:
  status: success

postconditions:
  - arbiter:
      stake: 5000000000

note: |
  Partial withdrawal is allowed if remaining stake
  still meets minimum requirements, or if fully exiting.

---
spec:
  name: tx_withdraw_arbiter_stake_not_exiting
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "Cannot withdraw if not in exiting state"
  priority: P0

preconditions:
  - arbiter:
      status: "Active"

action:
  type: transaction
  tx_type: WithdrawArbiterStake
  params:
    amount: 10000000000

expected:
  status: error
  error: "NotInExitingState"

---
spec:
  name: tx_withdraw_arbiter_stake_cooldown_not_passed
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "Cannot withdraw before cooldown expires"
  priority: P0

definition:
  EXIT_COOLDOWN_BLOCKS: 14400  # 10 days

preconditions:
  - arbiter:
      status: "Exiting"
      exit_requested_at_block: 1000
  - current_block: 10000  # Before cooldown

action:
  type: transaction
  tx_type: WithdrawArbiterStake
  params:
    amount: 10000000000

expected:
  status: error
  error: "CooldownNotPassed"
  details:
    remaining_blocks: 5400

---
spec:
  name: tx_withdraw_arbiter_stake_pending_cases
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "Cannot withdraw with pending cases"
  priority: P0

preconditions:
  - arbiter:
      status: "Exiting"
      pending_cases: 2  # Still has cases

action:
  type: transaction
  tx_type: WithdrawArbiterStake
  params:
    amount: 10000000000

expected:
  status: error
  error: "PendingCasesRemain"
  details:
    pending_count: 2

---
spec:
  name: tx_withdraw_arbiter_stake_exceeds_balance
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "Cannot withdraw more than staked"
  priority: P0

preconditions:
  - arbiter:
      stake: 10000000000
      status: "Exiting"
      pending_cases: 0

action:
  type: transaction
  tx_type: WithdrawArbiterStake
  params:
    amount: 20000000000  # More than stake

expected:
  status: error
  error: "InsufficientStake"

---
spec:
  name: tx_withdraw_arbiter_stake_zero_amount
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "Cannot withdraw zero amount"
  priority: P0

action:
  type: transaction
  tx_type: WithdrawArbiterStake
  params:
    amount: 0

expected:
  status: error
  error: "InvalidAmount"

---
spec:
  name: tx_withdraw_arbiter_stake_not_registered
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "Cannot withdraw if not registered"
  priority: P0

preconditions:
  - sender:
      is_arbiter: false

action:
  type: transaction
  tx_type: WithdrawArbiterStake
  params:
    amount: 10000000000

expected:
  status: error
  error: "NotRegisteredArbiter"

---
spec:
  name: tx_withdraw_arbiter_stake_slashed
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "Withdrawal reflects slashed amount"
  priority: P1

preconditions:
  - arbiter:
      original_stake: 10000000000
      slashed_amount: 2000000000
      stake: 8000000000  # After slash
      status: "Exiting"
      pending_cases: 0

action:
  type: transaction
  tx_type: WithdrawArbiterStake
  params:
    amount: 8000000000  # Can only withdraw remaining

expected:
  status: success

postconditions:
  - sender:
      balance_increase: 8000000000

---
spec:
  name: tx_withdraw_arbiter_stake_payload_structure
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "WithdrawArbiterStakePayload wire format"
  priority: P0

definition:
  withdraw_arbiter_stake_payload:
    amount:
      type: u64
      size: 8
      description: "Amount to withdraw in atomic units"

serialization_order:
  - amount (8 bytes)

total_size: 8 bytes

---
spec:
  name: tx_withdraw_arbiter_stake_gas_cost
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "WithdrawArbiterStake gas consumption"
  priority: P1

definition:
  gas_cost: 15000
