# TOS CommitVoteRequest Transaction Conformance Specifications
# Based on: common/src/transaction/payload/arbitration/commit_vote_request.rs
#
# Commit vote request for juror selection

---
spec:
  name: tx_commit_vote_request_basic
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "Basic vote request commitment"
  priority: P0

preconditions:
  - escrow:
      id: "0xescrow..."
      state: "Disputed"
      dispute_id: "0xdispute..."
  - arbitration:
      state: "Open"
      coordinator: "tos1coordinator..."
  - sender:
      address: "tos1coordinator..."
      nonce: 0

action:
  type: transaction
  tx_type: CommitVoteRequest
  params:
    request_id: "0xrequest..."
    vote_request_hash: "0xvote_hash..."
    coordinator_signature: "<coordinator_signature>"
    vote_request_payload: "<encrypted_vote_request_bytes>"
    fee: 20000
    nonce: 0

expected:
  status: success

postconditions:
  - arbitration:
      state: "VoteRequested"
      vote_request_id: "0xrequest..."

---
spec:
  name: tx_commit_vote_request_not_coordinator
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "Only coordinator can commit vote request"
  priority: P0

preconditions:
  - arbitration:
      coordinator: "tos1coordinator..."
  - sender:
      address: "tos1other..."  # Not coordinator

action:
  type: transaction
  tx_type: CommitVoteRequest
  params:
    request_id: "0xrequest..."

expected:
  status: error
  error: "NotCoordinator"

---
spec:
  name: tx_commit_vote_request_wrong_state
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "Arbitration must be in Open state"
  priority: P0

preconditions:
  - arbitration:
      state: "VoteRequested"  # Already past this phase

action:
  type: transaction
  tx_type: CommitVoteRequest
  params:
    request_id: "0xrequest..."

expected:
  status: error
  error: "InvalidArbitrationState"

---
spec:
  name: tx_commit_vote_request_invalid_signature
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "Coordinator signature must be valid"
  priority: P0

action:
  type: transaction
  tx_type: CommitVoteRequest
  params:
    coordinator_signature: "<invalid_signature>"

expected:
  status: error
  error: "InvalidCoordinatorSignature"

---
spec:
  name: tx_commit_vote_request_hash_mismatch
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "Payload hash must match declared hash"
  priority: P0

action:
  type: transaction
  tx_type: CommitVoteRequest
  params:
    vote_request_hash: "0xdeclared_hash..."
    vote_request_payload: "<payload_with_different_hash>"

expected:
  status: error
  error: "PayloadHashMismatch"

---
spec:
  name: tx_commit_vote_request_payload_too_large
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "Payload size limit enforcement"
  priority: P0

definition:
  MAX_VOTE_REQUEST_BYTES: 65536  # 64 KB

action:
  type: transaction
  tx_type: CommitVoteRequest
  params:
    vote_request_payload: "<70000 bytes>"  # > 64 KB

expected:
  status: error
  error: "PayloadTooLarge"

---
spec:
  name: tx_commit_vote_request_duplicate
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "Cannot commit duplicate request ID"
  priority: P0

preconditions:
  - existing_vote_request:
      request_id: "0xrequest..."

action:
  type: transaction
  tx_type: CommitVoteRequest
  params:
    request_id: "0xrequest..."  # Same ID

expected:
  status: error
  error: "DuplicateRequestId"

---
spec:
  name: tx_commit_vote_request_payload_structure
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "CommitVoteRequestPayload wire format"
  priority: P0

definition:
  commit_vote_request_payload:
    request_id:
      type: Hash
      size: 32
      description: "Unique vote request identifier"
    vote_request_hash:
      type: Hash
      size: 32
      description: "Hash of vote request content"
    coordinator_signature:
      type: Signature
      size: 64
      description: "Coordinator's signature"
    vote_request_payload:
      type: "Vec<u8>"
      max_size: 65536
      description: "Encrypted vote request content"

serialization_order:
  - request_id (32 bytes)
  - vote_request_hash (32 bytes)
  - coordinator_signature (64 bytes)
  - payload_length (4 bytes)
  - vote_request_payload (variable)

---
spec:
  name: tx_commit_vote_request_gas_cost
  version: "1.0"
  category: transactions
  subcategory: arbitration
  description: "CommitVoteRequest gas consumption"
  priority: P1

definition:
  base_gas: 20000
  per_kb_gas: 500

formula: "total_gas = 20000 + (payload_size_kb * 500)"
