{
  "test_vectors": [
    {
      "name": "p2p_fault_message_corruption",
      "description": "Disconnects peer on invalid message checksum",
      "runnable": false,
      "input": {
        "kind": "p2p",
        "category": "p2p",
        "subcategory": "fault_injection",
        "preconditions": [
          {
            "peer": "peer1"
          },
          {
            "message_checksum_valid": false
          }
        ],
        "action": {
          "type": "p2p_receive",
          "peer": "peer1",
          "message": {
            "kind": "block",
            "id": "blk1",
            "checksum_valid": false
          }
        }
      },
      "expected": {
        "status": "error",
        "error": "CorruptMessage",
        "peer_disconnected": true
      }
    },
    {
      "name": "p2p_fault_oversized_message",
      "description": "Rejects oversized message payload",
      "runnable": false,
      "input": {
        "kind": "p2p",
        "category": "p2p",
        "subcategory": "fault_injection",
        "preconditions": [
          {
            "max_message_bytes": 1048576
          },
          {
            "message_size": 2097152
          }
        ],
        "action": {
          "type": "p2p_receive",
          "peer": "peer1",
          "message": {
            "kind": "tx",
            "size": 2097152
          }
        }
      },
      "expected": {
        "status": "error",
        "error": "MessageTooLarge"
      }
    },
    {
      "name": "p2p_fault_ping_timeout",
      "description": "Disconnects peer after ping timeout",
      "runnable": false,
      "input": {
        "kind": "p2p",
        "category": "p2p",
        "subcategory": "fault_injection",
        "preconditions": [
          {
            "ping_timeout_seconds": 60
          },
          {
            "peer": "peer_slow"
          }
        ],
        "action": {
          "type": "p2p_ping",
          "peer": "peer_slow"
        }
      },
      "expected": {
        "status": "error",
        "error": "PingTimeout",
        "peer_disconnected": true
      }
    },
    {
      "name": "p2p_fault_connection_flood",
      "description": "Limits inbound connections per IP",
      "runnable": false,
      "input": {
        "kind": "p2p",
        "category": "p2p",
        "subcategory": "abuse",
        "preconditions": [
          {
            "max_connections_per_ip": 8
          },
          {
            "attempted_connections": 100
          },
          {
            "peer_ip": "10.0.0.1"
          }
        ],
        "action": {
          "type": "p2p_connect",
          "peer_ip": "10.0.0.1",
          "attempts": 100
        }
      },
      "expected": {
        "status": "ok",
        "accepted_connections": 8,
        "rejected_connections": 92,
        "reject_reason": "ConnLimit"
      }
    },
    {
      "name": "p2p_fault_bad_headers_ban",
      "description": "Bans peer after repeated invalid headers",
      "runnable": false,
      "input": {
        "kind": "p2p",
        "category": "p2p",
        "subcategory": "scoring",
        "preconditions": [
          {
            "max_bad_headers": 3
          },
          {
            "peer": "peer_bad"
          }
        ],
        "action": {
          "type": "p2p_receive",
          "peer": "peer_bad",
          "message": {
            "kind": "headers",
            "valid": false,
            "count": 3
          }
        }
      },
      "expected": {
        "status": "error",
        "error": "PeerBanned",
        "peer_banned": true
      }
    },
    {
      "name": "p2p_fault_spam_tx_score_drop",
      "description": "Reduces peer score on spam txs",
      "runnable": false,
      "input": {
        "kind": "p2p",
        "category": "p2p",
        "subcategory": "scoring",
        "preconditions": [
          {
            "spam_threshold": 500
          },
          {
            "peer": "peer_spam"
          },
          {
            "tx_rate": 1000
          }
        ],
        "action": {
          "type": "p2p_receive",
          "peer": "peer_spam",
          "message": {
            "kind": "tx",
            "rate": 1000
          }
        }
      },
      "expected": {
        "status": "ok",
        "peer_score_delta": -10
      }
    },
    {
      "name": "p2p_fault_invalid_signature_ban",
      "description": "Bans peer for invalid block signature",
      "runnable": false,
      "input": {
        "kind": "p2p",
        "category": "p2p",
        "subcategory": "scoring",
        "preconditions": [
          {
            "peer": "peer_bad_sig"
          }
        ],
        "action": {
          "type": "p2p_receive",
          "peer": "peer_bad_sig",
          "message": {
            "kind": "block",
            "signature_valid": false
          }
        }
      },
      "expected": {
        "status": "error",
        "error": "InvalidSignature",
        "peer_banned": true
      }
    },
    {
      "name": "p2p_fault_partition_recovery",
      "description": "Recovers after network partition",
      "runnable": false,
      "input": {
        "kind": "p2p",
        "category": "p2p",
        "subcategory": "fault_injection",
        "preconditions": [
          {
            "partition_duration_seconds": 120
          },
          {
            "local_head_before": 100
          },
          {
            "remote_head_after": 110
          }
        ],
        "action": {
          "type": "p2p_partition",
          "duration_seconds": 120,
          "peer": "peer1"
        }
      },
      "expected": {
        "status": "ok",
        "reconnected": true,
        "resynced_to_height": 110
      }
    }
  ]
}