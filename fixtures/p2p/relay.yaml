# TOS P2P Relay Conformance Specifications
# Covers tx and block relay behavior, deduplication, and validation gates.

---
spec:
  name: p2p_relay_tx_gossip_basic
  version: "1.0"
  category: p2p
  subcategory: relay
  description: "Relays valid transaction to peers"
  priority: P0

preconditions:
  - tx_id: "tx1"
  - tx_valid: true
  - peer_count: 3

action:
  type: p2p_relay
  item: {kind: tx, id: "tx1"}
  peers: ["peer1", "peer2", "peer3"]

expected:
  status: ok
  relayed_to: ["peer1", "peer2", "peer3"]

---
spec:
  name: p2p_relay_tx_invalid_not_relayed
  version: "1.0"
  category: p2p
  subcategory: relay
  description: "Does not relay invalid transaction"
  priority: P0

preconditions:
  - tx_id: "tx_bad"
  - tx_valid: false

action:
  type: p2p_relay
  item: {kind: tx, id: "tx_bad"}
  peers: ["peer1", "peer2"]

expected:
  status: ok
  relayed_to: []
  rejected_reason: "InvalidTransaction"

---
spec:
  name: p2p_relay_block_basic
  version: "1.0"
  category: p2p
  subcategory: relay
  description: "Relays valid block announcement"
  priority: P0

preconditions:
  - block_id: "blk1"
  - block_valid: true

action:
  type: p2p_relay
  item: {kind: block, id: "blk1"}
  peers: ["peer1", "peer2"]

expected:
  status: ok
  relayed_to: ["peer1", "peer2"]

---
spec:
  name: p2p_relay_block_invalid_not_relayed
  version: "1.0"
  category: p2p
  subcategory: relay
  description: "Does not relay invalid block"
  priority: P0

preconditions:
  - block_id: "blk_bad"
  - block_valid: false

action:
  type: p2p_relay
  item: {kind: block, id: "blk_bad"}
  peers: ["peer1"]

expected:
  status: ok
  relayed_to: []
  rejected_reason: "InvalidBlock"

---
spec:
  name: p2p_relay_dedup_tx
  version: "1.0"
  category: p2p
  subcategory: relay
  description: "Duplicate tx is not re-relayed"
  priority: P1

preconditions:
  - tx_id: "tx_dup"
  - seen_cache: ["tx_dup"]

action:
  type: p2p_relay
  item: {kind: tx, id: "tx_dup"}
  peers: ["peer1", "peer2"]

expected:
  status: ok
  relayed_to: []
  rejected_reason: "AlreadySeen"

---
spec:
  name: p2p_relay_dedup_block
  version: "1.0"
  category: p2p
  subcategory: relay
  description: "Duplicate block is not re-relayed"
  priority: P1

preconditions:
  - block_id: "blk_dup"
  - seen_cache: ["blk_dup"]

action:
  type: p2p_relay
  item: {kind: block, id: "blk_dup"}
  peers: ["peer1"]

expected:
  status: ok
  relayed_to: []
  rejected_reason: "AlreadySeen"

---
spec:
  name: p2p_relay_partial_peers
  version: "1.0"
  category: p2p
  subcategory: relay
  description: "Does not relay to peers without capability"
  priority: P2

preconditions:
  - peer_caps:
      peer1: ["blocks", "tx"]
      peer2: ["blocks"]
      peer3: []

action:
  type: p2p_relay
  item: {kind: tx, id: "tx2"}
  peers: ["peer1", "peer2", "peer3"]

expected:
  status: ok
  relayed_to: ["peer1"]

---
spec:
  name: p2p_relay_rate_limit
  version: "1.0"
  category: p2p
  subcategory: relay
  description: "Applies rate limit to noisy peer"
  priority: P1

preconditions:
  - rate_limit_per_sec: 100
  - peer: "peer_spam"
  - tx_rate: 500

action:
  type: p2p_relay
  item: {kind: tx, id: "tx_spam"}
  peers: ["peer_spam"]

expected:
  status: ok
  relayed_to: []
  rejected_reason: "RateLimited"
