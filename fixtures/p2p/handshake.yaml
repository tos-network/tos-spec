# TOS P2P Handshake Conformance Specifications
# Covers version negotiation, identity checks, and capability agreement.

---
spec:
  name: p2p_handshake_basic_success
  version: "1.0"
  category: p2p
  subcategory: handshake
  description: "Successful handshake with matching network and version"
  priority: P0

preconditions:
  - local_node_id: "nodeA"
  - remote_node_id: "nodeB"
  - local_chain_id: 1
  - remote_chain_id: 1
  - local_version: 3
  - remote_version: 3
  - local_caps: ["blocks", "tx"]
  - remote_caps: ["blocks", "tx"]

action:
  type: p2p_handshake
  local: {node_id: "nodeA", chain_id: 1, version: 3, caps: ["blocks", "tx"]}
  remote: {node_id: "nodeB", chain_id: 1, version: 3, caps: ["blocks", "tx"]}

expected:
  status: ok
  negotiated_version: 3
  negotiated_caps: ["blocks", "tx"]

---
spec:
  name: p2p_handshake_version_mismatch
  version: "1.0"
  category: p2p
  subcategory: handshake
  description: "Rejects peer with incompatible protocol version"
  priority: P0

preconditions:
  - local_version: 3
  - remote_version: 1

action:
  type: p2p_handshake
  local: {node_id: "nodeA", chain_id: 1, version: 3, caps: ["blocks"]}
  remote: {node_id: "nodeB", chain_id: 1, version: 1, caps: ["blocks"]}

expected:
  status: error
  error: "IncompatibleVersion"

---
spec:
  name: p2p_handshake_chain_id_mismatch
  version: "1.0"
  category: p2p
  subcategory: handshake
  description: "Rejects peer on different chain id"
  priority: P0

preconditions:
  - local_chain_id: 1
  - remote_chain_id: 2

action:
  type: p2p_handshake
  local: {node_id: "nodeA", chain_id: 1, version: 3, caps: ["blocks"]}
  remote: {node_id: "nodeB", chain_id: 2, version: 3, caps: ["blocks"]}

expected:
  status: error
  error: "ChainIdMismatch"

---
spec:
  name: p2p_handshake_genesis_mismatch
  version: "1.0"
  category: p2p
  subcategory: handshake
  description: "Rejects peer with different genesis hash"
  priority: P0

preconditions:
  - local_genesis: "0xaaa"
  - remote_genesis: "0xbbb"

action:
  type: p2p_handshake
  local: {node_id: "nodeA", chain_id: 1, version: 3, genesis: "0xaaa"}
  remote: {node_id: "nodeB", chain_id: 1, version: 3, genesis: "0xbbb"}

expected:
  status: error
  error: "GenesisMismatch"

---
spec:
  name: p2p_handshake_clock_skew
  version: "1.0"
  category: p2p
  subcategory: handshake
  description: "Rejects peer with excessive clock skew"
  priority: P1

preconditions:
  - max_clock_skew_seconds: 300
  - local_time: 1000000
  - remote_time: 1001000

action:
  type: p2p_handshake
  local: {node_id: "nodeA", chain_id: 1, version: 3, time: 1000000}
  remote: {node_id: "nodeB", chain_id: 1, version: 3, time: 1001000}

expected:
  status: error
  error: "ClockSkewTooLarge"

---
spec:
  name: p2p_handshake_duplicate_node_id
  version: "1.0"
  category: p2p
  subcategory: handshake
  description: "Rejects connection from self (duplicate node id)"
  priority: P0

preconditions:
  - local_node_id: "nodeA"
  - remote_node_id: "nodeA"

action:
  type: p2p_handshake
  local: {node_id: "nodeA", chain_id: 1, version: 3}
  remote: {node_id: "nodeA", chain_id: 1, version: 3}

expected:
  status: error
  error: "DuplicateNodeId"

---
spec:
  name: p2p_handshake_capability_subset
  version: "1.0"
  category: p2p
  subcategory: handshake
  description: "Negotiates shared capability subset"
  priority: P1

preconditions:
  - local_caps: ["blocks", "tx", "snap"]
  - remote_caps: ["blocks", "tx"]

action:
  type: p2p_handshake
  local: {node_id: "nodeA", chain_id: 1, version: 3, caps: ["blocks", "tx", "snap"]}
  remote: {node_id: "nodeB", chain_id: 1, version: 3, caps: ["blocks", "tx"]}

expected:
  status: ok
  negotiated_caps: ["blocks", "tx"]

---
spec:
  name: p2p_handshake_invalid_signature
  version: "1.0"
  category: p2p
  subcategory: handshake
  description: "Rejects peer with invalid handshake signature"
  priority: P0

preconditions:
  - local_public_key: "pkA"
  - remote_public_key: "pkB"
  - remote_signature_valid: false

action:
  type: p2p_handshake
  local: {node_id: "nodeA", chain_id: 1, version: 3, pubkey: "pkA"}
  remote: {node_id: "nodeB", chain_id: 1, version: 3, pubkey: "pkB", signature_valid: false}

expected:
  status: error
  error: "InvalidSignature"
