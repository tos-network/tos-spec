# TOS P2P Sync Conformance Specifications
# Covers header-first sync, fork choice, and invalid block handling.

---
spec:
  name: p2p_sync_headers_then_blocks
  version: "1.0"
  category: p2p
  subcategory: sync
  description: "Header-first sync followed by block bodies"
  priority: P0

preconditions:
  - local_head: 100
  - remote_head: 120

action:
  type: p2p_sync
  strategy: header_first
  remote_peer: "peer1"

expected:
  status: ok
  synced_to_height: 120

---
spec:
  name: p2p_sync_checkpoint_required
  version: "1.0"
  category: p2p
  subcategory: sync
  description: "Rejects sync without required checkpoint"
  priority: P1

preconditions:
  - required_checkpoint_height: 200
  - required_checkpoint_hash: "0xabc"
  - remote_checkpoint_hash: "0xdef"

action:
  type: p2p_sync
  strategy: header_first
  remote_peer: "peer1"

expected:
  status: error
  error: "CheckpointMismatch"

---
spec:
  name: p2p_sync_fork_choice_longer_chain
  version: "1.0"
  category: p2p
  subcategory: sync
  description: "Adopts longer valid chain"
  priority: P0

preconditions:
  - local_head: 100
  - remote_head: 105
  - remote_chain_valid: true

action:
  type: p2p_sync
  strategy: header_first
  remote_peer: "peer1"

expected:
  status: ok
  fork_choice: "remote"
  synced_to_height: 105

---
spec:
  name: p2p_sync_invalid_block_rejected
  version: "1.0"
  category: p2p
  subcategory: sync
  description: "Rejects invalid block during sync"
  priority: P0

preconditions:
  - remote_contains_invalid_block: true
  - invalid_block_height: 108

action:
  type: p2p_sync
  strategy: header_first
  remote_peer: "peer1"

expected:
  status: error
  error: "InvalidBlock"
  rejected_height: 108

---
spec:
  name: p2p_sync_chain_id_mismatch
  version: "1.0"
  category: p2p
  subcategory: sync
  description: "Rejects sync from different chain id"
  priority: P0

preconditions:
  - local_chain_id: 1
  - remote_chain_id: 2

action:
  type: p2p_sync
  strategy: header_first
  remote_peer: "peer1"

expected:
  status: error
  error: "ChainIdMismatch"

---
spec:
  name: p2p_sync_header_gap_exceeded
  version: "1.0"
  category: p2p
  subcategory: sync
  description: "Rejects peer with header gap exceeding limit"
  priority: P1

preconditions:
  - max_header_gap: 2048
  - remote_head: 5000
  - local_head: 100

action:
  type: p2p_sync
  strategy: header_first
  remote_peer: "peer1"

expected:
  status: error
  error: "HeaderGapTooLarge"

---
spec:
  name: p2p_sync_compact_blocks
  version: "1.0"
  category: p2p
  subcategory: sync
  description: "Accepts compact block relay when enabled"
  priority: P2

preconditions:
  - compact_blocks_enabled: true
  - remote_head: 150

action:
  type: p2p_sync
  strategy: compact_block
  remote_peer: "peer1"

expected:
  status: ok
  synced_to_height: 150

---
spec:
  name: p2p_sync_reorg_depth_limit
  version: "1.0"
  category: p2p
  subcategory: sync
  description: "Rejects reorg deeper than configured limit"
  priority: P1

preconditions:
  - max_reorg_depth: 128
  - remote_reorg_depth: 256

action:
  type: p2p_sync
  strategy: header_first
  remote_peer: "peer1"

expected:
  status: error
  error: "ReorgTooDeep"
